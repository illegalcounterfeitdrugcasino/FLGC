

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="FLGC">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/apple-touch-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAR5ZNjlqMDSu6nTLEYrTQZrFhSODply8s",
    authDomain: "flgcas.firebaseapp.com",
    projectId: "flgcas",
    storageBucket: "flgcas.firebasestorage.app",
    messagingSenderId: "756441459947",
    appId: "1:756441459947:web:82e6aaa245c5cea95ae2ae",
    measurementId: "G-WT7712F2DP"
};

let firebaseApp = null;

// Global Firestore functions
window.getFirestoreInstance = function () {
    try {
        if (!firebaseApp) {
            firebaseApp = initializeApp(firebaseConfig);
            getAnalytics(firebaseApp);
        }
        return getFirestore(firebaseApp);
    } catch (e) {
        console.error("Error initializing Firestore:", e);
        throw new Error("Failed to initialize Firestore: " + e.message);
    }
};

window.collection = function (...args) {
    try {
        if (!firebaseApp) {
            firebaseApp = initializeApp(firebaseConfig);
            getAnalytics(firebaseApp);
        }
        return collection(...args);
    } catch (e) {
        console.error("Error in collection:", e);
        throw new Error("Failed to create collection reference: " + e.message);
    }
};

window.addDoc = function (...args) {
    try {
        if (!firebaseApp) {
            firebaseApp = initializeApp(firebaseConfig);
            getAnalytics(firebaseApp);
        }
        return addDoc(...args);
    } catch (e) {
        console.error("Error in addDoc:", e);
        throw new Error("Failed to add document: " + e.message);
    }
};

window.doc = function (...args) {
    try {
        if (!firebaseApp) {
            firebaseApp = initializeApp(firebaseConfig);
            getAnalytics(firebaseApp);
        }
        return doc(...args);
    } catch (e) {
        console.error("Error in doc:", e);
        throw new Error("Failed to create document reference: " + e.message);
    }
};

window.getDoc = function (...args) {
    try {
        if (!firebaseApp) {
            firebaseApp = initializeApp(firebaseConfig);
            getAnalytics(firebaseApp);
        }
        return getDoc(...args);
    } catch (e) {
        console.error("Error in getDoc:", e);
        throw new Error("Failed to get document: " + e.message);
    }
};

window.setDoc = function (...args) {
    try {
        if (!firebaseApp) {
            firebaseApp = initializeApp(firebaseConfig);
            getAnalytics(firebaseApp);
        }
        return setDoc(...args);
    } catch (e) {
        console.error("Error in setDoc:", e);
        throw new Error("Failed to set document: " + e.message);
    }
};

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        });
    }

    const APP_VERSION = "9525";

function addStatusLog(message) {
    const log = document.getElementById("firebase-status-log");
    const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
    log.innerHTML += `<p>${message}</p>`;
    log.scrollTop = log.scrollHeight;
}

window.handleInitialTermsAgree = async function () {
    const VERBOSE_LOGGING = true;

    document.getElementById("initial-terms-screen").style.display = "none";
    document.getElementById("firebase-loading-screen").style.display = "flex";
    const continueBtn = document.getElementById("continue-anyway-btn");

    try {
        if (VERBOSE_LOGGING) addStatusLog("üîß Initializing Firebase app...");
        firebaseApp = initializeApp(firebaseConfig); // Store globally
        const analytics = getAnalytics(firebaseApp);
        const db = getFirestore(firebaseApp);

        if (VERBOSE_LOGGING) addStatusLog("üåê Checking internet access via Firebase...");
        const timerDisplay = document.createElement("span");
        timerDisplay.id = "network-timer";
        timerDisplay.style.marginLeft = "10px";
        document.getElementById("firebase-status-log").appendChild(timerDisplay);

        let timeLeft = 5;
        timerDisplay.textContent = `(Timeout: ${timeLeft}s)`;

        const timer = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = `(Timeout: ${timeLeft}s)`;
            if (timeLeft <= 0) {
                clearInterval(timer);
                if (VERBOSE_LOGGING) addStatusLog("‚ùå Network check timed out after 5 seconds.");
                showOfflineWarning();
                continueBtn.style.display = "block";
            }
        }, 1000);

        try {
            const timestamp = new Date().toISOString();
            await addDoc(collection(db, "network_checks"), { timestamp });
            const networkQuery = query(collection(db, "network_checks"), where("timestamp", "==", timestamp));
            const networkSnapshot = await getDocs(networkQuery);
            clearInterval(timer);
            timerDisplay.remove();
            if (networkSnapshot.empty) {
                if (VERBOSE_LOGGING) addStatusLog("‚ùå Failed to read network check timestamp.");
                showOfflineWarning();
                return;
            }
            if (VERBOSE_LOGGING) addStatusLog("‚úÖ Confirmed internet access.");
        } catch (e) {
            clearInterval(timer);
            timerDisplay.remove();
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Network check failed: ${e.message}`);
            showOfflineWarning();
            continueBtn.style.display = "block";
            return;
        }

        if (VERBOSE_LOGGING) addStatusLog("üåê Fetching IP address...");
        let ipdata;
        try {
            const ipResponse = await fetch("https://ipapi.co/json/");
            ipdata = await ipResponse.json();
            if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Fetched IP: ${ipdata.ip}`);
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå IP fetch error: ${e.message}`);
            continueBtn.style.display = "block";
            return;
        }

        if (VERBOSE_LOGGING) addStatusLog("üåê Fetching Subnet...");
        const subnet = ipdata.network;
        if (VERBOSE_LOGGING) addStatusLog(`Fetched Subnet: ${ipdata.network}`);
        
        if (VERBOSE_LOGGING) addStatusLog("üö´ Checking if IP is banned...");
        try {
            const ipDoc = await getDoc(doc(db, "banned_ips", ipdata.ip));
            if (ipDoc.exists()) {
                if (VERBOSE_LOGGING) addStatusLog("‚ùå Access Denied: IP is banned. Contact support at: bitflashelp@gmail.com");
                showPopup(`Access Denied: Your IP (${ipdata.ip}) has been banned.`);
                return;
            } else {
                if (VERBOSE_LOGGING) addStatusLog("‚úÖ IP is not banned.");
            }
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå IP ban check error: ${e.message}`);
            continueBtn.style.display = "block";
            return;
        }

        if (VERBOSE_LOGGING) addStatusLog("üîç Checking current app version...");
        let isVersionValid = false;
        try {
            const versionQuery = query(collection(db, "app_version"), where("version", "==", APP_VERSION));
            const versionSnapshot = await getDocs(versionQuery);
            isVersionValid = !versionSnapshot.empty;
            if (VERBOSE_LOGGING) addStatusLog(isVersionValid ? `‚úÖ App version (${APP_VERSION}) is valid.` : `‚ùå App version (${APP_VERSION}) is outdated.`);
            if (!isVersionValid) {
                continueBtn.style.display = "block";
                document.getElementById("firebase-status-log").innerHTML += `
                    <p>Your app version (${APP_VERSION}) is outdated. Please update to the latest version.</p>
                    <ul><button onclick="clearCacheAndReload()">Update Now</button></ul>
                `;
                return;
            }
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Version check failed: ${e.message}`);
            continueBtn.style.display = "block";
            return;
        }

        if (VERBOSE_LOGGING) addStatusLog("üìã Beginning device data collection...");

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting user agent...");
        const userAgent = navigator.userAgent;
        if (VERBOSE_LOGGING) addStatusLog(`Collected user agent: ${userAgent}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting additional navigator properties...");
        const navigatorProps = {
            appName: navigator.appName || "N/A",
            appVersion: navigator.appVersion || "N/A",
            product: navigator.product || "N/A",
            oscpu: navigator.oscpu || "N/A"
        };
        if (VERBOSE_LOGGING) addStatusLog(`Collected navigator: ${JSON.stringify(navigatorProps)}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting language...");
        const language = navigator.language;
        if (VERBOSE_LOGGING) addStatusLog(`Collected language: ${language}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting all preferred languages...");
        const languages = navigator.languages.join(", ");
        if (VERBOSE_LOGGING) addStatusLog(`Collected languages: ${languages}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting platform...");
        const platform = navigator.platform;
        if (VERBOSE_LOGGING) addStatusLog(`Collected platform: ${platform}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting vendor...");
        const vendor = navigator.vendor;
        if (VERBOSE_LOGGING) addStatusLog(`Collected vendor: ${vendor}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting screen resolution...");
        const screenRes = `${screen.width}x${screen.height}`;
        if (VERBOSE_LOGGING) addStatusLog(`Collected resolution: ${screenRes}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting color depth...");
        const colorDepth = screen.colorDepth || "N/A";
        if (VERBOSE_LOGGING) addStatusLog(`Collected color depth: ${colorDepth} bits`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting device pixel ratio...");
        const devicePixelRatio = window.devicePixelRatio || "N/A";
        if (VERBOSE_LOGGING) addStatusLog(`Collected device pixel ratio: ${devicePixelRatio}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting timezone...");
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (VERBOSE_LOGGING) addStatusLog(`Collected timezone: ${timezone}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting timezone offset...");
        const timezoneOffset = new Date().getTimezoneOffset();
        if (VERBOSE_LOGGING) addStatusLog(`Collected timezone offset: ${timezoneOffset} minutes`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting CPU cores...");
        const cpuCores = navigator.hardwareConcurrency || "N/A";
        if (VERBOSE_LOGGING) addStatusLog(`Collected CPU cores: ${cpuCores}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting device memory...");
        const deviceMemory = navigator.deviceMemory || "N/A";
        if (VERBOSE_LOGGING) addStatusLog(`Collected memory: ${deviceMemory} GB`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting referrer...");
        const referrer = document.referrer;
        if (VERBOSE_LOGGING) addStatusLog(`Collected referrer: ${referrer}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Collecting local time...");
        const localTime = new Date().toString();
        if (VERBOSE_LOGGING) addStatusLog(`Collected local time: ${localTime}`);

        const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (VERBOSE_LOGGING) addStatusLog(`‚û°Ô∏è Touch support: ${touchSupport}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Checking cookies enabled...");
        const cookiesEnabled = navigator.cookieEnabled || false;
        if (VERBOSE_LOGGING) addStatusLog(`Cookies enabled: ${cookiesEnabled}`);

        if (VERBOSE_LOGGING) addStatusLog("‚û°Ô∏è Checking Do Not Track status...");
        const doNotTrack = navigator.doNotTrack || window.doNotTrack || "N/A";
        if (VERBOSE_LOGGING) addStatusLog(`Do Not Track: ${doNotTrack}`);

        async function getBatteryData() {
            try {
                if (VERBOSE_LOGGING) addStatusLog("üîã Getting battery status...");
                const battery = await navigator.getBattery();
                const result = {
                    charging: battery.charging,
                    level: battery.level,
                };
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Battery: ${result.level * 100}% ${result.charging ? "(Charging)" : "(Not charging)"}`);
                return result;
            } catch (e) {
                if (VERBOSE_LOGGING) addStatusLog(`‚ùå Battery info error: ${e.message}`);
                return null;
            }
        }

        if (VERBOSE_LOGGING) addStatusLog("üåê Collecting additional geolocation data...");
        if (VERBOSE_LOGGING) addStatusLog(`Location: ${ipdata.city}, ${ipdata.region}, ${ipdata.country_name}`);

        const battery = await getBatteryData();

        if (VERBOSE_LOGGING) addStatusLog("üìä Measuring screen refresh rate...");
        const samples = [];
        let last = performance.now();

        for (let i = 0; i < 60; i++) {
            await new Promise(requestAnimationFrame);
            const now = performance.now();
            const diff = now - last;
            samples.push(diff);
            last = now;
            if (VERBOSE_LOGGING) addStatusLog(`Refresh frame ${i + 1}: ${diff.toFixed(2)} ms`);
        }

        const avg = samples.reduce((a, b) => a + b, 0) / samples.length;
        const refreshRate = +(1000 / avg).toFixed(2);
        const resolution = `${screen.width * window.devicePixelRatio} x ${screen.height * window.devicePixelRatio}`;
        if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Approx. refresh rate: ${refreshRate} Hz`);

        if (VERBOSE_LOGGING) addStatusLog("üéÆ Collecting WebGL renderer info...");
        let renderer = 'Unavailable';
        let webglExtensions = [];
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            const dbg = gl.getExtension('WEBGL_debug_renderer_info');
            if (dbg) {
                renderer = gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL);
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ WebGL Renderer: ${renderer}`);
            } else {
                if (VERBOSE_LOGGING) addStatusLog("‚ö†Ô∏è WebGL debug extension not available.");
            }
            const ext = gl.getSupportedExtensions();
            webglExtensions = ext ? ext.join(", ") : "None";
            if (VERBOSE_LOGGING) addStatusLog(`‚úÖ WebGL Extensions: ${webglExtensions}`);
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå WebGL detection failed: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üîå Collecting browser plugins...");
        let plugins = [];
        try {
            if (navigator.plugins && navigator.plugins.length > 0) {
                for (let i = 0; i < navigator.plugins.length; i++) {
                    plugins.push(navigator.plugins[i].name);
                }
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Plugins: ${plugins.join(", ") || "None"}`);
            } else {
                if (VERBOSE_LOGGING) addStatusLog("‚ö†Ô∏è No plugins detected or API unavailable.");
            }
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Plugin detection error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üåê Checking WebRTC status and local IPs...");
        let webRTCEnabled = false;
        let privateIPs = [];
        try {
            webRTCEnabled = !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);
            if (VERBOSE_LOGGING) addStatusLog(`WebRTC enabled: ${webRTCEnabled}`);
            if (webRTCEnabled) {
                if (VERBOSE_LOGGING) addStatusLog("üåê Collecting private IP via WebRTC...");
                const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                pc.createDataChannel("test");
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        const ipMatch = event.candidate.candidate.match(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/);
                        if (ipMatch && (ipMatch[1].startsWith("192.168") || ipMatch[1].startsWith("10.") || ipMatch[1].startsWith("172."))) {
                            privateIPs.push(ipMatch[1]);
                            if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Found private IP: ${ipMatch[1]}`);
                        }
                    }
                };
                await pc.createOffer().then(offer => pc.setLocalDescription(offer));
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for ICE candidates
                pc.close();
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Private IPs collected: ${privateIPs.join(", ") || "None"}`);
            }
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå WebRTC detection error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üåê Collecting HTTP request headers...");
        let httpHeaders = {};
        try {
            const headerResponse = await fetch("https://httpbin.org/headers");
            const headerData = await headerResponse.json();
            httpHeaders = headerData.headers;
            if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Collected headers: ${JSON.stringify(httpHeaders)}`);
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Header fetch error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üì° Checking device orientation/motion support...");
        let orientationSupport = false;
        let motionSupport = false;
        try {
            orientationSupport = !!window.DeviceOrientationEvent;
            motionSupport = !!window.DeviceMotionEvent;
            if (VERBOSE_LOGGING) addStatusLog(`Orientation support: ${orientationSupport}, Motion support: ${motionSupport}`);
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Device sensor error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üéπ Checking MIDI support...");
        let midiSupport = false;
        try {
            midiSupport = !!navigator.requestMIDIAccess;
            if (VERBOSE_LOGGING) addStatusLog(`MIDI support: ${midiSupport}`);
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå MIDI detection error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üìç Attempting geolocation...");
        let geolocation = null;
        try {
            geolocation = await new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy
                    }),
                    err => resolve(null)
                );
            });
            if (geolocation) {
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Geolocation: Lat ${geolocation.latitude}, Lon ${geolocation.longitude}, Accuracy ${geolocation.accuracy}m`);
            } else {
                if (VERBOSE_LOGGING) addStatusLog("‚ö†Ô∏è Geolocation not available or permission denied.");
            }
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Geolocation error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üìã Checking clipboard API...");
        let clipboardSupport = false;
        try {
            clipboardSupport = !!navigator.clipboard;
            if (VERBOSE_LOGGING) addStatusLog(`Clipboard API support: ${clipboardSupport}`);
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Clipboard detection error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üñ•Ô∏è Checking WebGPU support...");
        let webgpuSupport = false;
        try {
            webgpuSupport = !!navigator.gpu;
            if (VERBOSE_LOGGING) addStatusLog(`WebGPU support: ${webgpuSupport}`);
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå WebGPU detection error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üì± Collecting CSS media queries...");
        let mediaQueries = {};
        try {
            const queries = [
                { name: "prefers-reduced-motion", query: "(prefers-reduced-motion: reduce)" },
                { name: "prefers-color-scheme", query: "(prefers-color-scheme: dark)" },
                { name: "pointer", query: "(pointer: fine)" }
            ];
            queries.forEach(q => {
                mediaQueries[q.name] = window.matchMedia(q.query).matches;
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Media Query ${q.name}: ${mediaQueries[q.name]}`);
            });
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå CSS media query error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üìà Collecting performance memory...");
        let performanceMemory = {};
        try {
            if (performance.memory) {
                performanceMemory = {
                    totalJSHeapSize: performance.memory.totalJSHeapSize || 0,
                    usedJSHeapSize: performance.memory.usedJSHeapSize || 0,
                    jsHeapSizeLimit: performance.memory.jsHeapSizeLimit || 0
                };
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Memory: ${performanceMemory.usedJSHeapSize} bytes used, ${performanceMemory.jsHeapSizeLimit} bytes limit`);
            } else {
                if (VERBOSE_LOGGING) addStatusLog("‚ö†Ô∏è Performance memory API not available.");
            }
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Performance memory error: ${e.message}`);
        }

        if (VERBOSE_LOGGING) addStatusLog("üîß Checking service worker status...");
        let serviceWorkerStatus = "Not registered";
        try {
            if (navigator.serviceWorker) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                serviceWorkerStatus = registrations.length > 0 ? `Registered (${registrations.length})` : "Not registered";
                if (VERBOSE_LOGGING) addStatusLog(`‚úÖ Service Worker: ${serviceWorkerStatus}`);
            } else {
                if (VERBOSE_LOGGING) addStatusLog("‚ö†Ô∏è Service Worker API not available.");
            }
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Service Worker error: ${e.message}`);
        }

        const logEntry = {
            timestamp: new Date().toISOString(),
            userAgent,
            navigatorProps,
            language,
            languages,
            platform,
            vendor,
            screenRes,
            colorDepth,
            devicePixelRatio,
            timezone,
            timezoneOffset,
            cpuCores,
            deviceMemory,
            renderer,
            referrer,
            localTime,
            resolution,
            touchSupport,
            cookiesEnabled,
            doNotTrack,
            refreshRate,
            battery,
            ip: ipdata.ip,
            subnet: ipdata.network,
            city: ipdata.city,
            region: ipdata.region,
            postal: ipdata.postal,
            country: ipdata.country_name,
            latitude: ipdata.latitude,
            longitude: ipdata.longitude,
            org: ipdata.org,
            asn: ipdata.asn,
            version: APP_VERSION,
            plugins: plugins.join(", ") || "None",
            webRTCEnabled,
            privateIPs: privateIPs.join(", ") || "None",
            httpHeaders,
            webglExtensions,
            orientationSupport,
            midiSupport,
            geolocation,
            clipboardSupport,
            webgpuSupport,
            mediaQueries,
            serviceWorkerStatus
        };

        lastLogEntry = logEntry; // Store logEntry globally

        if (VERBOSE_LOGGING) addStatusLog("üì§ Uploading to Firestore...");
        try {
            await addDoc(collection(db, "visitors"), logEntry);
            if (VERBOSE_LOGGING) addStatusLog("‚úÖ Data Uploaded.");
            proceedAfterFirebaseSuccess();
        } catch (e) {
            if (VERBOSE_LOGGING) addStatusLog(`‚ùå Data upload failed: ${e.message}`);
            continueBtn.style.display = "block";
        }

    } catch (err) {
        if (VERBOSE_LOGGING) addStatusLog(`‚ùå Fatal error: ${err.message}`);
        continueBtn.style.display = "block";
    }
};

function checkOnlineStatus() {
  return navigator.onLine;
}

function showOfflineWarning() {
  document.getElementById("firebase-loading-screen").style.display = "none";
  showPopup(
    "You are currently offline. The app will run in offline mode, but features like updates and Firebase data logging will be unavailable. Please connect to the internet to access all features.",
    `<button onclick="proceedOffline()">Proceed Offline</button>`
  );
}

window.proceedOffline = function() {
  addStatusLog("Proceeding in offline mode.");
  document.getElementById("firebase-loading-screen").style.display = "none";
  initScreen('setup-screen');
};

window.clearCacheAndReload = function() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      // Unregister all service workers
      for (let registration of registrations) {
        registration.unregister();
      }
      // Clear all caches
      caches.keys().then(cacheNames => {
        return Promise.all(
          cacheNames.map(cacheName => caches.delete(cacheName))
        );
      }).then(() => {
        // Clear site data (cookies, localStorage, etc.)
        if (window.indexedDB) {
          indexedDB.databases().then(dbs => {
            dbs.forEach(db => indexedDB.deleteDatabase(db.name));
          });
        }
        localStorage.clear();
        sessionStorage.clear();
        // Reload the page
        window.location.reload(true);
      });
    });
  } else {
    // Fallback for browsers without service worker support
    localStorage.clear();
    sessionStorage.clear();
    window.location.reload(true);
  }
};

window.proceedAfterFirebaseError = function() {
    addStatusLog("User opted to continue despite error.");
    document.getElementById("firebase-loading-screen").style.display = "none";
    initScreen('account-screen');
};

window.proceedAfterFirebaseSuccess = function() {
    addStatusLog("All modules logged successfully.");
    document.getElementById("firebase-loading-screen").style.display = "none";
    initScreen('account-screen');
};

function startFLGCLoader() {
    const loader = document.getElementById("flgc-loader");
    loader.style.display = "flex";
    const statusLog = document.getElementById("flgc-status-log");

    const fakeTasks = [
        "Loading game assets...",
        "Initializing rendering engine...",
        "Fetching user preferences...",
        "Syncing with server time...",
        "Preloading audio effects...",
        "Configuring UI components...",
        "Establishing secure connection...",
        "Optimizing performance settings...",
        "Loading prize catalog...",
        "Finalizing setup..."
    ];

    let taskIndex = 0;
    function showNextTask() {
        if (taskIndex < fakeTasks.length) {
            const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
            statusLog.innerHTML += `<p>[${timestamp}] ${fakeTasks[taskIndex]}</p>`;
            statusLog.scrollTop = statusLog.scrollHeight;
            taskIndex++;
            setTimeout(showNextTask, 300);
        }
    }

    setTimeout(() => {
        document.getElementById("flgc-logo").style.opacity = 1;
        document.getElementById("flgc-subtext").style.opacity = 1;
    }, 1000);

    setTimeout(() => {
        document.getElementById("flgc-loader-bottom").style.opacity = 1;
        showNextTask();
    }, 1500);

    setTimeout(() => {
        loader.remove();
        initScreen("setup-screen");
        requestPreciseLocationAndFill();
    }, 4500);
}
// Disable right-click context menu
document.addEventListener('contextmenu', event => event.preventDefault());

// Prevent double-tap zoom on touch devices
let lastTouchEnd = 0;
document.addEventListener('touchend', event => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);

// Also prevent pinch zoom
document.addEventListener('touchmove', event => {
    if (event.scale !== 1) {
        event.preventDefault();
    }
}, { passive: false });

document.addEventListener('dragstart', event => event.preventDefault());

document.addEventListener('keydown', event => {
    if (
        (event.ctrlKey && ['s', 'u'].includes(event.key.toLowerCase())) || 
        event.key === 'F12'
    ) {
        event.preventDefault();
    }
});

  </script>
    <title>Free Luxury Giveaway Casino</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a0d2e, #4a0072);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.0s ease, opacity 0.0s ease;
        }

        #restore-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 40000;
    transition: opacity 0.5s ease;
}
#raw-device-content {
  max-height: 50vh;
  overflow-y: auto;
  font-family: monospace;
  background: #111;
  color: #fff;
  padding: 1em;
  border-radius: 6px;
}
#restore-content {
    text-align: center;
    background: #1a0d2e;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 0 20px #ff00ff;
    color: #fff;
}
.restore-btn {
    padding: 10px 20px;
    margin: 10px;
    background: #ff00ff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s;
}
.restore-btn:hover {
    background: #00ffff;
}

.high-level-admin-btn {
    width: 100%;
    padding: 15px;
    background: #ff3333;
    border: none;
    border-radius: 10px;
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    margin-bottom: 20px;
    text-transform: uppercase;
    box-shadow: 0 0 15px rgba(255, 51, 51, 0.7);
    transition: background 0.3s, box-shadow 0.3s;
}
.high-level-admin-btn:hover {
    background: #cc0000;
    box-shadow: 0 0 20px rgba(255, 51, 51, 1);
}
.readonly-field {
    background: #fff;
    color: #000;
    padding: 12px;
    margin: 10px 0;
    border-radius: 10px;
    border: none;
    font-size: 18px;
    width: 200px;
    cursor: not-allowed;
}

        #setup-screen, #admin-screen, #game-menu, #vip-menu, #policy-screen, #tos-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            transition: opacity 0.5s ease;
        }
        #terms-content, #setup-content, #admin-content, #game-menu-content, #vip-content, #policy-content, #tos-content {
            background: #fff;
            color: #000;
            padding: 40px;
            border-radius: 25px;
            max-width: 900px;
            box-shadow: 0 0 40px #ff00ff;
            text-align: left;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.5s ease, opacity 0.5s ease;
        }
        #setup-screen.active #setup-content, #admin-screen.active #admin-content, #game-menu.active #game-menu-content, #vip-menu.active #vip-content, #policy-screen.active #policy-content, #tos-screen.active #tos-content {
            transform: scale(1);
            opacity: 1;
        }
        #admin-content { max-width: 1200px; overflow-y: auto; max-height: 90%; }
        #terms-content h1, #setup-content h1, #admin-content h1, #game-menu-content h1, #vip-content h1, #policy-content h1, #tos-content h1 { font-size: 30px; margin-bottom: 25px; }
        #terms-content p, #setup-content p, #admin-content p, #game-menu-content p, #vip-content p, #policy-content p, #tos-content p { font-size: 16px; line-height: 1.7; margin-bottom: 30px; }
        .terms-btn, .setup-btn, .admin-btn, .game-btn, .vip-btn, .policy-btn, .tos-btn {
            padding: 15px 30px;
            font-size: 20px;
            background: #ff00ff;
            border: none;
            border-radius: 10px;
            color: #fff;
            margin: 0 20px;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
        }
        .terms-btn:hover, .setup-btn:hover, .admin-btn:hover, .game-btn:hover, .vip-btn:hover, .policy-btn:hover, .tos-btn:hover {
            background: #00ffff;
            box-shadow: 0 0 25px #00ffff;
            transform: scale(1.05);
        }
        .terms-btn:disabled, .setup-btn:disabled { background: #555; cursor: not-allowed; }
        #main-container {
            width: 100%;
            max-width: 1500px;
            margin: 25px auto;
            display: none;
            flex-direction: column;
            gap: 30px;
            padding: 35px;
            background: rgba(0, 0, 0, 0.92);
            border-radius: 30px;
            box-shadow: 0 0 50px #ff00ff, 0 0 100px #00ffff;
            position: relative;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #main-container.active { opacity: 1; }
        #header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            border-radius: 25px;
            box-shadow: 0 0 30px #ff00ff;
            position: relative;
        }
        #header h1 { font-size: 48px; text-transform: uppercase; letter-spacing: 4px; }
        #header p { font-size: 20px; margin-top: 15px; }
        #bucks-display, #vip-display { font-size: 18px; margin: 10px 0; }
        #vip-btn, #settings-btn, #auto-spin-settings-btn {
            position: absolute;
            top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background: #00ffff;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        #vip-btn { left: 20px; }
        #settings-btn { right: 20px; }
        #auto-spin-settings-btn { top: 60px; left: 20px; }
        #vip-btn:hover, #settings-btn:hover, #auto-spin-settings-btn:hover { background: #ff00ff; transform: scale(1.05); }
        #timers-section {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 0 20px #00ffff;
        }
        .timer-box {
            font-size: 22px;
            padding: 15px 25px;
            background: #ff00ff;
            border-radius: 12px;
            box-shadow: 0 0 15px #ff00ff;
            min-width: 180px;
            text-align: center;
            transition: transform 0.2s;
        }
        .timer-box:hover { transform: scale(1.03); }
        #game-section {
            padding: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            box-shadow: 0 0 30px #00ffff;
            text-align: center;
        }
        #jackpot-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.98);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 25000;
    transition: opacity 0.5s ease;
}
#jackpot-popup.active {
    display: flex;
}
.ad-action-btn {
    padding: 10px 20px;
    font-size: 16px;
    background: #00ffff;
    border: none;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
}
.ad-action-btn:hover {
    background: #ff00ff;
    transform: scale(1.05);
    box-shadow: 0 0 20px #ff00ff;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
#jackpot-popup-content {
    background: rgba(0, 0, 0, 0.95);
    padding: 40px;
    border-radius: 25px;
    box-shadow: 0 0 50px #ff00ff;
    text-align: center;
    color: #fff;
    max-width: 600px;
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.5s ease, opacity 0.5s ease;
}

#jackpot-popup.active #jackpot-popup-content {
    transform: scale(1);
    opacity: 1;
}

#new-jackpot-wheel-container {
    width: 350px;
    height: 350px;
    background: conic-gradient(
        #ff00ff 0% 10%, #00ffff 10% 20%, #ff00ff 20% 30%, #00ffff 30% 40%,
        #ff00ff 40% 50%, #00ffff 50% 60%, #ff00ff 60% 70%, #00ffff 70% 80%,
        #ff00ff 80% 90%, #00ffff 90% 100%
    );
    border-radius: 50%;
    margin: 30px auto;
    position: relative;
    transition: transform 4s ease-out;
}

#new-jackpot-spin-btn {
    padding: 20px 50px;
    font-size: 28px;
    background: #ff00ff;
    border: none;
    border-radius: 12px;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 0 20px #ff00ff;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
}

#new-jackpot-spin-btn:hover {
    background: #00ffff;
    transform: scale(1.1);
    box-shadow: 0 0 35px #00ffff;
}

#new-jackpot-spin-btn:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
}

#jackpot-result {
    color: #00ffff;
    font-weight: bold;
}
#account-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.98);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20000;
    transition: opacity 0.5s ease;
}
#account-content {
    background: #fff;
    color: #000;
    padding: 40px;
    border-radius: 25px;
    max-width: 600px;
    box-shadow: 0 0 40px #ff00ff;
    text-align: center;
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.5s ease, opacity 0.5s ease;
}
#account-screen.active #account-content {
    transform: scale(1);
    opacity: 1;
}
.account-btn {
    padding: 15px 30px;
    font-size: 20px;
    background: #ff00ff;
    border: none;
    border-radius: 10px;
    color: #fff;
    margin: 10px;
    cursor: pointer;
    transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
}
.account-btn:hover {
    background: #00ffff;
    box-shadow: 0 0 25px #00ffff;
    transform: scale(1.05);
}
        #jackpot-counter {
            font-size: 28px;
            color: #00ffff;
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            box-shadow: 0 0 20px #00ffff;
        }
        #slots-game, #wheel-game, #crash-game, #jackpot-game { display: none; }
        #slots-machine {
            display: flex;
            gap: 25px;
            margin: 30px 0;
            justify-content: center;
            align-items: center;
            perspective: 1200px;
        }
        .reel {
            width: 160px;
            height: 160px;
            background: #fff;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #000;
            box-shadow: 0 0 20px #ff00ff;
            transition: transform 0.1s;
            transform-style: preserve-3d;
            font-weight: bold;
        }
        .reel.spinning { animation: spinReel 0.12s infinite linear; }
        @keyframes spinReel {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(360deg); }
        }
        #pre-terms-loading-screen {
    position: fixed;
    inset: 0;
    background: black;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    font-family: 'Arial';
}
#pre-terms-logo {
    opacity: 0;
    font-size: 6rem;
    transition: opacity 0.5s;
}
#pre-terms-subtext {
    opacity: 0;
    font-size: 1rem;
    color: #aaa;
    margin-top: 0.3em;
    transition: opacity 0.5s;
}
#pre-terms-loader-bottom {
    opacity: 0;
    margin-top: 2em;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: opacity 0.5s;
}
#flgc-loader {
    position: fixed;
    inset: 0;
    background: black;
    color: white;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    font-family: 'Arial';
}
#flgc-status-log {
    font-size: 16px;
    text-align: left;
    max-height: 200px;
    overflow-y: auto;
    background: #111;
    padding: 10px;
    border-radius: 8px;
    margin: 20px 0;
    width: 80%;
    max-width: 500px;
}
#flgc-status-log p {
    margin: 5px 0;
}
        #plinko-game {
    padding: 30px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 25px;
    box-shadow: 0 0 30px #00ffff;
    text-align: center;
}

#plinko-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

#plinko-canvas {
    background: #111;
    border-radius: 15px;
    box-shadow: 0 0 20px #ff00ff;
}

#plinko-multiplier-row {
    display: flex;
    justify-content: space-between;
    width: 600px;
    margin-top: 10px;
}

.plinko-multiplier-label {
    font-size: 12px;
    color: #00ffff;
    background: rgba(0, 0, 0, 0.7);
    padding: 5px;
    border-radius: 5px;
    flex: 1;
    text-align: center;
}

#plinko-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    align-items: center;
}

#plinko-bet-amount {
    padding: 10px;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    background: #333;
    color: #fff;
    width: 100px;
}

.plinko-btn, .game-switch-btn {
    padding: 15px 30px;
    font-size: 20px;
    background: #ff00ff;
    border: none;
    border-radius: 10px;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
}

.plinko-btn:hover, .game-switch-btn:hover {
    background: #00ffff;
    transform: scale(1.05);
    box-shadow: 0 0 20px #00ffff;
}

.plinko-btn:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
}

#plinko-multiplier-display {
    font-size: 24px;
    color: #00ffff;
    font-weight: bold;
}

@media (max-width: 768px) {
    #plinko-canvas, #plinko-multiplier-row {
        width: 300px;
        height: 400px;
    }
    .plinko-multiplier-label {
        font-size: 8px;
        padding: 3px;
    }
    #plinko-bet-amount {
        width: 80px;
        font-size: 14px;
    }
    .plinko-btn, .game-switch-btn {
        padding: 10px 20px;
        font-size: 16px;
    }
    #plinko-controls {
        gap: 10px;
    }
}
        #roulette-game h2 {
    font-size: 28px;
    margin-bottom: 20px;
    color: #00ffff;
}
#roulette-bet-red, #roulette-bet-black {
    padding: 10px 20px;
    margin: 5px;
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.3s;
}
#roulette-bet-red:hover {
    background: #ff5555;
    box-shadow: 0 0 20px #ff0000;
    transform: scale(1.05);
}
#roulette-bet-black:hover {
    background: #333333;
    box-shadow: 0 0 20px #000000;
    transform: scale(1.05);
}
#roulette-spin-btn:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
}
@media (max-width: 768px) {
    #roulette-canvas {
        width: 300px;
        height: 300px;
    }
    #roulette-bet-amount {
        width: 80px;
        font-size: 14px;
    }
    #roulette-bet-red, #roulette-bet-black {
        padding: 8px 15px;
        font-size: 16px;
    }
    #roulette-spin-btn {
        font-size: 24px;
        padding: 15px 40px;
    }
}
        #wheel-container {
    width: 300px;
    height: 300px;
    background: conic-gradient(
        #ff00ff 0% 10%, #00ffff 10% 20%, #ff5555 20% 30%, #55ff55 30% 40%,
        #5555ff 40% 50%, #ffff55 50% 60%, #ff55ff 60% 70%, #55ffff 70% 80%,
        #ffaa55 80% 90%, #55aaff 90% 100%
    );
    border-radius: 50%;
    margin: 30px auto;
    position: relative;
    transition: transform 3s ease-out;
}
        #crash-container {
    background: #111;
    border-radius: 15px;
    box-shadow: 0 0 20px #ff00ff;
    overflow: hidden;
}
#crash-graph {
    background: #222;
    border-right: 1px solid #444;
}
#multiplier-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
}
#multiplier-fill {
    height: 0%;
}
#multiplier-text {
    font-family: monospace;
    font-weight: bold;
}
.crash-btn {
    padding: 15px 30px;
    font-size: 20px;
    background: #ff00ff;
    border: none;
    border-radius: 10px;
    color: #fff;
    cursor: pointer;
    margin: 0 10px;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
}
.crash-btn:hover {
    background: #00ffff;
    transform: scale(1.05);
    box-shadow: 0 0 20px #00ffff;
}
.crash-btn:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
}
.blackjack-btn {
    padding: 15px 30px;
    font-size: 20px;
    background: #ff00ff;
    border: none;
    border-radius: 10px;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
}
.blackjack-btn:hover {
    background: #00ffff;
    transform: scale(1.05);
    box-shadow: 0 0 20px #00ffff;
}
.blackjack-btn:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
}
.card {
    width: 80px;
    height: 120px;
    background: #fff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #000;
    box-shadow: 0 0 10px #ff00ff;
    transition: transform 0.5s ease;
}
.card.hidden {
    background: #333;
    color: #fff;
}
@media (max-width: 768px) {
    #blackjack-table {
        flex-direction: column;
        gap: 15px;
    }
    #blackjack-bet-amount {
        width: 80px;
        font-size: 14px;
    }
    .blackjack-btn {
        padding: 10px 20px;
        font-size: 16px;
    }
    .card {
        width: 60px;
        height: 90px;
        font-size: 18px;
    }
}
#firebase-loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 1);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 45000;
    transition: opacity 0.5s ease;
}
#firebase-loading-content {
    text-align: center;
    font-size: 24px;
    color: #fff;
    padding: 40px;
    background: #1a0d2e;
    border-radius: 15px;
    box-shadow: 0 0 20px #000000;
    max-width: 600px;
}
#firebase-status-log {
    font-size: 16px;
    text-align: left;
    max-height: 200px;
    overflow-y: auto;
    background: #111;
    padding: 10px;
    border-radius: 8px;
    margin: 20px 0;
}
#firebase-status-log p {
    margin: 5px 0;
}
#continue-anyway-btn:hover {
    background: #ff00ff;
}

        #spin-btn, #wheel-spin-btn, #crash-bet-btn, #jackpot-spin-btn {
            padding: 25px 60px;
            font-size: 32px;
            background: #ff00ff;
            border: none;
            border-radius: 15px;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 0 25px #ff00ff;
            transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        #spin-btn:hover, #wheel-spin-btn:hover, #crash-bet-btn:hover, #jackpot-spin-btn:hover {
            background: #00ffff;
            transform: scale(1.1);
            box-shadow: 0 0 40px #00ffff;
        }
        #spin-btn:disabled, #wheel-spin-btn:disabled, #crash-bet-btn:disabled, #jackpot-spin-btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        #auto-spin-btn, #notification-btn, #buy-spins-btn {
            padding: 10px 20px;
            font-size: 16px;
            background: #00ffff;
            border: none;
            border-radius: 10px;
            color: #fff;
            margin: 0px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        #network-info-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.95);
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 0 30px #ff00ff;
  z-index: 26000;
  max-width: 400px;
  width: 90%;
  color: #fff;
  display: none;
  text-align: left;
}
#network-info-popup h2 {
  font-size: 20px;
  margin-bottom: 15px;
}
#network-info-popup p {
  font-size: 14px;
  margin: 5px 0;
  word-break: break-word;
}
#network-info-back-btn {
  padding: 10px 20px;
  font-size: 14px;
  background: #ff00ff;
  border: none;
  border-radius: 5px;
  color: #fff;
  cursor: pointer;
  margin-top: 15px;
  display: block;
  margin-left: auto;
}
#network-info-back-btn:hover {
  background: #00ffff;
}
        #display-info-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.95);
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 0 30px #ff00ff;
  z-index: 26000;
  max-width: 400px;
  width: 90%;
  color: #fff;
  display: none;
  text-align: left;
}
#display-info-popup h2 {
  font-size: 20px;
  margin-bottom: 15px;
}
#display-info-popup p {
  font-size: 14px;
  margin: 5px 0;
  word-break: break-word;
}
#display-info-back-btn {
  padding: 10px 20px;
  font-size: 14px;
  background: #ff00ff;
  border: none;
  border-radius: 5px;
  color: #fff;
  cursor: pointer;
  margin-top: 15px;
  display: block;
  margin-left: auto;
}
#display-info-back-btn:hover {
  background: #00ffff;
}
        #notification-btn {
  background: #ff3333 !important;
  color: white !important;
}

#notification-btn:hover {
  background: #ff0000 !important;
}
        #auto-spin-btn:hover, #notification-btn:hover, #buy-spins-btn:hover { background: #ff00ff; transform: scale(1.05); }
        #auto-spin-btn:disabled { background: #555; cursor: not-allowed; }
        #game-switch-btn {
            padding: 12px 25px;
            font-size: 18px;
            background: #00ffff;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        #game-switch-btn:hover { background: #ff00ff; transform: scale(1.05); }
        #progress-section {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 0 20px #ff00ff;
        }
        .progress-container { margin: 20px 0; }
        .progress-label { font-size: 18px; margin-bottom: 8px; }
        .progress-bar {
            width: 100%;
            height: 35px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 15px #ff00ff;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            width: 0%;
            transition: width 0.5s ease;
        }
        #history-section {
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            max-height: 350px;
            overflow-y: auto;
            box-shadow: 0 0 25px #ff00ff;
        }
        #history-section h2 { font-size: 24px; margin-bottom: 20px; }
        .history-item {
            font-size: 18px;
            margin: 10px 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item button {
            padding: 10px 20px;
            background: #ff00ff;
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s;
        }
        .history-item button:hover { background: #00ffff; }
        #store-section {
            position: fixed;
            top: 20px;
            right: 0;
            width: 320px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 25px 0 0 25px;
            box-shadow: 0 0 40px #ff00ff;
            transition: transform 0.5s ease;
        }
        #store-section.hidden { transform: translateX(100%); }
        #store-toggle {
            position: absolute;
            top: 50%;
            left: -40px;
            width: 40px;
            height: 40px;
            background: #ff00ff;
            border-radius: 10px 0 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 15px #ff00ff;
            transition: background 0.3s;
        }
        #store-toggle:hover { background: #00ffff; }
        #store-section h2 { font-size: 22px; margin-bottom: 20px; }
        .store-item {
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            font-size: 18px;
        }
        .store-item:hover { transform: scale(1.05); box-shadow: 0 0 20px #00ffff; }
        #chat-section {
            position: fixed;
            bottom: 20px;
            right: 0;
            width: 450px;
            height: 350px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 25px 0 0 25px;
            padding: 25px;
            box-shadow: 0 0 40px #00ffff;
            transition: transform 0.5s ease;
        }
        #chat-section.hidden { transform: translateX(100%); }
        #chat-toggle {
            position: absolute;
            top: 50%;
            left: -40px;
            width: 40px;
            height: 40px;
            background: #ff00ff;
            border-radius: 10px 0 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 15px #ff00ff;
            transition: background 0.3s;
        }
        #chat-toggle:hover { background: #00ffff; }
        #chat-section h2 { font-size: 22px; margin-bottom: 20px; }
        #chat-messages {
            height: 70%;
            overflow-y: auto;
            font-size: 18px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        #chat-input {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: #333;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 18px;
        }
        #notification-section {
            position: fixed;
            bottom: 115px;
            left: 20px;
            width: 300px;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 0 40px #ff00ff;
            display: none;
            overflow-y: auto;
            transition: opacity 0.3s ease;
        }
        #notification-section h2 { font-size: 20px; margin-bottom: 15px; }
        .notification-item { padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; }
        #notification-btn { position: fixed; bottom: 20px; left: 20px; }
        #notification-count { position: absolute; top: -5px; right: -5px; background: #ff00ff; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; font-size: 12px; }
        #rewards-section {
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            box-shadow: 0 0 25px #ff00ff;
        }
        #rewards-section h2 { font-size: 24px; margin-bottom: 20px; }
        .reward-item {
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border-radius: 12px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .reward-item button {
            padding: 10px 20px;
            background: #ff00ff;
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s;
        }
        .reward-item button:hover { background: #00ffff; }
        #popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.98);
            padding: 50px;
            border-radius: 25px;
            box-shadow: 0 0 50px #ff00ff;
            z-index: 30000;
            max-width: 700px;
            text-align: center;
            display: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #popup.active { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        #popup p { font-size: 22px; margin-bottom: 30px; }
        #popup button {
            padding: 15px 30px;
            margin: 10px;
            background: #ff00ff;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s, transform 0.2s;
        }
        #popup button:hover { background: #00ffff; transform: scale(1.05); }
        #popup input, #popup select, #popup textarea {
            padding: 12px;
            margin: 20px 0;
            width: 85%;
            border-radius: 10px;
            border: none;
            font-size: 18px;
        }
        #ad-player {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            height: 450px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 25px;
            box-shadow: 0 0 50px #ff00ff;
            z-index: 20000;
            display: none;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 30px;
        }
        #ad-content {
            font-size: 28px;
            color: #fff;
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            width: 100%;
        }
        #ad-timer { font-size: 24px; color: #00ffff; margin: 20px 0; }
        #ad-progress {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
        }
        #ad-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            width: 0%;
            transition: width 300ms linear;
        }
        #ad-skip-btn {
            padding: 15px 30px;
            font-size: 18px;
            background: #ff00ff;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        #ad-skip-btn:hover { background: #00ffff; transform: scale(1.05); }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 40000;
            transition: opacity 0.5s ease;
        }
        #loading-content {
            text-align: center;
            font-size: 24px;
            color: #fff;
        }
        #loading-ball {
            width: 50px;
            height: 50px;
            background: #ff00ff;
            border-radius: 50%;
            animation: spinBall 1s infinite linear;
            margin: 20px auto;
            box-shadow: 0 0 20px #ff00ff;
        }
        @keyframes spinBall {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #admin-content label { display: block; margin: 15px 0 5px; font-size: 18px; }
        #admin-content input, #admin-content textarea, #admin-content select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
        }
        #admin-content textarea { height: 100px; }
        .editable-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 10px; }
        .editable-item { display: flex; justify-content: space-between; margin: 5px 0; gap: 10px; }
        .editable-item input { width: 60%; }
        .editable-item button { width: 20%; }
        .search-results { font-size: 14px; margin-top: 5px; color: #888; }
        #setup-content label { display: block; margin: 15px 0 5px; font-size: 18px; }
        #setup-content input, #setup-content select { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 10px; border: none; font-size: 16px; }
        @media (max-width: 768px) {
            #main-container { padding: 20px; max-width: 100%; margin: 15px auto; }
            #slots-machine { flex-direction: column; gap: 20px; }
            .reel { width: 140px; height: 140px; font-size: 28px; }
            #spin-btn { font-size: 24px; padding: 20px 50px; }
            #store-section { width: 90%; right: 0; top: auto; bottom: 400px; }
            #chat-section { width: 90%; right: 0; bottom: 20px; }
            .timer-box { font-size: 18px; min-width: 140px; }
            #popup, #ad-player, #admin-screen { max-width: 90%; padding: 30px; }
        }
        #firestore-info-btn {
    position: absolute;
    top: 10px;
    left: -5px;
    padding: 8px 15px;
    font-size: 14px;
    background: #ff00ff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    z-index: 21000;
    transition: background 0.3s;
}
#firestore-info-btn:hover {
    background: #00ffff;
}
#info-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 30px #ff00ff;
    z-index: 25000;
    max-width: 400px;
    width: 90%;
    color: #fff;
    display: none;
    text-align: left;
}
#info-popup.active {
    display: block;
}
#info-popup h2 {
    font-size: 20px;
    margin-bottom: 15px;
}
#info-popup p {
    font-size: 14px;
    margin: 5px 0;
    word-break: break-word;
}
#info-back-btn {
    padding: 10px 20px;
    font-size: 14px;
    background: #ff00ff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    margin-top: 15px;
    display: block;
    margin-left: auto;
}
#info-back-btn:hover {
    background: #00ffff;
}
#more-device-btn {
    padding: 10px 20px;
    font-size: 14px;
    background: #00ffff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    margin-top: 10px;
    display: block;
    margin-left: auto;
}
#more-device-btn:hover {
    background: #ff00ff;
}
#display-info-btn {
    padding: 10px 20px;
    font-size: 14px;
    background: #00ffff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    margin-top: 10px;
    display: block;
    margin-left: auto;
}
#display-info-btn:hover {
    background: #ff00ff;
}
#network-info-btn {
    padding: 10px 20px;
    font-size: 14px;
    background: #00ffff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    margin-top: 10px;
    display: block;
    margin-left: auto;
}
#network-info-btn:hover {
    background: #ff00ff;
}
#raw-device-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 30px #ff00ff;
    z-index: 26000; /* Above info-popup */
    max-width: 400px;
    width: 90%;
    color: #fff;
    display: none;
    text-align: left;
}
#raw-device-popup.active {
    display: block;
}
#raw-device-popup h2 {
    font-size: 20px;
    margin-bottom: 15px;
}
#raw-device-popup p {
    font-size: 14px;
    margin: 5px 0;
    word-break: break-word;
}
#raw-device-back-btn {
    padding: 10px 20px;
    font-size: 14px;
    background: #ff00ff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    margin-top: 15px;
    display: block;
    margin-left: auto;
}
#raw-device-back-btn:hover {
    background: #00ffff;
}
#players-online-counter {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 6px 12px;
    font-size: 14px;
    color: #00ffff;
    background: rgba(0, 0, 0, 0.85);
    border-radius: 999px; /* pill shape */
    box-shadow: 0 0 10px #00ffff;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    font-family: 'Arial', sans-serif;
}
#players-online-counter:hover {
    background: rgba(0, 255, 0, 0.15);
    box-shadow: 0 0 20px #00ff00;
    transform: scale(1.05);
}

.update-btn {
  padding: 10px 20px;
  margin: 10px;
  background: #ff00ff;
  border: none;
  border-radius: 5px;
  color: #fff;
  cursor: pointer;
  transition: background 0.3s;
}
.update-btn:hover {
  background: #00ffff;
}

    </style>
</head>
<body>
      <!-- FLGC Cinematic Loader -->
<div id="flgc-loader" style="position: fixed; inset: 0; background: black; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 999999; font-family: 'Arial';">
    <div id="flgc-logo" style="opacity: 0; font-size: 8rem; transition: opacity 0.5s;">FLGC</div>
    <div id="flgc-subtext" style="opacity: 0; font-size: 1rem; color: #aaa; margin-top: 0.3em; transition: opacity 0.5s;">Preparing Your Experience...</div>
    <div id="flgc-status-log" style="font-size: 16px; text-align: left; max-height: 200px; overflow-y: auto; background: #111; padding: 10px; border-radius: 8px; margin: 20px 0; width: 80%; max-width: 500px;"></div>
    <div id="flgc-loader-bottom" style="opacity: 0; margin-top: 2em; display: flex; flex-direction: column; align-items: center; transition: opacity 0.5s;">
        <div class="spinner" style="width: 30px; height: 30px; border: 5px solid #444; border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div style="margin-top: 1em;"></div>
    </div>
</div>
<div id="pre-terms-loading-screen" style="position: fixed; inset: 0; background: black; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999999; font-family: 'Arial';">
    <div id="pre-terms-logo" style="opacity: 0; font-size: 6rem; transition: opacity 0.5s;">FLGC</div>
    <div id="pre-terms-subtext" style="opacity: 0; font-size: 1rem; color: #aaa; margin-top: 0.3em; transition: opacity 0.5s;"></div>
    <div id="pre-terms-loader-bottom" style="opacity: 0; margin-top: 2em; display: flex; flex-direction: column; align-items: center; transition: opacity 0.5s;">
        <div class="spinner" style="width: 30px; height: 30px; border: 5px solid #444; border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div style="margin-top: 1em;"></div>
    </div>
</div>
<div id="initial-terms-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 1.00); display: flex; justify-content: center; align-items: center; z-index: 50000;">
    <div id="initial-terms-content" style="background: #1a0d2e; padding: 40px; border-radius: 15px; box-shadow: 0 0 20px #000000; color: #fff; text-align: center; max-width: 600px;">
        <h1>Welcome to FLGC</h1>
        <p>
            By proceeding, you agree to our 
            <a href="https://flgc.netlify.app/termsofservice" target="_blank" style="color: #00ffff; text-decoration: underline;">Terms of Service</a> 
            and 
            <a href="https://flgc.netlify.app/privacypolicy" target="_blank" style="color: #00ffff; text-decoration: underline;">Privacy Policy</a>.
            Please review them before continuing.
        </p>
        <button class="terms-btn" id="initial-terms-agree" onclick="handleInitialTermsAgree()" style="padding: 15px 30px; font-size: 20px; background: #ffffff; border: none; border-radius: 10px; color: #000; cursor: pointer; transition: background 0.3s;">Agree & Continue</button>
    </div>
</div>
<div id="firebase-loading-screen">
  <div id="firebase-loading-content">
    <h2></h2>
    <div id="firebase-status-log"></div>
    <button id="continue-anyway-btn" style="display: none;" onclick="proceedAfterFirebaseError()">Continue Anyway</button>
  </div>
</div>
<div id="install-banner" style="display: none; position: fixed; bottom: -100; left: 0; width: 100%; background: #1a0d2e; color: #fff; padding: 20px; box-shadow: 0 -5px 20px #ff00ff; z-index: 99999; text-align: center;">
  <span id="install-text" style="font-size: 18px;">Want FLGC as a real app?</span>
  <button id="install-button" style="margin-left: 20px; padding: 10px 20px; background: #ff00ff; border: none; border-radius: 8px; color: #fff; cursor: pointer;">Install</button>
  <button onclick="hideInstallBanner()" style="margin-left: 10px; background: transparent; border: none; color: #aaa; font-size: 20px;">√ó</button>
</div>
    <div id="restore-screen" style="display: none;">
      <div id="restore-content">
          <h1>Restore Your Game?</h1>
          <p>We found saved data, bro. Want to pick up where you left off?</p>
          <button class="restore-btn" onclick="restoreGameData()">Yes, Load It</button>
          <button class="restore-btn" onclick="startFresh()">No, Start Fresh</button>
      </div>
  </div>
    <div id="terms-screen">
        <div id="terms-content">
            <label><input type="checkbox" id="terms-agree"></label>
        </div>
    </div>
    <div id="setup-screen" style="display: none;">
    <div id="setup-content">
        <h1>Setup Your Experience</h1>
        <div id="setup-step-1">
            <button id="firestore-info-btn" class="terms-btn" onclick="showFirestoreData()">View your Data</button>
            <p>Enter your name and location for chat.</p>
            <label>Name:</label>
            <input id="setup-name" type="text" placeholder="Your Name" value="">
            <label>Location:</label>
            <input id="setup-location" type="text" placeholder="Your Location/City" value="">
            <button class="setup-btn" onclick="nextSetupStep()">Next</button>
            <button class="setup-btn" onclick="skipSetup()">Skip</button>
            <button class="setup-btn" style="position: absolute; top: 20px; right: 20px;" onclick="loadSavedDataPrompt()">Login</button>
        </div>
    </div>
</div>
        <div id="raw-device-popup">
    <h2>More Device Data</h2>
    <div id="raw-device-content"></div>
    <button id="raw-device-back-btn">Back</button>
</div>
<div id="info-popup">
    <h2>Device Info</h2>
    <div id="info-content"></div>
    <button id="display-info-btn">Display Info</button>
    <button id="network-info-btn">Network Info</button>
    <button id="more-device-btn">More Device Info</button>
    <button id="info-back-btn">Back</button>
</div>
<div id="raw-device-popup">
    <h2>Raw Device Data</h2>
    <div id="raw-device-content"></div>
    <button id="raw-device-back-btn">Back</button>
</div>
<div id="display-info-popup">
  <h2>Display Information</h2>
  <div id="display-info-content" style="white-space: pre-wrap; font-family: monospace;"></div>
  <button id="display-info-back-btn">Back</button>
</div>
<div id="network-info-popup">
  <h2>Network Information</h2>
  <div id="network-info-content" style="white-space: pre-wrap; font-family: monospace;"></div>
  <button id="network-info-back-btn">Back</button>
</div>
        <div id="setup-notifications" style="display: none;">
          <h1></h1>
            <p></p>
            <button class="setup-btn" onclick="enableNotifications(true)">Allow Notifications</button>
            <button class="setup-btn" onclick="enableNotifications(false)">Block Notifications</button>
        </div>
        <div id="setup-notification-types" style="display: none;">
            <p>Select notification types:</p>
            <label><input type="checkbox" id="notify-ads" checked> Ads</label><br>
            <label><input type="checkbox" id="notify-wins" checked> Wins</label><br>
            <button class="setup-btn" onclick="sendTestNotification()">Next</button>
        </div>
        <div id="setup-verify-code" style="display: none;">
            <p>Enter the 6-digit code from the test notification:</p>
            <input id="verify-code" type="text" maxlength="6" placeholder="XXXXXX">
            <button class="setup-btn" onclick="verifyTestCode()">Verify</button>
        </div>
    </div>
</div>
<div id="info-popup">
    <h2>Device & Network Info</h2>
    <div id="info-content"></div>
    <button id="more-device-btn">More Device Data</button>
    <button id="info-back-btn">Back</button>
</div>
<div id="raw-device-popup">
    <h2>Raw Device Data</h2>
    <div id="raw-device-content"></div>
    <button id="raw-device-back-btn">Back</button>
</div>
    <div id="admin-screen" style="display: none;">
        <div id="admin-content">
          <button class="high-level-admin-btn" onclick="window.open('https://externaladmin.netlify.app', '_blank')">DATABASE CONTROL</button>
            <div>
            <label>Database Encryption Key (256-bit):</label>
                <input type="text" class="readonly-field" value="9f3b1e4a7c8d2f05e1a9c3d6b7f08234a5e6d9c8f1b2a4d7e3c6f8a0b1d2e4f7" readonly>
            </div>
            <h1>Admin Mode</h1>
            <p>View and Customize FLGC settings below.</p>
            <label>Recovery Key (256-bit):</label>
            <input id="admin-recovery-key" type="text" readonly>
            <label>Admin Password:</label>
            <input id="admin-password-setting" type="text" value="5820320">
            <label>Enable Admin Chat CLI ("/admincli init" in chat):</label>
            <input type="checkbox" id="admin-chat-cli" />
            <label>Win Chance (0-1):</label>
            <input id="admin-win-chance" type="number" step="0.1" min="0" max="1" value="0.25">
            <label>Bitflash Bucks:</label>
            <input id="admin-bucks" type="number" value="0">
            <label>Spins Left:</label>
            <input id="admin-spins" type="number" value="3">
            <label>Default Prize Bucks Gain:</label>
            <input id="admin-prize-bucks" type="number" value="15">
            <label>Default Prize Spins Gain:</label>
            <input id="admin-prize-spins" type="number" value="3">
            <h2>Blackjack Settings</h2>
            <label>Number of Decks:</label>
            <input id="admin-blackjack-decks" type="number" min="1" max="8" value="4" />
            <label>Minimum Bet:</label>
            <input id="admin-blackjack-min-bet" type="number" min="1" value="10" />
            <label>Maximum Bet:</label>
            <input id="admin-blackjack-max-bet" type="number" min="1" value="1000" />
            <label>Payout Multiplier (Win):</label>
            <input id="admin-blackjack-payout-win" type="number" step="0.1" min="0" value="1.5" />
            <label>Payout Multiplier (Blackjack):</label>
            <input id="admin-blackjack-payout-blackjack" type="number" step="0.1" min="0" value="2.0" />
            <label>Plinko Multipliers (comma-separated, left to right):</label>
            <input id="admin-plinko-multipliers" type="text" value="25, 10, 4, 2, 1.5, 1, 0.7, 0.5, 0.2, 0.5, 0.7, 1, 1.5, 2, 4, 10, 25">
            <label for="plinko-gravity">Set Plinko Gravity (default 0.50) - EXPERIMENTAL:</label>
            <input id="plinko-gravity" type="number" step="0.01" value="0.50" style="width: 100px; margin-bottom: 20px;">
            <button class="admin-btn" onclick="updatePlinkoGravity()">Update Gravity</button>
            <label>Prizes Search:</label>
            <input id="admin-prizes-search" type="text" placeholder="e.g., cartel">
            <div id="admin-prizes-list" class="editable-list"></div>
            <div id="admin-prizes-add">
                <input id="admin-prize-name" type="text" placeholder="Prize Name">
                <button class="admin-btn" onclick="addPrize()">Add</button>
            </div>
            <label>Chat Mode:</label>
            <hr style="margin-top: 40px; border: 1px solid #888;">
            <select id="admin-chat-mode">
                <option value="template">Template-Based Chat</option>
                <option value="fake">Fake Messages Chat</option>
            </select>
            <label>Chat Fake Messages (one per line):</label>
            <textarea id="admin-chat-messages"></textarea>
            <label>Chat Message Template:</label>
            <input id="admin-chat-template" type="text" placeholder="e.g., {name} from {location} won {prize}!">
            <label>First Names (one per line):</label>
            <textarea id="admin-first-names" placeholder="e.g., Emma\nLiam\nOlivia"></textarea>
            <label>Cities (one per line):</label>
            <textarea id="admin-cities" placeholder="e.g., New York\nTokyo\nLondon"></textarea>
            <label>Chat Banned Words (comma-separated):</label>
            <input id="admin-banned-words" type="text">
            <label for="admin-players-online-text">Players Online Text ($ for number)</label>
<input id="admin-players-online-text" type="text" placeholder="Online: $">
<label for="admin-players-online-count">Initial Players Online Count</label>
<input id="admin-players-online-count" type="number" placeholder="79271">
<label for="admin-players-online-speed">Update Interval (ms)</label>
<input id="admin-players-online-speed" type="number" placeholder="2000">
<label for="admin-players-online-increment">Max Increment/Decrement</label>
<input id="admin-players-online-increment" type="number" placeholder="100">
<label for="admin-players-online-direction">Direction</label>
<select id="admin-players-online-direction">
    <option value="both">Up or Down</option>
    <option value="up">Up Only</option>
    <option value="down">Down Only</option>
</select>
            <label>Ad Duration (seconds):</label>
            <input id="admin-ad-duration" type="number" min="1" max="30" value="5">
            <label>Ads Search:</label>
            <input id="admin-ads-search" type="text" placeholder="e.g., bets">
            <div id="admin-ads-list" class="editable-list"></div>
            <div id="admin-ads-add">
                <input id="admin-ad-content" type="text" placeholder="Ad Content">
                <input id="admin-ad-button-text" type="text" placeholder="Button Text">
                <input id="admin-ad-button-link" type="text" placeholder="Button Link (https://...)">
                <button class="admin-btn" onclick="addAd()">Add</button>
            </div>
            <label>Store Items Search:</label>
            <input id="admin-store-search" type="text" placeholder="e.g., cocaine">
            <div id="admin-store-list" class="editable-list"></div>
            <div id="admin-store-add">
                <input id="admin-store-name" type="text" placeholder="Name">
                <input id="admin-store-price" type="number" placeholder="Price">
                <input id="admin-store-effect" type="text" placeholder="Effect">
                <input id="admin-store-desc" type="text" placeholder="Description">
                <button class="admin-btn" onclick="addStoreItem()">Add</button>
            </div>
            <label>Rewards Search:</label>
            <input id="admin-rewards-search" type="text" placeholder="e.g., spin">
            <div id="admin-rewards-list" class="editable-list"></div>
            <div id="admin-rewards-add">
                <input id="admin-reward-name" type="text" placeholder="Name">
                <input id="admin-reward-cost" type="number" placeholder="Cost">
                <input id="admin-reward-effect" type="text" placeholder="Effect">
                <input id="admin-reward-type" type="text" placeholder="Type">
                <button class="admin-btn" onclick="addReward()">Add</button>
            </div>
            <hr style="margin-top: 30px; border: 1px solid #888;">
            <h2>Jackpot Counter Settings</h2>
            <label>Jackpot Starting Text:</label>
            <input id="admin-jackpot-text" type="text" value="Jackpots Given: $24,728,219,613">
            <label>Jackpot Increase Speed (ms):</label>
            <input id="admin-jackpot-speed" type="number" value="100">
            <label>Jackpot Increase Amount:</label>
            <input id="admin-jackpot-increment" type="number" value="150000">
<h2>Script Injector</h2>
<p>Paste custom JS code</p>
<textarea id="custom-js-code" placeholder="JavaScript here..." style="width:100%;height:150px;background:#111;color:#0f0;padding:10px;border-radius:10px;border:none;font-family:monospace;"></textarea>
<p id="js-output" style="font-size:14px;margin-top:10px;color:#000000;"></p>
<button class="admin-btn" onclick="runCustomJS()">Run Script</button>
            <button class="admin-btn" onclick="refreshAllLists()">Refresh/Fix Lists</button>
            <button class="admin-btn" onclick="saveAdminSettings()">Save</button>
            <button class="admin-btn" onclick="exitAdminMode()">Exit</button>
        </div>
    </div>
    <div id="recovery-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); z-index: 40000; display: flex; justify-content: center; align-items: center;">
    <div id="restore-content" style="background: #1a0d2e; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px #ff00ff; color: #fff; text-align: center; max-width: 600px; width: 90%;">
        <h1>FLGC is Locked</h1>
        <p>Enter the 256-bit recovery key to unlock:</p>
        <input id="recovery-key-input" type="text" placeholder="Enter 256-bit recovery key" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; font-size: 16px;">
        <button class="restore-btn" onclick="validateRecoveryKey()">Submit</button>
        <p style="font-size: 14px; margin-top: 10px;"></p>
    </div>
</div>
<div id="service-code-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); z-index: 45000; display: flex; justify-content: center; align-items: center;">
    <div id="service-code-content" style="background: #1a0d2e; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px #ff00ff; color: #fff; text-align: center; max-width: 600px; width: 90%;">
        <h1>Device Not Supported</h1>
        <p>(If this screen is visible on load) Your device lacks the modern capabilities required to run Free Luxury Giveaway Casino (FLGC). Please use a newer device with a modern browser.</p>
        <input id="service-code-input" type="text" placeholder="Enter 16-digit Service Code" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; font-size: 16px;">
        <button class="restore-btn" onclick="validateServiceCode()">Submit</button>
    </div>
</div>
<div id="crash-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; z-index: 50000; padding: 20px; font-family: monospace; font-size: 14px;">
    <div style="position: absolute; top: 10px; left: 10px;">
        <p>FLGC System Crash Report</p>
        <p>Version: 9525</p>
        <p>Error: CRITICAL_AUTHENTICATION_FAILURE</p>
        <p>Timestamp: ${new Date().toISOString()}</p>
        <p>Module: AdminSecuritySubsystem</p>
        <p>Details: Invalid 256-bit recovery key entered. Recovery attempt count: ${recoveryAttempts}.</p>
        <p>Admin Mode Accessed: ${hasAccessedAdminMode ? "Yes" : "No"}</p>
        <p>System State: { adminPasswordAttempts: ${adminPasswordAttempts}, recoveryAttempts: ${recoveryAttempts}, userName: "${userName || "N/A"}", userLocation: "${userLocation || "N/A"}", bitflashBucks: ${bitflashBucks}, spinsLeft: ${spinsLeft}, vipLevel: ${vipLevel} }</p>
        <p>Stack Trace: validateRecoveryKey() -> onSubmit() -> SecurityManager.validateCredentials()</p>
        <p>Environment: Browser: ${navigator.userAgent}, Platform: ${navigator.platform}, Screen: ${screen.width}x${screen.height}, Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}</p>
        <p>Instructions: The system has locked due to an invalid recovery key. Contact Bitflash Enterprises support at https://forms.gle/XAsvp2gBDeMyPy8i8 or via the Support Chat at https://cdn.botpress.cloud/webchat/v2.3/shareable.html?configUrl=https://files.bpcontent.cloud/2025/04/23/16/20250423161704-XGJNS7MN.json. Provide this crash report for assistance. Do not attempt to restart or modify the system, as this may result in data loss.</p>
        <p>Terminal: Enter commands below to interact with the system.</p>
        <div id="terminal-output" style="background: #111; padding: 10px; border: 1px solid #333; max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
        <input id="terminal-input" type="text" placeholder="Enter command" style="width: 100%; padding: 8px; margin-top: 10px; background: #111; color: #fff; border: 1px solid #333; font-family: monospace;">
        <button onclick="processTerminalCommand()" style="padding: 8px; margin-top: 10px; background: #ff00ff; color: #fff; border: none; border-radius: 5px;">Execute</button>
    </div>
</div>
    <div id="game-menu" style="display: none;">
    <div id="game-menu-content">
        <h1>Choose a Game</h1>
        <div id="game-list-slots" style="margin: 20px;">
            <h3>Slots</h3>
            <button class="game-btn" onclick="switchGame('slots')">Classic Slots</button>
        </div>
        <div id="game-list-wheel" style="margin: 20px;">
            <h3>Wheels</h3>
            <button class="game-btn" onclick="switchGame('wheel')">Prize Wheel</button>
        </div>
        <div id="game-list-crash" style="margin: 20px;">
            <h3>Crash</h3>
            <button class="game-btn" onclick="switchGame('crash')">Crypto Crash</button>
        </div>
        <div id="game-list-roulette" style="margin: 20px;">
            <h3>Roulette</h3>
            <button class="game-btn" onclick="switchGame('roulette')">Bitflash Roulette</button>
        </div>
        <div id="game-list-blackjack" style="margin: 20px;">
            <h3>Blackjack</h3>
            <button class="game-btn" onclick="switchGame('blackjack')">Classic Blackjack</button>
        </div>
        <div id="game-list-plinko" style="margin: 20px;">
            <h3>Plinko</h3>
            <button class="game-btn" onclick="switchGame('plinko')">Plinko Drop</button>
        </div>
    </div>
</div>
    </div>
    <div id="account-screen" style="display: none;">
    <div id="account-content">
        <h1>Account Management</h1>
        <p>Welcome to Free Luxury Giveaway Casino! Please create a new account or log in with your existing account key.</p>
        <div id="account-options">
            <button class="account-btn" onclick="showCreateAccount()">Create Account</button>
            <button class="account-btn" onclick="showLogin()">Log In</button>
        </div>
        <div id="login-form" style="display: none; margin-top: 20px;">
            <input id="account-key-input" type="text" placeholder="Enter your Account Key" style="padding: 10px; font-size: 16px; width: 100%; border-radius: 5px; margin-bottom: 10px;">
            <button class="account-btn" onclick="handleLogin()">Submit</button>
            <button class="account-btn" onclick="showAccountOptions()">Back</button>
        </div>
    </div>
</div>
    <div id="vip-menu" style="display: none;">
        <div id="vip-content">
            <h1>VIP Membership</h1>
            <p>Upgrade your experience:</p>
            <div>Level 1: Skip Ads, Auto-Spin (1 000 Bucks)</div>
            <div>Level 2: +25% Win Chance, +20% Bucks & Spins/Win, Disable Ad Popups, Faster Jackpot (10 000 Bucks)</div>
            <div>VIP Max: +50% Win Chance, +30% Bucks & Spins/Win, Max Jackpot (100 000 Bucks)</div>
            <select id="vip-level">
                <option value="1">VIP 1</option>
                <option value="2">VIP 2</option>
                <option value="4">VIP Max</option>
            </select>
            <button class="vip-btn" onclick="confirmVIPUpgrade()">Buy with Bucks</button>
            <button class="vip-btn" onclick="toggleAdPopups()">Toggle Ad Popups</button>
            <button class="vip-btn" onclick="closeVIPMenu()">Close</button>
      </div>
    </div>
    <div id="main-container">
        <div id="header">
            <h1>Free Luxury Giveaway Casino</h1>
            <p>Spin for Unreal Luxury - Powered by Bitflash</p>
            <div id="bucks-display">Bitflash Bucks: 0</div>
            <div id="vip-display">VIP Level: 0</div>
            <button id="vip-btn" onclick="openVIPMenu()">VIP</button>
            <button id="settings-btn" onclick="openSettings()">More</button>
        </div>
        <div id="game-section">
            <div id="jackpot-counter">Jackpots Given: $24,728,219,613</div>
            <div id="slots-game">
                <div id="slots-machine">
                    <div class="reel" id="reel1">?</div>
                    <div class="reel" id="reel2">?</div>
                    <div class="reel" id="reel3">?</div>
                </div>
                <button id="spin-btn" onclick="spinSlots()">SPIN</button>
                <button id="buy-spins-btn" onclick="buySpinsPrompt()">Buy Spins</button>
                <button id="auto-spin-btn" onclick="toggleAutoSpin()">Auto-Spin</button>
                <button id="notification-btn" onclick="showResetWarning()">RESET</button>
                <button id="game-switch-btn" onclick="openGameMenu()">Switch Game</button>
            </div>
            <div id="wheel-game">
                <div id="wheel-container"><div id="wheel-pointer"></div></div>
                <button id="wheel-spin-btn" onclick="spinWheel()">SPIN</button>
                <button id="buy-spins-btn" onclick="buySpinsPrompt()">Buy Spins</button>
                <button id="auto-spin-btn" onclick="toggleAutoSpin()">Auto-Spin</button>
                <button id="notification-btn" onclick="showResetWarning()">RESET</button>
                <button id="game-switch-btn" onclick="openGameMenu()">Switch Game</button>
            </div>
            <div id="roulette-game" style="display: none;">
    <h2>Roulette</h2>
    <canvas id="roulette-canvas" width="400" height="400" style="margin: 20px auto; display: block;"></canvas>
    <div style="text-align: center; margin: 20px 0;">
        <label>Bet Amount (Bucks):</label>
        <input id="roulette-bet-amount" type="number" min="1" value="10" style="padding: 10px; border-radius: 10px; border: none; font-size: 16px; width: 100px;">
        <div style="margin: 10px 0;">
            <button id="roulette-bet-red" class="game-btn" style="background: #ff0000;">Bet Red</button>
            <button id="roulette-bet-black" class="game-btn" style="background: #000000;">Bet Black</button>
        </div>
        <button id="roulette-spin-btn" class="spin-btn">Spin Roulette</button>
        <button id="notification-btn" onclick="showResetWarning()">RESET</button>
        <button id="roulette-game-switch-btn" class="game-switch-btn">Switch Game</button>
    </div>
</div>
<div id="plinko-game" style="display: none;">
    <h2>Plinko</h2>
    <div id="plinko-container">
        <canvas id="plinko-canvas" width="600" height="600"></canvas>
        <div id="plinko-multiplier-row" style="display: flex; justify-content: space-between; width: 600px; margin-top: -52px;"></div>
        <div id="plinko-controls">
            <input id="plinko-bet-amount" type="number" min="1" value="10" placeholder="Bet Amount">
            <button id="plinko-drop-btn" class="plinko-btn" onclick="dropPlinkoBalls()">Drop Ball</button>
            <button id="notification-btn" onclick="showResetWarning()">RESET</button>
            <button id="plinko-switch-game-btn" class="game-switch-btn" onclick="openGameMenu()">Switch Game</button>
        </div>
        <div id="plinko-multiplier-display">Total Multiplier: 0x</div>
    </div>
</div>
<div id="blackjack-game" style="display: none;">
    <div id="blackjack-container" style="padding: 30px; background: rgba(255, 255, 255, 0.15); border-radius: 25px; box-shadow: 0 0 30px #00ffff; text-align: center;">
        <h2 style="font-size: 28px; color: #00ffff; margin-bottom: 20px;">Blackjack</h2>
        <div id="blackjack-table" style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px;">
            <div id="dealer-hand" style="flex: 1; background: #111; border-radius: 15px; padding: 15px; box-shadow: 0 0 20px #ff00ff;">
                <h3 style="color: #fff;">Dealer</h3>
                <div id="dealer-cards" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                <p id="dealer-score" style="color: #00ffff; font-size: 18px;"></p>
            </div>
            <div id="player-hand" style="flex: 1; background: #111; border-radius: 15px; padding: 15px; box-shadow: 0 0 20px #ff00ff;">
                <h3 style="color: #fff;">Player</h3>
                <div id="player-cards" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                <p id="player-score" style="color: #00ffff; font-size: 18px;"></p>
            </div>
        </div>
        <div id="blackjack-controls" style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
            <input id="blackjack-bet-amount" type="number" min="1" placeholder="Bet Amount" style="padding: 10px; font-size: 16px; border: none; border-radius: 10px; background: #333; color: #fff; width: 100px;" />
            <div id="action-buttons" style="display: flex; gap: 10px;">
                <button id="blackjack-bet-btn" class="blackjack-btn" onclick="startBlackjack()">Place Bet</button>
                <button id="blackjack-hit-btn" class="blackjack-btn" onclick="blackjackHit()" disabled>Hit</button>
                <button id="blackjack-stand-btn" class="blackjack-btn" onclick="blackjackStand()" disabled>Stand</button>
                <button id="blackjack-double-btn" class="blackjack-btn" onclick="blackjackDoubleDown()" disabled>Double Down</button>
                <button id="game-switch-btn" onclick="openGameMenu()">Switch Game</button>
            </div>
            <p id="blackjack-result" style="font-size: 20px; color: #00ffff;"></p>
        </div>
    </div>
</div>
            <div id="crash-game" style="display: none;">
    <h2>Crypto Crash</h2>
    <div id="crash-container" style="position: relative; width: 600px; height: 400px; margin: 20px auto; display: flex;">
        <canvas id="crash-graph" width="500" height="400"></canvas>
        <div id="multiplier-bar" style="width: 80px; margin-left: 10px; background: #333; border-radius: 10px; position: relative; overflow: hidden;">
            <div id="multiplier-fill" style="position: absolute; bottom: 0; width: 100%; background: linear-gradient(0deg, #ff00ff, #00ffff); transition: height 0.1s linear;"></div>
            <div id="multiplier-text" style="position: absolute; top: 10px; width: 100%; text-align: center; font-size: 24px; color: #00ffff;">1.00x</div>
        </div>
    </div>
    <div style="text-align: center;">
        <input id="crash-bet-amount" type="number" min="1" placeholder="Bet Bucks" style="padding: 10px; margin: 10px; border-radius: 10px; border: none; font-size: 16px; width: 120px;">
        <button id="crash-bet-btn" onclick="startCrashGame()" class="crash-btn">Place Bet</button>
        <button id="crash-cashout-btn" onclick="cashOut()" class="crash-btn" disabled>Cash Out</button>
        <p id="crash-status" style="font-size: 18px; margin-top: 10px; color: #fff;"></p>
    </div>
    <button id="game-switch-btn" onclick="openGameMenu()">Switch Game</button>
    <button id="notification-btn" onclick="showResetWarning()">RESET</button>
</div>
            <div id="jackpot-game">
                <div id="jackpot-wheel-container"><div id="jackpot-wheel-pointer"></div></div>
                <button id="jackpot-spin-btn" onclick="spinJackpot()">SPIN JACKPOT</button>
            </div>
        </div>
        <div id="jackpot-popup" style="display: none;">
    <div id="jackpot-popup-content">
        <h1>Jackpot Wheel!</h1>
        <p>Spin for 1,000‚Äì50,000 Bucks!</p>
        <div id="new-jackpot-wheel-container">
            <div id="new-jackpot-wheel-pointer"></div>
        </div>
        <button id="new-jackpot-spin-btn" onclick="spinNewJackpot()">SPIN JACKPOT</button>
        <div id="jackpot-result" style="font-size: 22px; margin-top: 20px;"></div>
    </div>
</div>
        <div id="progress-section">
            <div class="progress-container">
                <div class="progress-label">Jackpot Progress</div>
                <div class="progress-bar"><div class="progress-fill" id="jackpot-progress"></div></div>
            </div>
            <div class="progress-container">
                <div class="progress-label">Streak Progress</div>
                <div class="progress-bar"><div class="progress-fill" id="streak-progress"></div></div>
            </div>
        </div>
        <div id="history-section">
            <h2>Spin History</h2>
            <div id="spin-history"></div>
        </div>
        <div id="store-section">
            <h2>Bitflash Black Market</h2>
            <div id="store-list"></div>
            <div id="store-toggle" onclick="toggleStore()">>></div>
        </div>
        <div id="chat-section">
    <div id="chat-toggle" onclick="toggleChat()">>></div>
    <h2>Live Chat</h2>
    <div id="players-online-counter">Online: 79,271</div>
    <div id="chat-messages"></div>
    <input id="chat-input" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendChat()">
</div>
        <div id="notification-section">
            <h2>Notification Center</h2>
            <div id="notification-list"></div>
            <button class="setup-btn" style="margin-top: 15px;" onclick="closeNotifications()">Close</button>
        </div>
        <div id="rewards-section">
            <h2>Rewards & Boosts</h2>
            <div id="rewards-list"></div>
        </div>
        <button id="copy-data-btn" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #00FF00; border: none; border-radius: 10px; color: #fff; cursor: pointer;" onclick="copyUserData()">Copy Login ID</button>
    </div>
    <div id="popup"></div>
    <div id="ad-player">
        <div id="ad-content"></div>
        <div id="ad-timer">5s</div>
        <div id="ad-progress"><div id="ad-progress-fill"></div></div>
        <button id="ad-skip-btn" onclick="skipAd()" disabled>Skip (VIP 1+)</button>
    </div>
    <div id="loading-screen">
        <div id="loading-content">
            <p>Saving Options...</p>
            <div id="loading-ball"></div>
        </div>
    </div>
    <script>
window.addEventListener('beforeunload', function (e) {
  e.preventDefault();
  e.returnValue = 'Make sure you have copied your Login ID before leaving!';
});

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
          console.log('Service Worker registration failed:', error);
        });
    });
  }
  </script>
  
    <audio id="spin-sound" src="https://www.myinstants.com/instant/slot-machine-44998"></audio>
    <audio id="win-sound" src="https://www.myinstants.com/media/sounds/casino-win.mp3"></audio>
    <script>
let firebaseApp = null;
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js';
document.head.appendChild(script);
let lastLogEntry = null; // Global variable to store the Firestore log entry
let plinkoEngine, plinkoWorld, plinkoBalls = [], plinkoMultipliers = [25, 10, 4, 2, 1.5, 1, 0.7, 0.5, 0.2, 0.5, 0.7, 1, 1.5, 2, 4, 10, 25];
let plinkoBetAmount = 10, isPlinkoDropping = false;
let plinkoTotalMultiplier = 0;
let adminPasswordAttempts = 0;
let recoveryAttempts = 0;
const recoveryKey = "e9b4c7d2f0a1b3c5e7f9a0b2c4d6e8f0a1b3c5e7f9a0b2c4d6e8f0a1b3c5";
const serviceCode = "7294584237473243";
let hasAccessedAdminMode = false;
let isAdminCLIMode = false;
let isAdminChatCLIEnabled = true; // Existing CLI toggle
const callableFunctions = [
    "initRewards",
    "initStore",
    "initChat",
    "updateDashboard",
    "checkSpinLimit",
    "updateProgressBars",
    "toggleStore",
    "toggleChat",
    "openVIPMenu",
    "openGameMenu",
    "exitAdminMode",
    "saveSettings",
    "applyDailyBoosts",
    "updateJackpotCounter"
];
let isKioskMode = false; // New: Tracks kiosk mode state
let rouletteBetAmount = 0;
let rouletteBetColor = null; // 'red' or 'black'
let isRouletteSpinning = false;
let rouletteWheelAngle = 0;
let rouletteBallAngle = 0;
let rouletteWheelSpeed = 0;
let rouletteBallSpeed = 0;
let rouletteResult = null;
let jackpotText = "Jackpots Given: $24,728,219,613";
let jackpotSpeed = 100; // in milliseconds
let jackpotIncrement = 150000; // how much to add
let currentJackpot = 24728219613;
let jackpotInterval;
document.addEventListener("DOMContentLoaded", () => {
  jackpotInterval = setInterval(() => {
    currentJackpot += jackpotIncrement;
    document.getElementById("jackpot-counter").innerText = jackpotText.replace(/\$[\d,]+/, `$${currentJackpot.toLocaleString()}`);
  }, jackpotSpeed);
});

document.addEventListener("DOMContentLoaded", () => {
  setInterval(() => {
    currentJackpot += jackpotIncrement;
    document.getElementById("jackpot-counter").innerText = jackpotText.replace(/\$[\d,]+/, `$${currentJackpot.toLocaleString()}`);
  }, jackpotSpeed);
});

document.getElementById('network-info-btn').addEventListener('click', async () => {
  const popup = document.getElementById('network-info-popup');
  const content = document.getElementById('network-info-content');
  popup.style.display = 'block';
  content.textContent = 'Loading...';

  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    const info = `
IP: ${data.ip}
City: ${data.city}
Region: ${data.region}
Postal: ${data.postal}
Country: ${data.country_name}
Latitude: ${data.latitude}
Longitude: ${data.longitude}
Org: ${data.org}
ASN: ${data.asn}
Timezone: ${data.timezone}
    `;
    content.textContent = info;
  } catch (e) {
    content.textContent = 'Failed to load network info.';
  }
});

document.getElementById('network-info-back-btn').addEventListener('click', () => {
  document.getElementById('network-info-popup').style.display = 'none';
});

document.getElementById('display-info-btn').addEventListener('click', async () => {
  const popup = document.getElementById('display-info-popup');
  const content = document.getElementById('display-info-content');
  popup.style.display = 'block';  content.textContent = 'Loading...';
  content.textContent = 'Loading...';

  // Estimate refresh rate
  const samples = [];
  let last = performance.now();
  for (let i = 0; i < 100; i++) {
    await new Promise(requestAnimationFrame);
    const now = performance.now();
    samples.push(now - last);
    last = now;
  }
  const avg = samples.reduce((a, b) => a + b, 0) / samples.length;
  const refreshRate = (1000 / avg).toFixed(2);

  const width = screen.width * window.devicePixelRatio;
  const height = screen.height * window.devicePixelRatio;

  let renderer = 'Unavailable';
  try {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
    if (debugInfo) {
      renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
    }
  } catch (e) {}

  content.innerHTML = `
Approx. Refresh Rate: ${refreshRate} Hz
Physical Resolution: ${width} x ${height}
WebGL Renderer: ${renderer}
  `;
});

document.getElementById('display-info-back-btn').addEventListener('click', () => {
  document.getElementById('display-info-popup').style.display = 'none';
});

// Ensure recovery-screen and service-code-screen are hidden on startup
document.addEventListener("DOMContentLoaded", () => {
    const recoveryScreen = document.getElementById("recovery-screen");
    const serviceCodeScreen = document.getElementById("service-code-screen");
    if (recoveryScreen) recoveryScreen.style.display = "none";
    if (serviceCodeScreen) serviceCodeScreen.style.display = "none";
    console.log("Startup: recovery-screen and service-code-screen hidden");
});

let chatMode = "template"; // Default to template-based chat ("template" or "fake")
let chatMessageTemplate = "{name} from {location} won {prize}!"; // Default template

function isOlderDevice() {
    // Check for unsupported APIs or features common on older devices
    return !navigator.getBattery || !window.Promise || !window.WebGLRenderingContext;
}

function showCompatibilityWarning() {
    document.getElementById("service-code-screen").style.display = "none";
    document.getElementById("compatibility-warning-screen").style.display = "flex";
}

function validateRecoveryKey() {
    const input = document.getElementById("recovery-key-input").value.trim();
    const outputDiv = document.getElementById("terminal-output");
    const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
    
    if (input === recoveryKey) {
        recoveryAttempts = 0;
        document.getElementById("recovery-screen").style.display = "none";
        document.getElementById("main-container").style.display = "flex";
        document.getElementById("main-container").classList.add("active");
        
        outputDiv.innerHTML += `<p>[${timestamp}] Recovery key accepted. System unlocked.</p>`;
        showPopup("System unlocked successfully!", "OK");
    } else {
        recoveryAttempts++;
        document.getElementById("recovery-screen").style.display = "none";
        document.getElementById("crash-screen").style.display = "block";
        outputDiv.innerHTML += `<p>[${timestamp}] Invalid 256-bit recovery key. Recovery attempt count: ${recoveryAttempts}.</p>`;
        // Update crash screen with dynamic data
        const crashDiv = document.getElementById("crash-screen").querySelector("div");
        crashDiv.innerHTML = `
            <p>FLGC System Crash Report</p>
            <p>Version: 9525</p>
            <p>Error: CRITICAL_AUTHENTICATION_FAILURE</p>
            <p>Timestamp: ${new Date().toISOString()}</p>
            <p>Module: AdminSecuritySubsystem</p>
            <p>Details: Invalid 256-bit recovery key entered. Recovery attempt count: ${recoveryAttempts}.</p>
            <p>Authorized User: ${hasAccessedAdminMode ? "Yes" : "No"}</p>
            <p>System State: { adminPasswordAttempts: ${adminPasswordAttempts}, recoveryAttempts: ${recoveryAttempts}, userName: "${userName || "N/A"}", userLocation: "${userLocation || "N/A"}", bitflashBucks: ${bitflashBucks}, spinsLeft: ${spinsLeft}, vipLevel: ${vipLevel} }</p>
            <p>Stack Trace: validateRecoveryKey() -> onSubmit() -> SecurityManager.validateCredentials()</p>
            <p>Environment: Browser: ${navigator.userAgent}, Platform: ${navigator.platform}, Screen: ${screen.width}x${screen.height}, Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}</p>
            <p>Instructions: The system has locked due to an invalid recovery key. Contact Bitflash Enterprises support at https://forms.gle/XAsvp2gBDeMyPy8i8 or via the Support Chat at https://cdn.botpress.cloud/webchat/v2.3/shareable.html?configUrl=https://files.bpcontent.cloud/2025/04/23/16/20250423161704-XGJNS7MN.json. Provide this crash report for assistance. Do not attempt to restart or modify the system, as this may result in data loss.</p>
            <p>Terminal: Enter commands below to interact with the system.</p>
            <div id="terminal-output" style="background: #111; padding: 10px; border: 1px solid #333; max-height: 200px; overflow-y: auto; margin-top: 10px;">${outputDiv.innerHTML}</div>
            <input id="terminal-input" type="text" placeholder=">" style="width: 100%; padding: 8px; margin-top: 10px; background: #111; color: #fff; border: 1px solid #333; font-family: monospace;">
            <button onclick="processTerminalCommand()" style="padding: 8px; margin-top: 10px; background: #000000; color: #fff; border: none; border-radius: 5px;">Execute</button>
        `;
    }
}

function showResetWarning() {
  const popup = document.getElementById("popup");
  popup.innerHTML = `
    <h2 style="margin-bottom: 20px;">‚ö†Ô∏è Reset Warning</h2>
    <p style="margin-bottom: 25px;">Resetting will permanently delete all local game data.<br><br><strong>Save your Login ID first</strong> or you will lose all progress.</p>
    <button onclick="hideResetWarning()" style="padding: 12px 20px; margin-right: 10px; background: #555; border: none; border-radius: 8px; color: white; font-size: 16px;">Go Back</button>
    <button onclick="confirmReset()" style="padding: 12px 20px; background: #ff3333; border: none; border-radius: 8px; color: white; font-size: 16px;">Reset Now</button>
  `;
  popup.style.display = "block";
  popup.classList.add("active");
}

function hideResetWarning() {
  const popup = document.getElementById("popup");
  popup.classList.remove("active");
  setTimeout(() => popup.style.display = "none", 300);
}

function confirmReset() {
  localStorage.clear();
  location.reload();
}

// === Light Mode CSS Injection ===
const style = document.createElement('style');
style.innerHTML = `
  body.light-mode {
    background: linear-gradient(135deg, #ffffff, #e4e4e4) !important;
    color: #111 !important;
  }

  body.light-mode #main-container,
  body.light-mode #ad-player,
  body.light-mode #ad-content,
  body.light-mode #ad-timer {
  background: rgba(255, 255, 255, 0.95) !important;
  color: #000 !important;
}
  body.light-mode #game-section,
  body.light-mode #history-section,
  body.light-mode #store-section,
  body.light-mode #chat-section,
  body.light-mode #notification-section,
  body.light-mode #rewards-section,
  body.light-mode #popup,
  body.light-mode #ad-player,
  body.light-mode #admin-screen,
  body.light-mode #setup-screen,
  body.light-mode #vip-menu,
  body.light-mode #game-menu,
  body.light-mode #tos-screen,
  body.light-mode #policy-screen {
    background: rgba(255, 255, 255, 0.92) !important;
    color: #000 !important;
  }

  body.light-mode .reel,
  body.light-mode .timer-box,
  body.light-mode .store-item,
  body.light-mode .reward-item,
  body.light-mode .history-item {
    background: #fff !important;
    color: #000 !important;
    box-shadow: 0 0 15px #00ffff !important;
  }

  body.light-mode input,
  body.light-mode textarea,
  body.light-mode select,
  body.light-mode button {
    background: #f0f0f0 !important;
    color: #000 !important;
    border: 1px solid #ccc !important;
  }

  body.light-mode button:hover {
    background: #ddd !important;
    color: #000 !important;
  }
`;
document.head.appendChild(style);

        let deferredPrompt = null;

// Detect Chrome/Edge/Android that supports PWA install prompt
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner("Install the New FLGC App and get Exclusive Discounts and Benefits");
});

document.getElementById("install-button").addEventListener("click", async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    console.log("User choice:", result.outcome);
    hideInstallBanner();
  } else {
    alert("To install FLGC for Apple Devices:\n1. ‚ö†Ô∏èIMPORTANT‚ö†Ô∏è Go to flgc.netlify.app/app\n2. In /app Tap Share (‚¨ÜÔ∏è)\n3. Add to Home Screen/Dock");
  }
});

// Detect iOS/iPadOS Safari
const isIos = /iphone|ipad/.test(navigator.userAgent.toLowerCase());
const isStandalone = window.navigator.standalone === true;
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

if (isIos && !isStandalone && isSafari) {
  setTimeout(() => {
    showInstallBanner("Install the FLGC App! Tap Share ‚Üí Add to Home Screen to install FLGC");
  }, 3000);
}

// Safari on macOS: show basic install suggestion
const isMacSafari = navigator.platform.includes("Mac") && isSafari;
if (isMacSafari) {
  setTimeout(() => {
    showInstallBanner("Install the FLGC App!");
  }, 3000);
}

        let notificationPrefs = { ads: false, wins: false, daily: false, events: false
        };
        
        let ipapiData = null; // Cache ipapi data
function updateUserLocation() {
    fetch("www.ipapi.com/json")
        .then(response => response.json())
        .then(data => {
            userLocation = data.city || "";
            ipapiData = data; // Store full data
            console.log("City fetched:", userLocation);
            const locationInput = document.getElementById("setup-location");
            if (locationInput) locationInput.value = userLocation;
        })
        .catch(error => {
            userLocation = "";
            ipapiData = null;
            console.log("IPAPI error:", error);
            const locationInput = document.getElementById("setup-location");
            if (locationInput) locationInput.value = userLocation;
        });
}
updateUserLocation();

function refreshAllLists() {
    // --- Prizes ---
    document.getElementById("admin-prize-name").value = "__temp__";
    addPrize();
    prizes.pop();
    updateAdminList("prizes", prizes, "admin-prizes-search", "admin-prizes-list");

    // --- Store Items ---
    document.getElementById("admin-store-name").value = "__temp__";
    document.getElementById("admin-store-price").value = "1";
    document.getElementById("admin-store-effect").value = "temp";
    document.getElementById("admin-store-desc").value = "temp";
    addStoreItem();
    storeItems.pop();
    updateAdminList("store", storeItems, "admin-store-search", "admin-store-list");

    // --- Rewards ---
    document.getElementById("admin-reward-name").value = "__temp__";
    document.getElementById("admin-reward-cost").value = "1";
    document.getElementById("admin-reward-effect").value = "temp";
    document.getElementById("admin-reward-type").value = "temp";
    addReward();
    rewards.pop();
    updateAdminList("rewards", rewards, "admin-rewards-search", "admin-rewards-list");

    // --- Ads ---
    document.getElementById("admin-ad-content").value = "__temp__";
    document.getElementById("admin-ad-button-text").value = "temp";
    document.getElementById("admin-ad-button-link").value = "https://temp.com";
    addAd();
    adContent.pop();
    updateAdminList("ads", adContent, "admin-ads-search", "admin-ads-list");
}

function runCustomJS() {
    const code = document.getElementById("custom-js-code").value;
    try {
        const result = eval(code);
        document.getElementById("js-output").innerText = `Output: ${result ?? '[No return]'}`;
    } catch (err) {
        document.getElementById("js-output").innerText = `Error: ${err.message}`;
    }
}
let playersOnlineCount = 79271; // Initial count
let playersOnlineText = "Online: $"; // Text template
let playersOnlineSpeed = 2000; // Update interval in ms
let playersOnlineIncrement = 100; // Max increment/decrement
let playersOnlineDirection = "both"; // Options: "up", "down", "both"
let playersOnlineInterval = null;

function updatePlayersOnlineCounter() {
    clearInterval(playersOnlineInterval);
    playersOnlineInterval = setInterval(() => {
        let change = Math.floor(Math.random() * playersOnlineIncrement);
        if (playersOnlineDirection === "up") {
            playersOnlineCount += change;
        } else if (playersOnlineDirection === "down") {
            playersOnlineCount -= change;
            if (playersOnlineCount < 0) playersOnlineCount = 0; // Prevent negative
        } else {
            change = Math.random() > 0.5 ? change : -change;
            playersOnlineCount += change;
            if (playersOnlineCount < 0) playersOnlineCount = 0;
        }
        const counter = document.getElementById("players-online-counter");
        counter.textContent = playersOnlineText.replace("$", playersOnlineCount.toLocaleString());
    }, playersOnlineSpeed);
}

// Initialize on load
updatePlayersOnlineCounter();
function getDeviceInfo() {
    const ua = navigator.userAgent;
    let os = "Unknown/Various";
    let device = "PC";
    let browser = "Unknown";

    // OS detection
    if (ua.includes("Windows")) os = "Windows";
    else if (ua.includes("iPhone; CPU")) os = "iOS"
    else if (ua.includes("iPad; CPU")) os = "iPadOS"
    else if (ua.includes("Mac OS")) os = "macOS";
    else if (ua.includes("Linux; Android")) os = "Android";
    else if (ua.includes("CrOS")) os = "ChromeOS";
    else if (ua.includes("Linux")) os = "Linux";

    // Device detection (basic)
    if (ua.includes("Mobile")) device = "Mobile Device";
    else if (ua.includes("Tablet")) device = "Tablet";
    else if (ua.includes("iPhone")) device = "iPhone";
    else if (ua.includes("iPad")) device = "iPad";

    // Browser detection
    if (ua.includes("Chrome")) browser = "Chrome";
    else if (ua.includes("Firefox")) browser = "Firefox";
    else if (ua.includes("Safari")) browser = "Safari";
    else if (ua.includes("Edge")) browser = "Edge";

    return { os };
}

function showInfoPopup() {
    const popup = document.getElementById("info-popup");
    const content = document.getElementById("info-content");
    if (!popup || !content) return;

    const deviceInfo = getDeviceInfo();
    let networkInfo = ipapiData || { error: "" };

    content.innerHTML = `
        <strong>Device Info:</strong><br>
        OS: ${deviceInfo.os}<br>
        App Version: 9525 for ${deviceInfo.os}<br><br>
        <strong></strong><br>
        ${networkInfo.error ? networkInfo.error : `
            
        `}
    `;

    popup.classList.add("active");
}

function hideInfoPopup() {
    const popup = document.getElementById("info-popup");
    if (popup) popup.classList.remove("active");
}
// Add after hideInfoPopup() or at end of <script>
function showRawDevicePopup() {
    const popup = document.getElementById("raw-device-popup");
    const content = document.getElementById("raw-device-content");
    if (!popup || !content) return;

    // WebGL Info
    function getWebGLInfo() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            return {
                vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
            };
        } catch (e) {
            return { vendor: "Unavailable", renderer: "Unavailable" };
        }
    }

    // User-Agent Hints (if available)
    let uaHints = {};
    if (navigator.userAgentData) {
        uaHints.brands = navigator.userAgentData.brands.map(b => `${b.brand} ${b.version}`);
        uaHints.mobile = navigator.userAgentData.mobile;
        uaHints.platform = navigator.userAgentData.platform;
    }

    const webgl = getWebGLInfo();
    const rawData = {
        userAgent: navigator.userAgent || "Unknown",
        userAgentHints: uaHints,
        platform: navigator.platform || "Unknown",
        vendor: navigator.vendor || "Unknown",
        language: navigator.language || "Unknown",
        languages: navigator.languages || [],
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "Unknown",
        timezoneOffset: new Date().getTimezoneOffset(),
        screen: {
            width: screen.width,
            height: screen.height,
            availWidth: screen.availWidth,
            availHeight: screen.availHeight,
            colorDepth: screen.colorDepth,
            pixelDepth: screen.pixelDepth,
            devicePixelRatio: window.devicePixelRatio
        },
        deviceCapabilities: {
            hardwareConcurrency: navigator.hardwareConcurrency || "Unknown",
            deviceMemory: navigator.deviceMemory || "Unknown",
            touchSupport: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            clipboardSupported: !!navigator.clipboard,
            cookieEnabled: navigator.cookieEnabled,
            javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : "Unavailable",
            doNotTrack: navigator.doNotTrack,
        },
        navigatorInfo: {
            product: navigator.product,
            productSub: navigator.productSub,
            appCodeName: navigator.appCodeName,
            appName: navigator.appName,
            appVersion: navigator.appVersion
        },
        webglInfo: webgl,
    };

    content.innerHTML = `
        <pre style="word-wrap: break-word; white-space: pre-wrap;">${JSON.stringify(rawData, null, 2)}</pre>
    `;

    document.getElementById("info-popup")?.classList.remove("active");
    popup.classList.add("active");
}

function hideRawDevicePopup() {
    const popup = document.getElementById("raw-device-popup");
    if (popup) popup.classList.remove("active");
    document.getElementById("info-popup")?.classList.add("active"); // Show info popup
}

// Event listeners
document.getElementById("more-device-btn")?.addEventListener("click", showRawDevicePopup);
document.getElementById("raw-device-back-btn")?.addEventListener("click", hideRawDevicePopup);
// Event listeners
document.getElementById("info-btn")?.addEventListener("click", showFirestoreData);
document.getElementById("info-back-btn")?.addEventListener("click", hideInfoPopup);

        let testCode = null;
        let prizes = [
        "__temp__"
        ];
        let jackpotPrizes = [
            "Private Jet", "$100M Cash", "Luxury Yacht", "Diamond Vault", "Cartel Mansion"
        ];
        let storeItems = [
            { name: "Bitflash Cocaine Pack", price: 100, effect: "+10 Spins", desc: "Boost your spins!" },
            { name: "Bitflash Meth Brick", price: 75, effect: "Triple Jackpot Odds", desc: "Cook up jackpots!" },
        ];
        let rewards = [
            { name: "Spin Frenzy", cost: 1, effect: "+2 Spins", type: "ad" },
        ];
       let adContent = [
    { 
        content: "Arm up like a kingpin! Premium firepower at Cartel Guns!", 
        buttonText: "Shop Firearms", 
        buttonLink: "https://sites.google.com/view/cartelguns/" 
    },
    { 
        content: "Pure Bitflash Coke ‚Äì the ultimate high for winners!", 
        buttonText: "Get the Rush", 
        buttonLink: "https://sites.google.com/view/bitflashcoke/home" 
    },
    { 
        content: "Meth lab kit ‚Äì Cook up some wins!", 
        buttonText: "Cook Now", 
        buttonLink: "https://sites.google.com/view/bitflashmlk/home" 
    },
    { 
        content: "Stolen Gold ‚Äì grab your share of the heist!", 
        buttonText: "Claim Gold", 
        buttonLink: "https://sites.google.com/view/stolengold/home" 
    },
    { 
        content: "Bitflash Smokes ‚Äì premium clouds for high rollers!", 
        buttonText: "Inhale Luxury", 
        buttonLink: "https://sites.google.com/view/bitflashsmoke/home" 
    },
    { 
        content: "Black Market Bets ‚Äì high stakes, higher rewards!", 
        buttonText: "Place Your Bet", 
        buttonLink: "https://sites.google.com/view/blckmktbts/home" 
    },
    { 
        content: "Bitflash Vodka ‚Äì distilled for the fearless!", 
        buttonText: "Sip the Power", 
        buttonLink: "https://sites.google.com/view/bitflashvodka/home" 
    },
    { 
        content: "Heist Planner Pro ‚Äì plan your next big score!", 
        buttonText: "Plan the Heist", 
        buttonLink: "https://sites.google.com/view/heistplannerpro/home" 
    },
    { 
        content: "Dark Web Deals ‚Äì exclusive offers for the bold!", 
        buttonText: "Browse Deals", 
        buttonLink: "https://sites.google.com/view/dwdls/home" 
    },
    { 
        content: "Fake ID Deluxe ‚Äì Age up, cash in!", 
        buttonText: "Change Identity", 
        buttonLink: "https://sites.google.com/view/faidlux/home" 
    },
    { 
        content: "C4 Roulette ‚Äì spin for explosive wins!", 
        buttonText: "Spin Now", 
        buttonLink: "https://sites.google.com/view/c4roulette/home" 
    }
];
        let fakeMessages = [
    "John from LA just won a jet!",
    "Sara from Miami snagged $10M!",
    "Bitflash is insane!",
    "Mike from Chicago got a tank!",
    "Lisa from London won a yacht!",
    "Alex from Berlin stole a private runway!",
    "Emily from Vegas now owns an air force!",
    "Tom from Houston got 3 submarines!",
    "Chloe from Dubai just hijacked a 747!",
    "Raj from Mumbai unlocked Area 51 access!",
    "Zoe from Sydney won a volcano lair!",
    "Kevin from Toronto got lifetime fuel!",
    "Yuki from Tokyo claimed Elon‚Äôs jet!",
    "Brian from Dublin just bought Antarctica!",
    "Nina from Paris won a floating casino!",
    "Carlos from Madrid now runs a black market!",
    "Anna from Moscow scored a stealth bomber!",
    "Jacob from Cape Town just got a dragon!",
    "Sophie from Rome owns 47 airports now!",
    "Daniel from Seoul hijacked a crypto vault!",
    "Isabella from NYC just hit the gold reserve!",
    "Leo from Bangkok won a hyperloop prototype!",
    "Maya from Rio just bought the moon!",
    "Omar from Cairo now controls global airspace!",
    "Julia from Zurich won a jetpack army!",
    "Chris from Miami just bought the FBI‚Äôs old HQ!",
    "Lena from Stockholm claimed 9 space shuttles!",
    "Viktor from Prague now owns time travel tech!",
    "Ella from LA unlocked free bribes for life!",
    "Jake from Seattle bought 12 oil rigs!",
    "Amir from Dubai just got the world‚Äôs last Concorde!",
    "Ivan from Warsaw won an island full of gold!",
    "Tina from Istanbul now runs sky casinos!",
    "Noah from Dallas hijacked an airline!",
    "Hannah from Jakarta bought the air rights to Earth!",
    "Aria from Milan just scored 999 helicopters!",
    "Max from Oslo now owns the Matrix servers!",
    "Sophia from Montreal got free airstrikes!",
    "Liam from Budapest just snagged a weaponized blimp!",
    "Eva from Lisbon now controls the weather!"
        ];
        let bannedWords = [
    "scam", "fake", "fraud", "*****", "*****", 
    "con", "swindle", "ripoff", "deceive", "hustle", 
    "cheat", "lie", "sham", "hoax", "phony", 
    "bullshit", "bunk", "fraudulent", "fakeout", "shady", 
    "scammer", "crook", "dishonest", "clash", "conman", 
    "grift", "mislead", "fool", "counterfeit", "corrupt", 
    "skam", "flimflam", "scammed", "dodgy", "jank", 
    "dubious", "sneaky", "questionable", "bamboozle", "scummy", 
    "rip-off", "offload", "scuzz", "shifty", "phony baloney", 
    "dirty deal", "bogus", "dodgy deal", "backdoor", "shameless", 
    "sleazy", "swindler", "trickster", "liar", "shyster", 
    "grifter", "conning", "misrepresentation", "kickback", "cover-up", 
    "untrustworthy", "manipulative", "underhanded", "double-cross", "backstab", 
    "under-the-table", "manipulate", "fraudster", "fake news", "bait and switch", 
    "dirty scam", "lowdown", "dirty tricks", "scammy", "crooked", 
    "charlatan", "falsify", "coercion", "rip", "conjob", "racketeering", 
    "bent", "hustling", "sham operation", "false pretense", "set-up", 
    "lie to", "unscrupulous", "sneak", "underhand", "dubiousness"
];
        let popupMessages = [
    "Maria from New York just won 72 Boeing BBJ 737s!",
    "FBI seized your jet! Pay $499 to appeal!",
    "99% of players win big! Spin now!",
    "Join VIP for instant wins!",
    "Jack from Nevada just hijacked a Gulfstream G700!",
    "Fuel prices too high? Gamble for a free tank!",
    "Emily from LA won 12 private islands‚Äîbe next!",
    "Warning: Your 737 MAX has MCAS... spin to disable!",
    "Warning: Your 737 MAX has MCAS... spin to disable!",
        ];
        let customGames = [];
        const sounds = {
            spin: document.getElementById("spin-sound"),
            win: document.getElementById("win-sound")
        };
        let spinsLeft = 5, bitflashBucks = 0, jackpotProgress = 0, streakProgress = 0, spinTimer = 10, claimTimer = 0, eventTimer = 3600, vipTimer = 30, dailyTimer = 86400, tenMinuteTimer = 600, isSpinning = false, streakCount = 0, vipLevel = 0, adCount = 0, currentGame = "slots", spinsToday = 0, adTimer = 5, winChance = 0.25, defaultPrizeSpins = 3, defaultPrizeBucks = 15, userName = "", userLocation = "", autoSpin = false, autoSpinDelay = 1000, autoSpinSkipPrize = false, notifications = [], notificationCount = 0, popupDisabled = false, adPopupsEnabled = true, adminPassword = "5820320", soundEnabled = true, notificationPreference = "popup";
        const reels = [document.getElementById("reel1"), document.getElementById("reel2"), document.getElementById("reel3")];
        const progressBars = {
            jackpot: document.getElementById("jackpot-progress"),
            streak: document.getElementById("streak-progress")
        };
        const spinBtn = document.getElementById("spin-btn");
        const autoSpinBtn = document.getElementById("auto-spin-btn");
        const notificationBtn = document.getElementById("notification-btn");
        const storeSection = document.getElementById("store-section");
        const storeToggle = document.getElementById("store-toggle");
        const chatSection = document.getElementById("chat-section");
        const chatToggle = document.getElementById("chat-toggle");
        const popup = document.getElementById("popup");

        function initScreen(screenId) {
            const screen = document.getElementById(screenId);
            screen.style.display = "flex";
            setTimeout(() => screen.classList.add("active"), 10);
        }
        function hideScreen(screenId) {
            const screen = document.getElementById(screenId);
            screen.classList.remove("active");
            setTimeout(() => screen.style.display = "none", 500);
        }
        document.getElementById("terms-agree").addEventListener("change", () => {
            document.getElementById("terms-next").disabled = !document.getElementById("terms-agree").checked;
        });

function enableNotifications(allow) {
    if (allow) {
        if ("Notification" in window) {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    hideScreen("setup-notifications");
                    initScreen("setup-notification-types");
                } else {
                    showPopup("Notifications blocked! Skipping...", "OK");
                    finalizeSetup();
                    startAutoSave();
                }
            });
        } else {
            showPopup("Your browser doesn‚Äôt support notifications!", "OK");
            finalizeSetup();
            startAutoSave();
        }
    } else {
        finalizeSetup(); // Skip notifications
        startAutoSave();
    }
}
function sendTestNotification() {
    notificationPrefs.ads = document.getElementById("notify-ads").checked;
    notificationPrefs.wins = document.getElementById("notify-wins").checked;
    testCode = Math.floor(100000 + Math.random() * 900000).toString(); // 6-digit code
    if (Notification.permission === "granted") {
        new Notification("FLGC Test Notification", {
            body: `Hi ${userName}! Enter this code to continue: ${testCode}`,
            icon: "path/to/icon.png" // Optional, add later
        });
        hideScreen("setup-notification-types");
        initScreen("setup-verify-code");
    } else {
        showPopup("Notification permission not granted!", "OK");
        finalizeSetup();
        startAutoSave();
    }
}
function verifyTestCode() {
    const enteredCode = document.getElementById("verify-code").value;
    if (enteredCode === testCode) {
        showPopup("Notifications verified!");
        finalizeSetup();
        startAutoSave();
    } else {
        showPopup("Incorrect code!", "OK");
        document.getElementById("verify-code").value = "";
    }
}
        function showTOS() {
            initScreen("tos-screen");
        }
        function hideTOS() {
            hideScreen("tos-screen");
        }
        function showPolicy() {
            initScreen("policy-screen");
        }
        function hidePolicy() {
            hideScreen("policy-screen");
        }
        async function nextSetupStep() {
    const name = document.getElementById("setup-name").value.trim();
    const location = document.getElementById("setup-location").value.trim();
    initGame;

    if (!name || !location) {
        showPopup("Please enter both name and location!", "OK");
        return;
    }

    userName = name;
    userLocation = location;
    userData.userName = userName;
    userData.userLocation = userLocation;
    userData.soundEnabled = soundEnabled;
    userData.notificationPreference = notificationPreference;
    initGame();

    try {
        const db = getFirestore(firebaseApp);
        const docRef = await addDoc(collection(db, "accounts"), userData);
        accountKey = docRef.id;
        showPopup(`Welcome to FLGC, ${userName}! Your Account Key is: <strong>${accountKey}</strong><br>Please save this key, as you will need it to log in. Do not lose it!`, "OK");
        startDataSync();
        hideScreen("setup-screen");
        initGame();
        initScreen("main-container");
        updateDashboard();
        checkSpinLimit();
        initStore();
        initRewards();
        initChat();
        initGame();
    } catch (e) {
        console.error("Account creation error:", e);
        showPopup("Error creating account. Please try again.", "OK");
    }
}

        function skipSetup() {
    userName = document.getElementById("setup-name").value || "";
    userLocation = document.getElementById("setup-location").value || "";
    finalizeSetup();
    startAutoSave();
}
        function previewTheme(theme) {
            const preview = document.getElementById("theme-preview");
            if (theme === "vegas") preview.style.background = "linear-gradient(135deg, #ff0000, #ffd700)";
            else if (theme === "cartel") preview.style.background = "linear-gradient(135deg, #006400, #ff4500)";
            else if (theme === "luxury") preview.style.background = "linear-gradient(135deg, #1a0d2e, #4a0072)";
            else if (theme === "cyber") preview.style.background = "linear-gradient(135deg, #00ff00, #0000ff)";
            else if (theme === "dark") preview.style.background = "linear-gradient(135deg, #111, #333)";
        }
        function createCustomTheme() {
            document.getElementById("setup-step-2").style.opacity = "0";
            setTimeout(() => {
                document.getElementById("setup-step-2").style.display = "none";
                document.getElementById("custom-theme").style.display = "block";
                document.getElementById("custom-theme").style.opacity = "1";
                updateCustomPreview();
            }, 500);
        }
        function updateCustomPreview() {
            const mainColor = document.getElementById("custom-main-color").value;
            const secondaryColor = document.getElementById("custom-secondary-color").value;
            const buttonColor = document.getElementById("custom-button-color").value;
            const textColor = document.getElementById("custom-text-color").value;
            document.getElementById("custom-preview").style.background = `linear-gradient(135deg, ${mainColor}, ${secondaryColor})`;
            document.getElementById("custom-preview").style.color = textColor;
            document.querySelectorAll(".setup-btn").forEach(btn => btn.style.background = buttonColor);
        }
        function applyCustomTheme() {
            const mainColor = document.getElementById("custom-main-color").value;
            const secondaryColor = document.getElementById("custom-secondary-color").value;
            const buttonColor = document.getElementById("custom-button-color").value;
            const textColor = document.getElementById("custom-text-color").value;
            document.body.style.background = `linear-gradient(135deg, ${mainColor}, ${secondaryColor})`;
            document.body.style.color = textColor;
            document.querySelectorAll("button").forEach(btn => btn.style.background = buttonColor);
            nextSetupStep(2);
        }
        function backToThemes() {
            document.getElementById("custom-theme").style.opacity = "0";
            setTimeout(() => {
                document.getElementById("custom-theme").style.display = "none";
                document.getElementById("setup-step-2").style.display = "block";
                document.getElementById("setup-step-2").style.opacity = "1";
            }, 500);
        }
        function applyTheme(theme) {
            if (theme === "vegas") {
                document.body.style.background = "linear-gradient(135deg, #ff0000, #ffd700)";
                document.querySelectorAll("button").forEach(btn => btn.style.background = "#ff4500");
            } else if (theme === "cartel") {
                document.body.style.background = "linear-gradient(135deg, #006400, #ff4500)";
                document.querySelectorAll("button").forEach(btn => btn.style.background = "#8b0000");
            } else if (theme === "luxury") {
                document.body.style.background = "linear-gradient(135deg, #1a0d2e, #4a0072)";
                document.querySelectorAll("button").forEach(btn => btn.style.background = "#ff00ff");
            } else if (theme === "cyber") {
                document.body.style.background = "linear-gradient(135deg, #00ff00, #0000ff)";
                document.querySelectorAll("button").forEach(btn => btn.style.background = "#00ffff");
            } else if (theme === "dark") {
                document.body.style.background = "linear-gradient(135deg, #111, #333)";
                document.querySelectorAll("button").forEach(btn => btn.style.background = "#666");
            }
        }
        function finalizeSetup() {
    document.getElementById("setup-screen").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("setup-screen").style.display = "none";
        document.getElementById("main-container").style.display = "flex";
        setTimeout(() => {
            document.getElementById("main-container").classList.add("active");
            initGame();
            showPopup("Welcome to FLGC!", "Continue");
        }, 10);
    }, 500);
}
function sendNotification(title, body, type) {
    if (Notification.permission === "granted" && notificationPrefs[type]) {
        new Notification(title, { body });
    }
}
let accountKey = null;
let userData = {
    spinsLeft: 10,
    bitflashBucks: 100,
    jackpotProgress: 0,
    streakProgress: 0,
    streakCount: 0,
    vipLevel: 0,
    spinsToday: 0,
    winChance: 0.25,
    defaultPrizeSpins: 5,
    defaultPrizeBucks: 25,
    userName: "",
    userLocation: "",
    autoSpinDelay: 1000,
    autoSpinSkipPrize: false,
    prizes: [],
    storeItems: [],
    rewards: [],
    adContent: [],
    fakeMessages: [],
    bannedWords: [],
    adminPassword: "admin123",
    soundEnabled: true,
    notificationPreference: "bottom-right",
    notificationPrefs: {}
};

function showAccountOptions() {
    document.getElementById("account-options").style.display = "block";
    document.getElementById("login-form").style.display = "none";
}

function showCreateAccount() {
    hideScreen("account-screen");
    initScreen("setup-screen");
}

function showLogin() {
    document.getElementById("account-options").style.display = "none";
    document.getElementById("login-form").style.display = "block";
}

async function handleLogin() {
    const key = document.getElementById("account-key-input").value.trim();
    if (!key) {
        showPopup("Please enter a valid account key.", "OK");
        return;
    }

    try {
        const db = window.getFirestoreInstance();
        const docRef = window.doc(db, "accounts", key);
        const docSnap = await window.getDoc(docRef);

        if (docSnap.exists()) {
            userData = docSnap.data();
            accountKey = key;
            spinsLeft = userData.spinsLeft;
            bitflashBucks = userData.bitflashBucks;
            jackpotProgress = userData.jackpotProgress;
            streakProgress = userData.streakProgress;
            streakCount = userData.streakCount;
            vipLevel = userData.vipLevel;
            spinsToday = userData.spinsToday;
            winChance = userData.winChance;
            defaultPrizeSpins = userData.defaultPrizeSpins;
            defaultPrizeBucks = userData.defaultPrizeBucks;
            userName = userData.userName;
            userLocation = userData.userLocation;
            autoSpinDelay = userData.autoSpinDelay;
            autoSpinSkipPrize = userData.autoSpinSkipPrize;
            adminPassword = userData.adminPassword;
            soundEnabled = userData.soundEnabled;
            notificationPreference = userData.notificationPreference;
            notificationPrefs = userData.notificationPrefs;
            showPopup(`Welcome back, ${userData.userName}!`, "OK");
            startDataSync();
            hideScreen("account-screen");
            initScreen("main-container");
            updateDashboard();
            checkSpinLimit();
            initStore();
            initRewards();
            initChat();
            initGame();
        } else {
            showPopup("Invalid account key. Please try again.", "OK");
        }
    } catch (e) {
        console.error("Login error:", e);
        showPopup("Error logging in: " + e.message, "OK");
    }
}

async function saveAccountData() {
    if (!accountKey) return;
    try {
        const db = window.getFirestoreInstance();
        await window.setDoc(window.doc(db, "accounts", accountKey), userData);
    } catch (e) {
        console.error("Error updating account data:", e);
    }
}

function startDataSync() {
    setInterval(() => {
        userData.spinsLeft = spinsLeft;
        userData.bitflashBucks = bitflashBucks;
        userData.jackpotProgress = jackpotProgress;
        userData.streakProgress = streakProgress;
        userData.streakCount = streakCount;
        userData.vipLevel = vipLevel;
        userData.spinsToday = spinsToday;
        userData.winChance = winChance;
        userData.defaultPrizeSpins = defaultPrizeSpins;
        userData.defaultPrizeBucks = defaultPrizeBucks;
        userData.userName = userName;
        userData.userLocation = userLocation;
        userData.autoSpinDelay = autoSpinDelay;
        userData.autoSpinSkipPrize = autoSpinSkipPrize;
        userData.adminPassword = adminPassword;
        userData.soundEnabled = soundEnabled;
        userData.notificationPreference = notificationPreference;
        userData.notificationPrefs = notificationPrefs;
        saveAccountData();
    }, 1000);
}

async function nextSetupStep() {
    const name = document.getElementById("setup-name").value.trim();
    const location = document.getElementById("setup-location").value.trim();

    if (!name || !location) {
        showPopup("Please enter both name and location!", "OK");
        return;
    }

    userName = name;
    userLocation = location;
    userData.userName = userName;
    userData.userLocation = userLocation;
    userData.soundEnabled = soundEnabled;
    userData.notificationPreference = notificationPreference;

    try {
        const db = window.getFirestoreInstance();
        const docRef = await window.addDoc(window.collection(db, "accounts"), userData);
        accountKey = docRef.id;
        showPopup(`Welcome to FLGC, ${userName}! Your Account Key is: <strong>${accountKey}</strong><br>Please save this key, as you will need it to log in. Do not lose it!`, "OK");
        startDataSync();
        hideScreen("setup-screen");
        initScreen("main-container");
        updateDashboard();
        checkSpinLimit();
        initStore();
        initRewards();
        initChat();
        initGame();
    } catch (e) {
        console.error("Account creation error:", e);
        showPopup("Error creating account: " + e.message, "OK");
    }
}

function loadFromLocalSave() {
    const savedData = localStorage.getItem('savedLoginData');
    if (!savedData) {
        document.getElementById('paste-status').innerText = "No local save found.";
        return;
    }

    try {
        const data = JSON.parse(savedData);
        loadSavedDataFromObject(data);
        document.getElementById('paste-status').innerText = "Local save loaded successfully!";
    } catch (err) {
        console.error("Failed to load local save:", err);
        document.getElementById('paste-status').innerText = "Failed to load local save. Data might be corrupted.";
    }
}

async function pasteSavedData() {
    try {
        const clipboardText = await navigator.clipboard.readText();
        if (!clipboardText) {
            document.getElementById('paste-status').innerText = "Clipboard is empty.";
            return;
        }
        const data = JSON.parse(clipboardText);
        loadSavedDataFromObject(data);
        document.getElementById('paste-status').innerText = "Login successful!";
    } catch (err) {
        console.error("Failed to paste or parse saved data:", err);
        document.getElementById('paste-status').innerText = "Failed to paste or load. Make sure your Login ID is copied.";
    }
}

        function loadSavedDataFromObject(data) {
    spinsLeft = data.spinsLeft || 3;
    bitflashBucks = data.bitflashBucks || 0;
    jackpotProgress = data.jackpotProgress || 0;
    streakProgress = data.streakProgress || 0;
    streakCount = data.streakCount || 0;
    vipLevel = data.vipLevel || 0;
    spinsToday = data.spinsToday || 0;
    winChance = data.winChance || 0.25;
    defaultPrizeSpins = data.defaultPrizeSpins || 3;
    defaultPrizeBucks = data.defaultPrizeBucks || 15;
    userName = data.userName || "";
    userLocation = data.userLocation || "Unknown";
    autoSpinDelay = data.autoSpinDelay || 1000;
    autoSpinSkipPrize = data.autoSpinSkipPrize || false;
    prizes = data.prizes || prizes;
    storeItems = data.storeItems || storeItems;
    rewards = data.rewards || rewards;
    adContent = data.adContent || adContent;
    fakeMessages = data.fakeMessages || fakeMessages;
    bannedWords = data.bannedWords || bannedWords;
    adminPassword = data.adminPassword === "default" ? "5820320" : data.adminPassword;
    soundEnabled = data.soundEnabled || true;
    notificationPreference = data.notificationPreference || true;
    notificationPrefs = data.notificationPrefs || notificationPrefs;
    popup.style.display = "none";
    document.getElementById("setup-screen").style.display = "none";
    document.getElementById("main-container").style.display = "flex";
    setTimeout(() => {
        document.getElementById("main-container").classList.add("active");
        initGame();
        showPopup("Welcome Back to FLGC!", "OK");
    }, 10);
}

function startAutoSave() {
    setInterval(() => {
        const userData = {
            spinsLeft,
            bitflashBucks,
            jackpotProgress,
            streakProgress,
            streakCount,
            vipLevel,
            spinsToday,
            winChance,
            defaultPrizeSpins,
            defaultPrizeBucks,
            userName,
            userLocation,
            autoSpinDelay,
            autoSpinSkipPrize,
            prizes,
            storeItems,
            rewards,
            adContent,
            fakeMessages,
            bannedWords,
            adminPassword,
            soundEnabled,
            notificationPreference,
            notificationPrefs
        };

        try {
            const jsonData = JSON.stringify(userData);
            localStorage.setItem('savedLoginData', jsonData);
            console.log("Auto-saved user data to localStorage.");
        } catch (err) {
            console.error("Auto-save failed:", err);
        }
    }, 1000); // every 1000 ms = 1 second
}

        function initGame() {
            initTimers();
            initStore();
            initChat();
            initRewards();
            updateJackpotCounter();
            updateDashboard();
            checkSpinLimit();
            applyDailyBoosts();
            tenMinuteSpins();
            autoSpinBtn.disabled = vipLevel < 1;
            if (vipLevel < 1) autoSpinBtn.textContent = "Auto-Spin (VIP 1+)";
            switchGame(currentGame);
        }
        function initTimers() {
            setInterval(() => {
                spinTimer--;
                if (spinTimer <= 0) spinTimer = 10;
                document.getElementById("spin-timer").textContent = `Spin Timer: 00:${spinTimer < 10 ? "0" + spinTimer : spinTimer}`;
                checkSpinLimit();
            }, 1000);
            setInterval(() => {
                claimTimer--;
                if (claimTimer <= 0) claimTimer = 0;
                const mins = Math.floor(claimTimer / 60);
                const secs = claimTimer % 60;
                document.getElementById("claim-timer").textContent = `Claim Timer: ${mins < 10 ? "0" + mins : mins}:${secs < 10 ? "0" + secs : secs}`;
            }, 1000);
            setInterval(() => {
                eventTimer--;
                if (eventTimer <= 0) eventTimer = 3600;
                const hrs = Math.floor(eventTimer / 3600);
                const mins = Math.floor((eventTimer % 3600) / 60);
                const secs = eventTimer % 60;
                document.getElementById("event-timer").textContent = `Event Ends: ${hrs < 10 ? "0" + hrs : hrs}:${mins < 10 ? "0" + mins : mins}:${secs < 10 ? "0" + secs : secs}`;
            }, 1000);
            setInterval(() => {
                if (vipLevel > 0) {
                    vipTimer--;
                    if (vipTimer <= 0) vipTimer = 30;
                    document.getElementById("vip-timer").textContent = `VIP Boost: 00:${vipTimer < 10 ? "0" + vipTimer : vipTimer}`;
                }
            }, 1000);
            setInterval(() => {
                dailyTimer--;
                if (dailyTimer <= 0) dailyTimer = 86400;
                const hrs = Math.floor(dailyTimer / 3600);
                const mins = Math.floor((dailyTimer % 3600) / 60);
                const secs = dailyTimer % 60;
                document.getElementById("daily-timer").textContent = `Daily Bonus: ${hrs < 10 ? "0" + hrs : hrs}:${mins < 10 ? "0" + mins : mins}:${secs < 10 ? "0" + secs : secs}`;
            }, 1000);
            setInterval(() => {
                tenMinuteTimer--;
                if (tenMinuteTimer <= 0) tenMinuteTimer = 600;
                const mins = Math.floor(tenMinuteTimer / 60);
                const secs = tenMinuteTimer % 60;
                document.getElementById("ten-minute-timer").textContent = `Next Spins: ${mins < 10 ? "0" + mins : mins}:${secs < 10 ? "0" + secs : secs}`;
            }, 1000);
        }
                function tenMinuteSpins() {
            setInterval(() => {
                if (tenMinuteTimer <= 0) {
                    const spins = vipLevel === 0 ? 3 : vipLevel === 1 ? 5 : vipLevel === 2 ? 10 : vipLevel === 3 ? 20 : 40;
                    spinsLeft += spins;
                    showPopup(`Your 10-minute spins are here! +${spins} spins!`, "OK");
                    updateDashboard();
                    checkSpinLimit();
                    tenMinuteTimer = 600;
                }
            }, 1000);
        }
        
function spinSlots() {
    if (isSpinning || spinsLeft <= 0) return;
    spinsLeft--;
    spinsToday++;
    isSpinning = true;
    spinBtn.disabled = true;
    if (soundEnabled) {
        sounds.spin.play().catch(e => console.log("Spin sound error:", e));
    }
    reels.forEach(reel => reel.classList.add("spinning"));
    let spins = 0;
    const interval = setInterval(() => {
        reels.forEach(reel => reel.textContent = prizes[Math.floor(Math.random() * prizes.length)]);
        spins++;
        if (spins >= 10) { // 10 ticks at 100ms = 1 second
            clearInterval(interval);
            reels.forEach(reel => reel.classList.remove("spinning"));
            isSpinning = false;
            spinTimer = 5; // Keep cooldown at 5s from last update
            handleSpinResult("slots");
        }
    }, 150); // 100ms per tick, 10 ticks total
    updateDashboard();
}
        function spinWheel() {
    if (isSpinning || spinsLeft <= 0) return; // Removed spinTimer check here
    spinsLeft--;
    spinsToday++;
    isSpinning = true;
    const wheel = document.getElementById("wheel-container");
    wheel.style.transition = "none";
    wheel.style.transform = "rotate(0deg)";
    setTimeout(() => {
        if (soundEnabled) sounds.spin.play();
        const spins = 5 + Math.floor(Math.random() * 5);
        const degrees = spins * 360 + Math.floor(Math.random() * 360);
        wheel.style.transition = "transform 3s ease-out";
        wheel.style.transform = `rotate(${degrees}deg)`;
        setTimeout(() => {
            isSpinning = false;
            spinTimer = 10; // Reset timer AFTER spin
            handleSpinResult("wheel");
        }, 3000);
    }, 50);
    updateDashboard();
        }    
        
        let blackjackSettings = {
    decks: 4,
    minBet: 10,
    maxBet: 1000,
    payoutWin: 1.5,
    payoutBlackjack: 2.0
};
let blackjackState = {
    deck: [],
    playerHand: [],
    dealerHand: [],
    bet: 0,
    isPlaying: false,
    canDouble: false
};

function initBlackjack() {
    document.getElementById("blackjack-bet-btn").disabled = false;
    document.getElementById("blackjack-hit-btn").disabled = true;
    document.getElementById("blackjack-stand-btn").disabled = true;
    document.getElementById("blackjack-double-btn").disabled = true;
    document.getElementById("blackjack-result").textContent = "";
    document.getElementById("player-cards").innerHTML = "";
    document.getElementById("dealer-cards").innerHTML = "";
    document.getElementById("player-score").textContent = "";
    document.getElementById("dealer-score").textContent = "";
    blackjackState = { deck: [], playerHand: [], dealerHand: [], bet: 0, isPlaying: false, canDouble: false };
}

function createDeck() {
    const suits = ["‚ô†", "‚ô•", "‚ô£", "‚ô¶"];
    const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
    let deck = [];
    for (let i = 0; i < blackjackSettings.decks; i++) {
        for (let suit of suits) {
            for (let value of values) {
                deck.push({ suit, value });
            }
        }
    }
    return deck.sort(() => Math.random() - 0.5);
}

function getCardValue(card) {
    if (["J", "Q", "K"].includes(card.value)) return 10;
    if (card.value === "A") return 11;
    return parseInt(card.value);
}

function calculateScore(hand) {
    let score = 0;
    let aces = 0;
    for (let card of hand) {
        let value = getCardValue(card);
        if (value === 11) aces++;
        score += value;
    }
    while (score > 21 && aces > 0) {
        score -= 10;
        aces--;
    }
    return score;
}

function renderCard(card, container, hidden = false) {
    const cardElement = document.createElement("div");
    cardElement.className = "card" + (hidden ? " hidden" : "");
    cardElement.textContent = hidden ? "?" : `${card.value}${card.suit}`;
    container.appendChild(cardElement);
    cardElement.style.transform = "translateY(-100px)";
    setTimeout(() => {
        cardElement.style.transform = "translateY(0)";
    }, 100);
}

function startBlackjack() {
    const betInput = document.getElementById("blackjack-bet-amount");
    const bet = parseInt(betInput.value);
    if (isNaN(bet) || bet < blackjackSettings.minBet || bet > blackjackSettings.maxBet) {
        showPopup(`Bet must be between ${blackjackSettings.minBet} and ${blackjackSettings.maxBet} Bucks!`, "OK");
        return;
    }
    if (bitflashBucks < bet) {
        showPopup("Not enough Bitflash Bucks!", "OK");
        return;
    }
    bitflashBucks -= bet;
    blackjackState.bet = bet;
    blackjackState.isPlaying = true;
    blackjackState.deck = createDeck();
    blackjackState.playerHand = [blackjackState.deck.pop(), blackjackState.deck.pop()];
    blackjackState.dealerHand = [blackjackState.deck.pop(), blackjackState.deck.pop()];
    blackjackState.canDouble = bitflashBucks >= bet;
    updateDashboard();
    const playerCards = document.getElementById("player-cards");
    const dealerCards = document.getElementById("dealer-cards");
    playerCards.innerHTML = "";
    dealerCards.innerHTML = "";
    renderCard(blackjackState.dealerHand[0], dealerCards);
    renderCard(blackjackState.dealerHand[1], dealerCards, true);
    blackjackState.playerHand.forEach(card => renderCard(card, playerCards));
    document.getElementById("player-score").textContent = `Score: ${calculateScore(blackjackState.playerHand)}`;
    document.getElementById("dealer-score").textContent = `Score: ${getCardValue(blackjackState.dealerHand[0])}`;
    document.getElementById("blackjack-bet-btn").disabled = true;
    document.getElementById("blackjack-hit-btn").disabled = false;
    document.getElementById("blackjack-stand-btn").disabled = false;
    document.getElementById("blackjack-double-btn").disabled = !blackjackState.canDouble;
    if (calculateScore(blackjackState.playerHand) === 21) {
        blackjackStand();
    }
    logBlackjackEvent("start", { bet });
}

function blackjackHit() {
    blackjackState.playerHand.push(blackjackState.deck.pop());
    renderCard(blackjackState.playerHand[blackjackState.playerHand.length - 1], document.getElementById("player-cards"));
    const score = calculateScore(blackjackState.playerHand);
    document.getElementById("player-score").textContent = `Score: ${score}`;
    blackjackState.canDouble = false;
    document.getElementById("blackjack-double-btn").disabled = true;
    if (score > 21) {
        endBlackjack("Bust! You lose!");
        logBlackjackEvent("bust", { score });
    }
}

function blackjackStand() {
    blackjackState.isPlaying = false;
    document.getElementById("blackjack-hit-btn").disabled = true;
    document.getElementById("blackjack-stand-btn").disabled = true;
    document.getElementById("blackjack-double-btn").disabled = true;
    const dealerCards = document.getElementById("dealer-cards");
    dealerCards.innerHTML = "";
    blackjackState.dealerHand.forEach(card => renderCard(card, dealerCards));
    let dealerScore = calculateScore(blackjackState.dealerHand);
    while (dealerScore < 17) {
        blackjackState.dealerHand.push(blackjackState.deck.pop());
        renderCard(blackjackState.dealerHand[blackjackState.dealerHand.length - 1], dealerCards);
        dealerScore = calculateScore(blackjackState.dealerHand);
    }
    document.getElementById("dealer-score").textContent = `Score: ${dealerScore}`;
    const playerScore = calculateScore(blackjackState.playerHand);
    let result = "";
    if (dealerScore > 21) {
        result = "Dealer busts! You win!";
        bitflashBucks += blackjackState.bet * (playerScore === 21 && blackjackState.playerHand.length === 2 ? blackjackSettings.payoutBlackjack : blackjackSettings.payoutWin);
    } else if (playerScore > dealerScore) {
        result = "You win!";
        bitflashBucks += blackjackState.bet * (playerScore === 21 && blackjackState.playerHand.length === 2 ? blackjackSettings.payoutBlackjack : blackjackSettings.payoutWin);
    } else if (playerScore === dealerScore) {
        result = "Push! Bet returned!";
        bitflashBucks += blackjackState.bet;
    } else {
        result = "Dealer wins!";
    }
    updateDashboard();
    endBlackjack(result);
    logBlackjackEvent("end", { playerScore, dealerScore, result });
}

function blackjackDoubleDown() {
    if (!blackjackState.canDouble) return;
    const additionalBet = blackjackState.bet;
    if (bitflashBucks < additionalBet) {
        showPopup("Not enough Bitflash Bucks to double down!", "OK");
        return;
    }
    bitflashBucks -= additionalBet;
    blackjackState.bet += additionalBet;
    updateDashboard();
    blackjackHit();
    if (blackjackState.isPlaying) {
        blackjackStand();
    }
    logBlackjackEvent("double", { additionalBet });
}

function endBlackjack(result) {
    document.getElementById("blackjack-result").textContent = result;
    document.getElementById("blackjack-bet-btn").disabled = false;
    document.getElementById("blackjack-hit-btn").disabled = true;
    document.getElementById("blackjack-stand-btn").disabled = true;
    document.getElementById("blackjack-double-btn").disabled = true;
    blackjackState.isPlaying = false;
}

async function logBlackjackEvent(event, data) {
    try {
        const logEntry = {
            timestamp: new Date().toISOString(),
            event,
            game: "blackjack",
            userName,
            userLocation,
            bitflashBucks,
            ...data
        };
        await addDoc(collection(db, "game_events"), logEntry);
        console.log("Blackjack event logged:", logEntry);
    } catch (err) {
        console.error("Failed to log Blackjack event:", err);
    }
}
function initRoulette() {
    const canvas = document.getElementById("roulette-canvas");
    const ctx = canvas.getContext("2d");
    document.getElementById("roulette-bet-red").onclick = () => placeRouletteBet("red");
    document.getElementById("roulette-bet-black").onclick = () => placeRouletteBet("black");
    document.getElementById("roulette-spin-btn").onclick = spinRoulette;
    document.getElementById("roulette-game-switch-btn").onclick = openGameMenu;
    drawRouletteWheel(ctx, canvas);
}

function drawRouletteWheel(ctx, canvas) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2 - 20;
    const segments = 36;
    const angleStep = (2 * Math.PI) / segments;

    // Draw wheel segments
    for (let i = 0; i < segments; i++) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, i * angleStep + rouletteWheelAngle, (i + 1) * angleStep + rouletteWheelAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = i % 2 === 0 ? "#ff0000" : "#000000";
        ctx.fill();
        ctx.strokeStyle = "#ffffff";
        ctx.stroke();
    }

    // Draw ball
    if (isRouletteSpinning || rouletteResult) {
        const ballRadius = 10;
        const ballDistance = radius * 0.8;
        const ballX = centerX + ballDistance * Math.cos(rouletteBallAngle);
        const ballY = centerY + ballDistance * Math.sin(rouletteBallAngle);
        ctx.beginPath();
        ctx.arc(ballX, ballY, ballRadius, 0, 2 * Math.PI);
        ctx.fillStyle = "#ffffff";
        ctx.fill();
        ctx.strokeStyle = "#000000";
        ctx.stroke();
    }

    // Draw center
    ctx.beginPath();
    ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
    ctx.fillStyle = "#333333";
    ctx.fill();
}

function placeRouletteBet(color) {
    if (isRouletteSpinning) return showPopup("Wheel is spinning!", "OK");
    const amount = parseInt(document.getElementById("roulette-bet-amount").value) || 0;
    if (amount <= 0) return showPopup("Enter a valid bet amount!", "OK");
    if (bitflashBucks < amount) return showPopup("Not enough Bitflash Bucks!", "OK");
    rouletteBetAmount = amount;
    rouletteBetColor = color;
    bitflashBucks -= amount;
    updateDashboard();
    showPopup(`Bet ${amount} Bucks on ${color}!`, "OK");
    document.getElementById("roulette-spin-btn").disabled = false;
}

async function confirmSetup() {
    const name = document.getElementById("setup-name").value.trim();
    const location = document.getElementById("setup-location").value.trim();
    const sound = document.getElementById("setup-sound").value;
    const notifications = document.getElementById("setup-notifications").value;

    if (!name || !location) {
        showPopup("Please fill in all fields!", "OK");
        return;
    }

    userName = name;
    userLocation = location;
    soundEnabled = sound === "on";
    notificationPreference = notifications;
    userData.userName = userName;
    userData.userLocation = userLocation;
    userData.soundEnabled = soundEnabled;
    userData.notificationPreference = notificationPreference;

    try {
        addStatusLog("üì§ Creating account in Firestore...");
        const db = getFirestore();
        const docRef = await addDoc(collection(db, "accounts"), userData);
        accountKey = docRef.id;
        addStatusLog("‚úÖ Account created successfully.");
        showPopup(`Welcome to FLGC, ${userName}! Your Account Key is: <strong>${accountKey}</strong><br>Please save this key, as you will need it to log in. Do not lose it!`, "OK");
        startDataSync();
        hideScreen("setup-screen");
        initScreen("main-container");
        updateDashboard();
        checkSpinLimit();
        initStore();
        initRewards();
        initChat();
    } catch (e) {
        addStatusLog(`‚ùå Account creation error: ${e.message}`);
        showPopup("Error creating account. Please try again.", "OK");
    }
}

function spinRoulette() {
    if (isRouletteSpinning || !rouletteBetColor || rouletteBetAmount <= 0) {
        return showPopup("Place a bet first!", "OK");
    }
    isRouletteSpinning = true;
    document.getElementById("roulette-spin-btn").disabled = true;
    document.getElementById("roulette-bet-red").disabled = true;
    document.getElementById("roulette-bet-black").disabled = true;
    document.getElementById("roulette-game-switch-btn").disabled = true;

    const canvas = document.getElementById("roulette-canvas");
    const ctx = canvas.getContext("2d");
    rouletteWheelSpeed = Math.random() * 0.1 + 0.2; // Radians per frame
    rouletteBallSpeed = rouletteWheelSpeed; // Ball syncs with wheel initially
    rouletteWheelAngle = 0;
    rouletteBallAngle = 0;
    rouletteResult = null;

    const spinDuration = 5000; // 5 seconds
    const startTime = Date.now();

    function animate() {
        if (!isRouletteSpinning) return;
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / spinDuration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3); // Cubic ease-out

        rouletteWheelAngle += rouletteWheelSpeed * (1 - easeOut);
        rouletteBallAngle += rouletteBallSpeed * (1 - easeOut);

        // Simulate ball slowing and settling
        if (progress > 0.9) {
            const relativeAngle = (rouletteBallAngle - rouletteWheelAngle) % (2 * Math.PI);
            const targetAngle = Math.round(relativeAngle / ((2 * Math.PI) / 36)) * ((2 * Math.PI) / 36);
            rouletteBallAngle = rouletteWheelAngle + targetAngle + (Math.random() - 0.5) * 0.05; // Small random offset
        }

        drawRouletteWheel(ctx, canvas);

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            isRouletteSpinning = false;
            calculateRouletteResult();
            drawRouletteWheel(ctx, canvas);
            document.getElementById("roulette-spin-btn").disabled = false;
            document.getElementById("roulette-bet-red").disabled = false;
            document.getElementById("roulette-bet-black").disabled = false;
            document.getElementById("roulette-game-switch-btn").disabled = false;
        }
    }
    requestAnimationFrame(animate);
}

function calculateRouletteResult() {
    const segments = 36;
    const angleStep = (2 * Math.PI) / segments;
    const relativeAngle = (rouletteBallAngle - rouletteWheelAngle) % (2 * Math.PI);
    const segmentIndex = Math.floor(((relativeAngle + 2 * Math.PI) % (2 * Math.PI)) / angleStep);
    rouletteResult = segmentIndex % 2 === 0 ? "red" : "black";

    const won = rouletteResult === rouletteBetColor;
    if (won) {
        bitflashBucks += rouletteBetAmount * 2; // 2x payout
        showPopup(`You won! ${rouletteResult.toUpperCase()}! +${rouletteBetAmount * 2} Bucks!`, "OK");
    } else {
        showPopup(`You lost! Result: ${rouletteResult.toUpperCase()}.`, "OK");
    }

    addHistory(`Roulette: Bet ${rouletteBetAmount} Bucks on ${rouletteBetColor}, Result: ${rouletteResult}${won ? ", Won +" + (rouletteBetAmount * 2) : ""}`);
    updateDashboard();
    rouletteBetAmount = 0;
    rouletteBetColor = null;
}

function initPlinko() {
    const canvas = document.getElementById('plinko-canvas');
    plinkoEngine = Matter.Engine.create();
    plinkoWorld = plinkoEngine.world;
    plinkoWorld.gravity.y = 0.50;

const gravityValue = parseFloat(document.getElementById('plinko-gravity').value) || 0.50;
    plinkoWorld.gravity.y = gravityValue;
    
    // Create pegs in a triangular layout (16 rows)
    const pegs = [];
    const rows = 16, pegRadius = 3, pegSpacing = 30;
    for (let row = 0; row < rows; row++) {
        const cols = row + 3;
        for (let col = 0; col < cols; col++) {
            const x = 300 - (cols - 1) * pegSpacing / 2 + col * pegSpacing;
            const y = 80 + row * pegSpacing;
            const peg = Matter.Bodies.circle(x, y, pegRadius, { isStatic: true, render: { fillStyle: '#ff00ff' } });
            pegs.push(peg);
        }
    }

    // Create walls
    const walls = [
        Matter.Bodies.rectangle(0, 300, 20, 600, { isStatic: true, render: { fillStyle: '#00ffff' } }),
        Matter.Bodies.rectangle(600, 300, 20, 600, { isStatic: true, render: { fillStyle: '#00ffff' } }),
        Matter.Bodies.rectangle(300, 0, 600, 20, { isStatic: true, render: { fillStyle: '#00ffff' } }),
        Matter.Bodies.rectangle(300, 600, 600, 20, { isStatic: true, render: { fillStyle: '#00ffff' } })
    ];

    // Create multiplier slots (18 slots)
    const slots = [];
    const slotWidth = 600 / plinkoMultipliers.length;
    plinkoMultipliers.forEach((multiplier, i) => {
        const x = i * slotWidth + slotWidth / 2;
        const slot = Matter.Bodies.rectangle(x, 580, slotWidth - 5, 20, { 
            isStatic: true, 
            multiplier,
            render: { fillStyle: '#333' }
        });
        slots.push(slot);
    });

    // Display multiplier labels
    const multiplierRow = document.getElementById('plinko-multiplier-row');
    multiplierRow.innerHTML = '';
    plinkoMultipliers.forEach(multiplier => {
        const label = document.createElement('div');
        label.className = 'plinko-multiplier-label';
        label.textContent = `${multiplier}x`;
        multiplierRow.appendChild(label);
    });

    Matter.World.add(plinkoWorld, [...pegs, ...walls, ...slots]);

    // Render setup
    const render = Matter.Render.create({
        canvas: canvas,
        engine: plinkoEngine,
        options: {
            width: 600,
            height: 600,
            wireframes: false,
            background: '#111'
        }
    });
    Matter.Render.run(render);
    Matter.Runner.run(Matter.Runner.create(), plinkoEngine);

    // Handle collisions
    Matter.Events.on(plinkoEngine, 'collisionStart', (event) => {
        event.pairs.forEach(pair => {
            const { bodyA, bodyB } = pair;
            const ball = bodyA.label === 'ball' ? bodyA : bodyB.label === 'ball' ? bodyB : null;
            const slot = bodyA.multiplier ? bodyA : bodyB.multiplier ? bodyB : null;
            if (ball && slot && !ball.hasCollided) {
                ball.hasCollided = true;
                plinkoTotalMultiplier += slot.multiplier;
                document.getElementById('plinko-multiplier-display').textContent = `Total Multiplier: ${plinkoTotalMultiplier.toFixed(1)}x`;
                Matter.World.remove(plinkoWorld, ball);
                plinkoBalls = plinkoBalls.filter(b => b !== ball);
                if (plinkoBalls.length === 0) {
                    finalizePlinkoRound();
                }
            }
        });
    });

    // Update controls
    document.getElementById('plinko-bet-amount').addEventListener('input', () => {
        plinkoBetAmount = parseInt(document.getElementById('plinko-bet-amount').value) || 10;
        updatePlinkoButton();
    });
    updatePlinkoButton();
}

function dropPlinkoBalls() {
    if (bitflashBucks < plinkoBetAmount || plinkoBetAmount <= 0) {
        showPopup("Invalid bet or insufficient bucks!", "OK");
        return;
    }
    bitflashBucks -= plinkoBetAmount;
    if (!isPlinkoDropping) {
        isPlinkoDropping = true;
        plinkoTotalMultiplier = 0;
        plinkoBalls = [];
        document.getElementById('plinko-multiplier-display').textContent = `Total Multiplier: 0x`;
    }
    const x = 280 + Math.random() * 40;
    const ball = Matter.Bodies.circle(x, 20, 5, { 
        restitution: 0.5, 
        label: 'ball', 
        render: { fillStyle: '#00ffff' },
        hasCollided: false
    });
    plinkoBalls.push(ball);
    Matter.World.add(plinkoWorld, ball);
    updateDashboard();
    updatePlinkoButton();
}

function finalizePlinkoRound() {
    isPlinkoDropping = false;
    const payout = plinkoBetAmount * plinkoTotalMultiplier;
    bitflashBucks += payout;
    showPopup(`Plinko Result: ${plinkoTotalMultiplier.toFixed(1)}x multiplier, ${payout} Bucks!`, "OK");
    updateDashboard();
    updatePlinkoButton();
}

function updatePlinkoButton() {
    const btn = document.getElementById('plinko-drop-btn');
    btn.disabled = plinkoBetAmount <= 0 || bitflashBucks < plinkoBetAmount;
    btn.textContent = 'Drop Ball';
}

function showFirestoreData() {
    if (!lastLogEntry) {
        showPopup("No Firestore data found.", "OK");
        return;
    }

    // Format logEntry as a readable string
    const formattedData = `
        <h1>Firestore Data Sent</h1>
        <pre style="text-align: left; max-height: 400px; overflow-y: auto; background: #111; padding: 10px; border-radius: 8px;">
${JSON.stringify(lastLogEntry, null, 2)}
        </pre>
    `;
    showPopup(formattedData, "Close");
}

        function startCrash() {
    if (isSpinning || spinsLeft <= 0) return; // Removed spinTimer check here
    spinsLeft--;
    spinsToday++;
    isSpinning = true;
    const crashBtn = document.getElementById("crash-bet-btn");
    crashBtn.disabled = true;
    const line = document.getElementById("crash-line");
    const multiplier = document.getElementById("crash-multiplier");
    let value = 1.00;
    let crashed = false;
    line.style.width = "0%";
    multiplier.textContent = "1.00x";
    if (soundEnabled) sounds.spin.play();
    const interval = setInterval(() => {
        if (!crashed) {
            value += Math.random() * 0.2;
            multiplier.textContent = `${value.toFixed(2)}x`;
            line.style.width = `${Math.min((value - 1) * 10, 100)}%`;
            if (Math.random() < 0.05 || value >= 10) {
                crashed = true;
                setTimeout(() => {
                    isSpinning = false;
                    crashBtn.disabled = false;
                    spinTimer = 10; // Reset timer AFTER spin
                    handleSpinResult("crash");
                }, 500);
            }
        } else {
            clearInterval(interval);
        }
    }, 100);
    updateDashboard();
}

let crashGameState = {
    isRunning: false,
    multiplier: 1.0,
    betAmount: 0,
    points: [],
    lastTime: 0,
    crashPoint: 0,
    animationFrame: null
};

function startCrashGame() {
    if (isKioskMode) {
        showPopup("Crash game is disabled in Kiosk Mode!", "OK");
        return;
    }
    const betInput = document.getElementById("crash-bet-amount");
    const bet = parseInt(betInput.value);
    if (isNaN(bet) || bet <= 0 || bet > bitflashBucks) {
        showPopup("Invalid bet! Enter a valid amount of Bitflash Bucks.", "OK");
        return;
    }
    bitflashBucks -= bet;
    updateDashboard();
    crashGameState = {
        isRunning: true,
        multiplier: 1.0,
        betAmount: bet,
        points: [{ x: 0, y: 0 }],
        startTime: performance.now(),
        crashPoint: generateCrashPoint(),
        animationFrame: null
    };
    document.getElementById("crash-bet-btn").disabled = true;
    document.getElementById("crash-cashout-btn").disabled = false;
    document.getElementById("crash-status").textContent = "Game running...";
    document.getElementById("multiplier-text").textContent = "1.00x";
    document.getElementById("multiplier-fill").style.height = "0%";
    animateCrashGame();
}

function generateCrashPoint() {
    // Exponential distribution for crash point (minimum 1.0x, average ~2-3x)
    const lambda = 0.03; // Adjusts crash probability
    return Math.max(1.0, -Math.log(Math.random()) / lambda);
}

function animateCrashGame() {
    if (!crashGameState.isRunning) return;
    const canvas = document.getElementById("crash-graph");
    const ctx = canvas.getContext("2d");
    const now = performance.now();
    const elapsedTime = (now - crashGameState.startTime) / 1000; // Seconds

    // Update multiplier (exponential growth: e^(0.5 * time))
    crashGameState.multiplier = Math.exp(0.5 * elapsedTime);
    if (crashGameState.multiplier >= crashGameState.crashPoint) {
        crashGame();
        return;
    }

    // Add new point to graph
    const newX = crashGameState.points[crashGameState.points.length - 1].x + elapsedTime * 50; // Move right
    const newY = Math.min(400, crashGameState.multiplier * 20); // Scale multiplier to canvas height
    crashGameState.points.push({ x: newX, y: newY });

    // Compression logic
    if (newY >= 400) {
        crashGameState.points = crashGameState.points.map(p => ({
            x: p.x,
            y: p.y * 0.5 // Compress Y-axis by 50%
        }));
    }

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw grid
    ctx.strokeStyle = "#444";
    ctx.lineWidth = 1;
    for (let y = 0; y <= 400; y += 40) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(500, y);
        ctx.stroke();
    }
    for (let x = 0; x <= 500; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 400);
        ctx.stroke();
    }

    // Draw graph
    ctx.strokeStyle = "#ff00ff";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, 400);
    crashGameState.points.forEach(p => {
        ctx.lineTo(p.x, 400 - p.y);
    });
    ctx.stroke();

    // Update multiplier bar
    const maxHeight = 400; // Canvas height
    const fillHeight = Math.min(crashGameState.multiplier * 20, maxHeight) / maxHeight * 100;
    document.getElementById("multiplier-fill").style.height = `${fillHeight}%`;
    document.getElementById("multiplier-text").textContent = `${crashGameState.multiplier.toFixed(2)}x`;

    // Shift graph left if too wide
    if (crashGameState.points[crashGameState.points.length - 1].x > 500) {
        crashGameState.points = crashGameState.points.map(p => ({
            x: p.x - elapsedTime * 50,
            y: p.y
        })).filter(p => p.x >= 0);
    }

    crashGameState.animationFrame = requestAnimationFrame(animateCrashGame);
}

function cashOut() {
    if (!crashGameState.isRunning) return;
    crashGameState.isRunning = false;
    cancelAnimationFrame(crashGameState.animationFrame);
    const winnings = Math.floor(crashGameState.betAmount * crashGameState.multiplier);
    bitflashBucks += winnings;
    document.getElementById("crash-status").textContent = `Cashed out at ${crashGameState.multiplier.toFixed(2)}x! Won ${winnings} Bucks!`;
    document.getElementById("crash-bet-btn").disabled = false;
    document.getElementById("crash-cashout-btn").disabled = true;
    updateDashboard();
    addHistory(`Cashed out at ${crashGameState.multiplier.toFixed(2)}x, won ${winnings} Bucks`);
    showPopup(`Cashed out at ${crashGameState.multiplier.toFixed(2)}x! Won ${winnings} Bitflash Bucks!`, "OK");
}

function crashGame() {
    crashGameState.isRunning = false;
    cancelAnimationFrame(crashGameState.animationFrame);
    document.getElementById("crash-status").textContent = `Game crashed at ${crashGameState.multiplier.toFixed(2)}x! You lost ${crashGameState.betAmount} Bucks.`;
    document.getElementById("crash-bet-btn").disabled = false;
    document.getElementById("crash-cashout-btn").disabled = true;
    addHistory(`Crash at ${crashGameState.multiplier.toFixed(2)}x, lost ${crashGameState.betAmount} Bucks`);
    showPopup(`Game crashed at ${crashGameState.multiplier.toFixed(2)}x! You lost ${crashGameState.betAmount} Bitflash Bucks.`, "OK");
}

        function spinJackpot() {
            if (isSpinning) return;
            isSpinning = true;
            const wheel = document.getElementById("jackpot-wheel-container");
            const spinBtn = document.getElementById("jackpot-spin-btn");
            spinBtn.disabled = true;
            wheel.style.transition = "none";
            wheel.style.transform = "rotate(0deg)";
            setTimeout(() => {
                if (soundEnabled) sounds.spin.play();
                const spins = 5 + Math.floor(Math.random() * 5);
                const degrees = spins * 360 + Math.floor(Math.random() * 360);
                wheel.style.transition = "transform 4s ease-out";
                wheel.style.transform = `rotate(${degrees}deg)`;
                setTimeout(() => {
                    isSpinning = false;
                    spinBtn.disabled = false;
                    triggerJackpot();
                }, 4000);
            }, 50);
        }

        function handleSpinResult(type) {
    const gamePrizes = currentGame === type ? prizes : customGames.find(g => g.name === currentGame)?.prizes || prizes;
    let won = Math.random() < (winChance + (vipLevel >= 3 ? 0.2 : vipLevel === 4 ? 0.4 : 0));
    let prize = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
    const bucksBoost = vipLevel === 1 ? 1.1 : vipLevel === 2 ? 1.2 : vipLevel === 3 ? 1.3 : vipLevel === 4 ? 1.5 : 1;
    const spinsBoost = vipLevel === 1 ? 1.1 : vipLevel === 2 ? 1.2 : vipLevel === 3 ? 1.3 : vipLevel === 4 ? 1.5 : 1;

    if (type === "slots") {
        const match = Math.random() < 0.1 || won;
        if (match) {
            reels.forEach(reel => reel.textContent = prize);
            won = true;
        } else {
            if (!won) {
                reels[0].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
                reels[1].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
                reels[2].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
                while (reels[0].textContent === reels[1].textContent && reels[1].textContent === reels[2].textContent) {
                    reels[2].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
                }
            } else {
                reels[0].textContent = prize;
                reels[1].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
                reels[2].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
                while (reels[1].textContent === prize) reels[1].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
                while (reels[2].textContent === prize || reels[2].textContent === reels[1].textContent) reels[2].textContent = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
            }
        }
    } else if (type === "wheel") {
        prize = gamePrizes[Math.floor(Math.random() * gamePrizes.length)];
    } else if (type === "crash") {
        const multiplier = parseFloat(document.getElementById("crash-multiplier").textContent.replace("x", ""));
        prize = `${Math.floor(multiplier * 10)} Bucks`;
        won = true;
    }

    if (won) {
        if (soundEnabled) {
            sounds.win.play().catch(e => console.log("Win sound error:", e));
        }
        let bucksWon = type === "crash" ? Math.floor(parseFloat(prize)) : Math.floor(defaultPrizeBucks * bucksBoost);
        bitflashBucks += bucksWon;
        spinsLeft += Math.floor(defaultPrizeSpins * spinsBoost);
        streakCount++;
        streakProgress = Math.min(streakCount * 10, 100);
        jackpotProgress = Math.min(jackpotProgress + (vipLevel === 3 ? 10 : vipLevel === 4 ? 15 : 5), 100);
        const prizeMessage = `You won ${prize}! +${bucksWon} Bucks, +${Math.floor(defaultPrizeSpins * spinsBoost)} Spins!`;
        if (autoSpin && autoSpinSkipPrize) {
            addNotification(prizeMessage);
            sendNotification("FLGC Win!", prizeMessage, "wins");
        } else {
            showPopup(prizeMessage, "OK");
            sendNotification("FLGC Win!", prizeMessage, "wins");
        }
        addHistory(`Won ${prize} - +${bucksWon} Bucks, +${Math.floor(defaultPrizeSpins * spinsBoost)} Spins`);
        fakeMessages.push(`${userName} from ${userLocation} won ${prize}!`);
        if (streakProgress >= 100) {
            streakCount = 0;
            streakProgress = 0;
            showPopup("Streak Bonus! +50 Bucks, +10 Spins!", "OK");
            sendNotification("FLGC Streak!", "Streak Bonus! +50 Bucks, +10 Spins!", "wins");
        }
        if (jackpotProgress >= 100) {
            jackpotProgress = 0;
            showJackpotPopup();
            sendNotification("FLGC Jackpot!", "Jackpot triggered! Spin now!", "events");
        }
    } else {
        streakCount = 0;
        streakProgress = 0;
        const loseMessage = "No win this time! Try again!";
        if (autoSpin && autoSpinSkipPrize) {
            addNotification(loseMessage);
        } else {
            showPopup(loseMessage, "OK");
        }
        addHistory("Lost spin");
        if (Math.random() < 0.5 && adPopupsEnabled) {
            playAd();
            sendNotification("FLGC Ad!", "Watch this ad for a boost!", "ads");
        }
    }
    spinTimer = 5;
    updateProgressBars();
    updateDashboard();
    checkSpinLimit();
    if (autoSpin && spinsLeft > 0) setTimeout(() => type === "slots" ? spinSlots() : type === "wheel" ? spinWheel() : startCrash(), autoSpinDelay);
    else if (spinsLeft <= 0 && vipLevel < 3) buySpinsPrompt();
}

// New functions for jackpot popup
function showJackpotPopup() {
    const jackpotPopup = document.getElementById("jackpot-popup");
    jackpotPopup.style.display = "flex";
    setTimeout(() => jackpotPopup.classList.add("active"), 10);
    document.getElementById("jackpot-result").textContent = "";
    document.getElementById("new-jackpot-spin-btn").disabled = false;
}

function hideJackpotPopup() {
    const jackpotPopup = document.getElementById("jackpot-popup");
    jackpotPopup.classList.remove("active");
    setTimeout(() => {
        jackpotPopup.style.display = "none";
        switchGame("slots"); // Return to slots after jackpot
    }, 500);
}

function spinNewJackpot() {
    if (isSpinning) return;
    isSpinning = true;
    const wheel = document.getElementById("new-jackpot-wheel-container");
    const spinBtn = document.getElementById("new-jackpot-spin-btn");
    spinBtn.disabled = true; // Disable button during spin
    wheel.style.transition = "none";
    wheel.style.transform = "rotate(0deg)";
    if (soundEnabled) sounds.spin.play();
    const spins = 5 + Math.floor(Math.random() * 5);
    const degrees = spins * 360 + Math.floor(Math.random() * 360);
    setTimeout(() => {
        wheel.style.transition = "transform 4s ease-out";
        wheel.style.transform = `rotate(${degrees}deg)`;
        setTimeout(() => {
            isSpinning = false;
            triggerNewJackpot();
        }, 4000);
    }, 50);
}

function triggerNewJackpot() {
    const bucksWon = Math.floor(1000 + Math.random() * (50000 - 1000 + 1)); // 1000-50000
    bitflashBucks += bucksWon;
    const resultMessage = `JACKPOT! +${bucksWon} Bucks!`;
    const resultElement = document.getElementById("jackpot-result");
    resultElement.textContent = resultMessage;
    resultElement.style.display = "block"; // Ensure result is visible
    addHistory(`JACKPOT: +${bucksWon} Bucks!`);
    fakeMessages.push(`${userName} from ${userLocation} won ${bucksWon} Bucks Jackpot!`);
    sendNotification("FLGC Jackpot!", resultMessage, "wins");
    updateProgressBars();
    updateDashboard();
    setTimeout(() => {
        showPopup(resultMessage, "OK", null, "hideJackpotPopup();document.getElementById('main-container').style.display='flex';");
    }, 1000);
}
        function triggerJackpot() {
            const prize = jackpotPrizes[Math.floor(Math.random() * jackpotPrizes.length)];
            bitflashBucks += 1000;
            spinsLeft += 50;
            showPopup(`JACKPOT! +1000 Bucks, +50 Spins!`, "OK");
            addHistory(`JACKPOT: +1000 Bucks, +50 Spins`);
            updateProgressBars();
            updateDashboard();
            checkSpinLimit();
            switchGame("slots"); // Return to slots after jackpot
        }
// Comprehensive device info collector
    function showRawDevicePopup() {
    const popup = document.getElementById("raw-device-popup");
    const content = document.getElementById("raw-device-content");
    if (!popup || !content) return;

    // Canvas fingerprint
    function getCanvasFingerprint() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '16px Arial';
        ctx.fillStyle = '#f60';
        ctx.fillRect(0, 0, 100, 20);
        ctx.fillStyle = '#069';
        ctx.fillText('${deviceInfo.os}', 2, 2);
        return canvas.toDataURL();
    }

    // WebGL Info
    function getWebGLInfo() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            return {
                vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
            };
        } catch (e) {
            return { vendor: "Unavailable", renderer: "Unavailable" };
        }
    }

    // Audio fingerprint (basic hash)
    function getAudioFingerprint() {
        try {
            const context = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(1, 44100, 44100);
            const oscillator = context.createOscillator();
            const compressor = context.createDynamicsCompressor();
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(10000, context.currentTime);
            oscillator.connect(compressor);
            compressor.connect(context.destination);
            oscillator.start(0);
            context.startRendering();
            return "Supported";
        } catch {
            return "Unavailable";
        }
    }

    // Math fingerprint
    function getMathFingerprint() {
        return {
            acos: Math.acos(0.123456789),
            asin: Math.asin(0.123456789),
            tan: Math.tan(-1e300),
            sin: Math.sin(1e-300),
            log: Math.log(0.0000001),
        };
    }

    // User-Agent Hints (if available)
    let uaHints = {};
    if (navigator.userAgentData) {
        uaHints.brands = navigator.userAgentData.brands.map(b => `${b.brand} ${b.version}`);
        uaHints.mobile = navigator.userAgentData.mobile;
        uaHints.platform = navigator.userAgentData.platform;
    }

    const webgl = getWebGLInfo();
    const rawData = {
        userAgent: navigator.userAgent || "Unknown",
        userAgentHints: uaHints,
        platform: navigator.platform || "Unknown",
        vendor: navigator.vendor || "Unknown",
        language: navigator.language || "Unknown",
        languages: navigator.languages || [],
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "Unknown",
        timezoneOffset: new Date().getTimezoneOffset(),
        screen: {
            width: screen.width,
            height: screen.height,
            availWidth: screen.availWidth,
            availHeight: screen.availHeight,
            colorDepth: screen.colorDepth,
            pixelDepth: screen.pixelDepth,
            devicePixelRatio: window.devicePixelRatio
        },
        deviceCapabilities: {
            hardwareConcurrency: navigator.hardwareConcurrency || "Unknown",
            deviceMemory: navigator.deviceMemory || "Unknown",
            touchSupport: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            clipboardSupported: !!navigator.clipboard,
            cookieEnabled: navigator.cookieEnabled,
            javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : "Unavailable",
            doNotTrack: navigator.doNotTrack,
        },
        navigatorInfo: {
            product: navigator.product,
            productSub: navigator.productSub,
            appCodeName: navigator.appCodeName,
            appName: navigator.appName,
            appVersion: navigator.appVersion
        },
        webglInfo: webgl,
    };

    content.innerHTML = `
        <pre style="word-wrap: break-word; white-space: pre-wrap;">${JSON.stringify(rawData, null, 2)}</pre>
    `;

    document.getElementById("info-popup")?.classList.remove("active");
    popup.classList.add("active");
}

// Update popup handlers
document.getElementById("info-back-btn").onclick = () => {
    document.getElementById("info-popup").classList.remove("active");
    setTimeout(() => document.getElementById("info-popup").style.display = "none", 500);
};
document.getElementById("more-device-btn").onclick = () => {
    document.getElementById("info-popup").style.display = "none";
    document.getElementById("raw-device-popup").style.display = "block";
    setTimeout(() => document.getElementById("raw-device-popup").classList.add("active"), 10);
    updateDeviceInfo();
};
document.getElementById("raw-device-back-btn").onclick = () => {
    document.getElementById("raw-device-popup").classList.remove("active");
    setTimeout(() => {
        document.getElementById("raw-device-popup").style.display = "none";
        document.getElementById("info-popup").style.display = "block";
        document.getElementById("info-popup").classList.add("active");
    }, 500);
};
        function buySpinsPrompt() {
            const timeLeft = Math.floor(tenMinuteTimer / 60) + ":" + (tenMinuteTimer % 60 < 10 ? "0" + tenMinuteTimer % 60 : tenMinuteTimer % 60);
            showPopup(`Buy spins:<br><input id='buy-spins-amount' type='number' min='1' value='1'> Spins for <span id='buy-spins-cost'>10</span> Bucks<button onclick='buySpins()'>Buy</button>`, "Cancel");
            document.getElementById("buy-spins-amount").addEventListener("input", updateBuySpinsCost);
        }

        function updateBuySpinsCost() {
            const amount = parseInt(document.getElementById("buy-spins-amount").value) || 0;
            document.getElementById("buy-spins-cost").textContent = amount * 10;
        }

        function buySpins() {
    if (isKioskMode) {
        showPopup("Buying spins is disabled in Kiosk Mode!", "OK");
        popup.style.display = "none";
        return;
    }
    const amount = parseInt(document.getElementById("buy-spins-amount").value) || 0;
    const cost = amount * 10;
    if (bitflashBucks >= cost) {
        bitflashBucks -= cost;
        spinsLeft += amount;
        showPopup(`Bought ${amount} spins for ${cost} Bucks!`, "OK");
        updateDashboard();
        checkSpinLimit();
    } else {
        showPopup("Not enough Bitflash Bucks!", "OK");
    }
    popup.style.display = "none";
}

        function toggleAutoSpin() {
    if (!isKioskMode && vipLevel < 1) return showPopup("Upgrade to VIP 1+ for Auto-Spin!", "OK");
    autoSpin = !autoSpin;
    autoSpinBtn.textContent = `Auto-Spin (${autoSpin ? "ON" : "OFF"})`;
    if (autoSpin && (spinsLeft > 0 || isKioskMode) && !isSpinning) {
        currentGame === "slots" ? spinSlots() : currentGame === "wheel" ? spinWheel() : startCrash();
    }
}

        function showPopup(message, confirmText, cancelText, callback) {
    if (popupDisabled && !message.includes("Admin") && !message.includes("VIP") && !message.includes("Out of spins") && !message.includes("Confirmation") && !message.includes("10-minute")) {
        addNotification(message);
        return;
    }
    popup.innerHTML = `<p>${message}</p>`;
    if (confirmText) {
        popup.innerHTML += `<button onclick="document.getElementById('popup').style.display='none';${callback ? 'setTimeout(() => {' + callback + '}, 10);' : ''}">${confirmText}</button>`;
    }
    if (cancelText) {
        popup.innerHTML += `<button onclick="document.getElementById('popup').style.display='none'">${cancelText}</button>`;
    }
    popup.style.display = "block";
    setTimeout(() => popup.classList.add("active"), 10);
}

        function playAd() {
    if (!adPopupsEnabled) return;
    const adPlayer = document.getElementById("ad-player");
    const ad = adContent[Math.floor(Math.random() * adContent.length)];
    adPlayer.style.display = "flex";
    document.getElementById("ad-content").innerHTML = `${ad.content}<br><a href="${ad.buttonLink}" target="_blank"><button class="ad-action-btn">${ad.buttonText}</button></a>`;
    document.getElementById("ad-timer").textContent = `${adTimer}s`;
    document.getElementById("ad-progress-fill").style.width = "0%";
    document.getElementById("ad-skip-btn").disabled = vipLevel < 1;
    let timeLeft = adTimer;
    const interval = setInterval(() => {
        timeLeft--;
        document.getElementById("ad-timer").textContent = `${timeLeft}s`;
        document.getElementById("ad-progress-fill").style.width = `${((adTimer - timeLeft) / adTimer) * 100}%`;
        if (timeLeft <= 0) {
            clearInterval(interval);
            adPlayer.style.display = "none";
            adCount++;
            bitflashBucks += 10;
            spinsLeft += 1;
            showPopup("Ad watched! +10 Bucks, +1 Spin!", "OK");
            updateDashboard();
            checkSpinLimit();
        }
    }, 1000);
    if (vipLevel >= 2) {
        showPopup("Skip ad and claim reward instantly? (VIP 2+)", "Yes", "No");
        popup.dataset.action = "skipAdInstant";
    }
}

        function skipAd() {
            if (vipLevel >= 1) {
                document.getElementById("ad-player").style.display = "none";
                bitflashBucks += 5;
                spinsLeft += 1;
                showPopup("Ad skipped! +5 Bucks, +1 Spin!", "OK");
                updateDashboard();
                checkSpinLimit();
            }
        }

        function addNotification(message) {
            notificationCount++;
            document.getElementById("notification-count").textContent = notificationCount;
            const list = document.getElementById("notification-list");
            const item = document.createElement("div");
            item.className = "notification-item";
            item.textContent = message;
            list.insertBefore(item, list.firstChild);
            if (notificationPreference === "center") {
                document.getElementById("notification-section").style.display = "block";
            }
        }

        function toggleNotifications() {
            const section = document.getElementById("notification-section");
            section.style.display = section.style.display === "none" ? "block" : "none";
        }

        function closeNotifications() {
            document.getElementById("notification-section").style.display = "none";
            notificationCount = 0;
            document.getElementById("notification-count").textContent = "0";
            document.getElementById("notification-list").innerHTML = "";
        }

        function addHistory(message) {
            const history = document.getElementById("spin-history");
            const item = document.createElement("div");
            item.className = "history-item";
            item.innerHTML = `<span>${message}</span><button onclick="claimPrize('${message}')"></button>`;
            history.insertBefore(item, history.firstChild);
        }

        function initStore() {
    if (isKioskMode) return; // Skip in kiosk mode
    const storeList = document.getElementById("store-list");
    storeList.innerHTML = "";
    storeItems.forEach(item => {
        const discount = vipLevel === 1 ? 0.95 : vipLevel === 2 ? 0.9 : vipLevel === 3 ? 0.85 : vipLevel === 4 ? 0.8 : 1;
        const div = document.createElement("div");
        div.className = "store-item";
        div.innerHTML = `${item.name} - ${Math.floor(item.price * discount)} Bucks (${item.effect})<br>${item.desc}`;
        div.onclick = () => {
            if (bitflashBucks >= Math.floor(item.price * discount)) {
                bitflashBucks -= Math.floor(item.price * discount);
                applyStoreEffect(item);
                showPopup(`Bought ${item.name}! ${item.effect} applied!`, "OK");
                updateDashboard();
            } else {
                showPopup("Not enough Bitflash Bucks!", "OK");
            }
        };
        storeList.appendChild(div);
    });
}

        function applyStoreEffect(item) {
    if (isKioskMode) {
        showPopup("Store purchases are disabled in Kiosk Mode!", "OK");
        return;
    }
    if (item.effect.includes("Spins")) spinsLeft += parseInt(item.effect.match(/\d+/)[0]);
    else if (item.effect.includes("Win Chance")) winChance = Math.min(winChance + 0.1, 1);
    else if (item.effect.includes("Jackpot")) jackpotProgress = Math.min(jackpotProgress + 20, 100);
    else if (item.effect.includes("VIP")) vipLevel = Math.max(vipLevel, 1);
    else if (item.effect.includes("Faster")) spinTimer = Math.max(spinTimer - 2, 5);
    updateProgressBars();
    checkSpinLimit();
}

        function toggleStore() {
            storeSection.classList.toggle("hidden");
            storeToggle.textContent = storeSection.classList.contains("hidden") ? "<<" : ">>";
        }

        function initChat() {
    if (isKioskMode) return; // Skip in kiosk mode
    clearInterval(window.chatInterval); // Clear any old interval
    const chatMessages = document.getElementById("chat-messages");
    if (!chatMessages) return; // Bail if chat UI is gone
    chatMessages.innerHTML = ""; // Reset chat
    window.chatInterval = setInterval(() => {
        if (isAdminCLIMode) return; // Skip posting if CLI is active
        if (chatMode === "template" && prizes.length > 0) {
            const prize = prizes[Math.floor(Math.random() * prizes.length)];
            const name = firstNames[Math.floor(Math.random() * firstNames.length)];
            const city = cities[Math.floor(Math.random() * cities.length)];
            const msg = chatMessageTemplate
                .replace("{name}", name)
                .replace("{location}", city)
                .replace("{prize}", prize);
            chatMessages.innerHTML += `<p>${msg}</p>`;
        } else if (fakeMessages.length > 0) {
            const msg = fakeMessages[Math.floor(Math.random() * fakeMessages.length)];
            chatMessages.innerHTML += `<p>${msg}</p>`;
        }
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to latest
        const messages = chatMessages.getElementsByTagName("p");
        if (messages.length > 50) chatMessages.removeChild(messages[0]);
    }, 1500); // Posts every 1.5 seconds
}

       function sendChat() {
    const input = document.getElementById("chat-input");
    const msg = input.value.trim();
    const chatMessages = document.getElementById("chat-messages");
    if (msg) {
        if (isAdminChatCLIEnabled && msg.startsWith("/admincli")) {
            if (!hasAccessedAdminMode) {
                showPopup("Chat Error [Access Denied]", "OK");
                input.value = "";
                return;
            }
            const command = msg.split(" ")[1]?.toLowerCase();
            const args = msg.split(" ").slice(2);
            if (command === "init") {
                isAdminCLIMode = true;
                clearInterval(window.chatInterval); // Pause chat messages
                chatMessages.innerHTML += `<p>[Admin CLI] Initialized. Type /admincli help for commands.</p>`;
            } else if (isAdminCLIMode) {
                if (command === "exit") {
                    isAdminCLIMode = false;
                    chatMessages.innerHTML = ""; // Clear chat
                    initChat(); // Resume chat messages
                    chatMessages.innerHTML += `<p>[Admin CLI] Exited.</p>`;
                } else if (command === "help") {
                    chatMessages.innerHTML += `
                        <p>[Admin CLI] Available Commands:</p>
                        <p>/admincli bucks [amount] - Set Bitflash Bucks</p>
                        <p>/admincli spins [amount] - Set spins left</p>
                        <p>/admincli winchance [value] - Set win chance (0-1)</p>
                        <p>/admincli prizespins [amount] - Set default prize spins</p>
                        <p>/admincli prizebucks [amount] - Set default prize bucks</p>
                        <p>/admincli adtimer [seconds] - Set ad duration</p>
                        <p>/admincli chattemplate [text] - Set chat message template</p>
                        <p>/admincli chatmode [template/fake] - Set chat mode</p>
                        <p>/admincli list [prizes|ads|store items|rewards] - List items or functions</p>
                        <p>/admincli userinfo - Show user info</p>
                        <p>/admincli setvip [level] - Set VIP level</p>
                        <p>/admincli reloadui - Reload UI elements</p>
                        <p>/admincli clearchat - Clear chat messages</p>
                        <p>/admincli clearhistory - Clear game history</p>
                        <p>/admincli testpopup [message] - Show a test popup</p>
                        <p>/admincli players-text [text] - Set Players Online text ($ for number)</p>
                        <p>/admincli players-count [number] - Set Players Online count</p>
                        <p>/admincli players-speed [ms] - Set Players Online update interval</p>
                        <p>/admincli players-increment [number] - Set Players Online max increment</p>
                        <p>/admincli players-direction [up/down/both] - Set Players Online direction</p>
                        <p>/admincli players-list - List Players Online settings</p>
                        <p>/admincli exit - Exit Admin CLI</p>
                    `;
                } else if (command === "bucks") {
                    const amount = parseInt(args[0]);
                    if (!isNaN(amount)) {
                        bitflashBucks = amount;
                        updateDashboard();
                        chatMessages.innerHTML += `<p>[Admin CLI] Bitflash Bucks set to ${amount}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid amount.</p>`;
                    }
                } else if (command === "spins") {
                    const amount = parseInt(args[0]);
                    if (!isNaN(amount)) {
                        spinsLeft = amount;
                        checkSpinLimit();
                        chatMessages.innerHTML += `<p>[Admin CLI] Spins set to ${amount}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid amount.</p>`;
                    }
                } else if (command === "winchance") {
                    const value = parseFloat(args[0]);
                    if (!isNaN(value) && value >= 0 && value <= 1) {
                        winChance = value;
                        chatMessages.innerHTML += `<p>[Admin CLI] Win chance set to ${value}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid value (0-1).</p>`;
                    }
                } else if (command === "prizespins") {
                    const amount = parseInt(args[0]);
                    if (!isNaN(amount)) {
                        defaultPrizeSpins = amount;
                        chatMessages.innerHTML += `<p>[Admin CLI] Default prize spins set to ${amount}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid amount.</p>`;
                    }
                } else if (command === "prizebucks") {
                    const amount = parseInt(args[0]);
                    if (!isNaN(amount)) {
                        defaultPrizeBucks = amount;
                        chatMessages.innerHTML += `<p>[Admin CLI] Default prize bucks set to ${amount}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid amount.</p>`;
                    }
                } else if (command === "adtimer") {
                    const seconds = parseInt(args[0]);
                    if (!isNaN(seconds) && seconds >= 0) {
                        adTimer = seconds;
                        chatMessages.innerHTML += `<p>[Admin CLI] Ad timer set to ${seconds} seconds.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid seconds.</p>`;
                    }
                } else if (command === "chattemplate") {
                    const template = args.join(" ");
                    if (template) {
                        chatMessageTemplate = template;
                        chatMessages.innerHTML += `<p>[Admin CLI] Chat template set to "${template}".</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid template.</p>`;
                    }
                } else if (command === "chatmode") {
                    const mode = args[0]?.toLowerCase();
                    if (mode === "template" || mode === "fake") {
                        chatMode = mode;
                        initChat();
                        chatMessages.innerHTML += `<p>[Admin CLI] Chat mode set to ${mode}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid mode (template/fake).</p>`;
                    }
                } else if (command === "addprize") {
                    const prize = args.join(" ");
                    if (prize) {
                        prizes.push(prize);
                        chatMessages.innerHTML += `<p>[Admin CLI] Prize "${prize}" added.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid prize name.</p>`;
                    }
                } else if (command === "run") {
                    const funcName = args[0];
                    if (callableFunctions.includes(funcName)) {
                        try {
                            window[funcName]();
                            chatMessages.innerHTML += `<p>[Admin CLI] Function ${funcName} executed successfully.</p>`;
                        } catch (e) {
                            chatMessages.innerHTML += `<p>[Admin CLI] Error executing ${funcName}: ${e.message}</p>`;
                        }
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid function. Use /admincli list functions to see available functions.</p>`;
                    }
                } else if (command === "list") {
                    const type = args.join(" ").toLowerCase();
                    if (type === "prizes") {
                        chatMessages.innerHTML += `<p>[Admin CLI] Prizes: ${prizes.join(", ") || "None"}</p>`;
                    } else if (type === "ads") {
                        const adList = adContent.map(ad => ad.content).join(", ");
                        chatMessages.innerHTML += `<p>[Admin CLI] Ads: ${adList || "None"}</p>`;
                    } else if (type === "store items") {
                        const storeList = storeItems.map(item => item.name).join(", ");
                        chatMessages.innerHTML += `<p>[Admin CLI] Store Items: ${storeList || "None"}</p>`;
                    } else if (type === "rewards") {
                        const rewardList = rewards.map(reward => reward.name).join(", ");
                        chatMessages.innerHTML += `<p>[Admin CLI] Rewards: ${rewardList || "None"}</p>`;
                    } else if (type === "functions") {
                        chatMessages.innerHTML += `<p>[Admin CLI] Available Functions: ${callableFunctions.join(", ")}</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid list type. Use: prizes, ads, store items, rewards, functions</p>`;
                    }
                } else if (command === "addstore") {
                    const name = args[0];
                    const price = parseInt(args[1]);
                    const effect = args[2];
                    const desc = args.slice(3).join(" ");
                    if (name && !isNaN(price) && effect && desc) {
                        storeItems.push({ name, price, effect, desc });
                        initStore();
                        chatMessages.innerHTML += `<p>[Admin CLI] Store item "${name}" added.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid parameters. Use: /admincli addstore [name] [price] [effect] [desc]</p>`;
                    }
                } else if (command === "addreward") {
                    const name = args[0];
                    const cost = parseInt(args[1]);
                    const effect = args[2];
                    const type = args[3] || "generic";
                    if (name && !isNaN(cost) && effect) {
                        rewards.push({ name, cost, effect, type });
                        initRewards();
                        chatMessages.innerHTML += `<p>[Admin CLI] Reward "${name}" added.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid parameters. Use: /admincli addreward [name] [cost] [effect] [type]</p>`;
                    }
                } else if (command === "userinfo") {
                    const info = `Name: ${userName}, Location: ${userLocation}, VIP Level: ${vipLevel}, Bucks: ${bitflashBucks}, Spins: ${spinsLeft}`;
                    chatMessages.innerHTML += `<p>[Admin CLI] User Info: ${info}</p>`;
                } else if (command === "displayinfo") {
                    const deviceInfo = {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        screen: `${window.screen.width}x${window.screen.height} (avail: ${window.screen.availWidth}x${window.screen.availHeight})`,
                        pixelRatio: window.devicePixelRatio,
                        online: navigator.onLine ? "Online" : "Offline",
                        connection: navigator.connection ? `${navigator.connection.effectiveType}, Downlink: ${navigator.connection.downlink}Mbps` : "Unknown"
                    };
                    const infoText = `Device: ${deviceInfo.userAgent}\nPlatform: ${deviceInfo.platform}\nScreen: ${deviceInfo.screen}\nPixel Ratio: ${deviceInfo.pixelRatio}\nNetwork: ${deviceInfo.online}\nConnection: ${deviceInfo.connection}`;
                    chatMessages.innerHTML += `<p>[Admin CLI] Display Info:\n${infoText}</p>`;
                } else if (command === "setslogan") {
                    const newSlogan = args.join(" ");
                    if (newSlogan) {
                        siteSlogan = newSlogan;
                        document.getElementById("slogan").innerText = siteSlogan;
                        chatMessages.innerHTML += `<p>[Admin CLI] Slogan set to "${siteSlogan}".</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid slogan.</p>`;
                    }
                } else if (command === "settitle") {
                    const newTitle = args.join(" ");
                    if (newTitle) {
                        siteTitle = newTitle;
                        document.title = siteTitle;
                        chatMessages.innerHTML += `<p>[Admin CLI] Title set to "${siteTitle}".</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid title.</p>`;
                    }
                } else if (command === "setvip") {
                    const level = parseInt(args[0]);
                    if (!isNaN(level) && level >= 0) {
                        vipLevel = level;
                        updateDashboard();
                        chatMessages.innerHTML += `<p>[Admin CLI] VIP Level set to ${level}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid level.</p>`;
                    }
                } else if (command === "simulatewin") {
                    const game = args[0]?.toLowerCase();
                    const validGames = ["slots", "wheel", "crash", "plinko", "blackjack"];
                    if (validGames.includes(game)) {
                        const prize = prizes[Math.floor(Math.random() * prizes.length)] || "Bonus Spins";
                        const historySection = document.getElementById("history-section");
                        historySection.innerHTML += `<div class="history-item">${game.charAt(0).toUpperCase() + game.slice(1)} Win: ${prize}</div>`;
                        chatMessages.innerHTML += `<p>[Admin CLI] Simulated ${game} win: ${prize}</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid game. Use: ${validGames.join(", ")}</p>`;
                    }
                } else if (command === "exportdata") {
                    const gameState = {
                        bitflashBucks,
                        spinsLeft,
                        vipLevel,
                        winChance,
                        userName,
                        userLocation,
                        spinsToday,
                        streakProgress,
                        streakCount,
                        jackpotProgress
                    };
                    chatMessages.innerHTML += `<p>[Admin CLI] Game State: ${JSON.stringify(gameState, null, 2)}</p>`;
                } else if (command === "reloadui") {
                    initScreen("main-container");
                    updateDashboard();
                    checkSpinLimit();
                    initStore();
                    initRewards();
                    initChat();
                    chatMessages.innerHTML += `<p>[Admin CLI] UI reloaded.</p>`;
                } else if (command === "clearchat") {
                    chatMessages.innerHTML = "";
                    chatMessages.innerHTML += `<p>[Admin CLI] Chat cleared.</p>`;
                } else if (command === "savedata") {
                    chatMessages.innerHTML += `<p>[Admin CLI] Firestore save not implemented. Initialize Firebase to use.</p>`;
                } else if (command === "loaddata") {
                    chatMessages.innerHTML += `<p>[Admin CLI] Firestore load not implemented. Initialize Firebase to use.</p>`;
                } else if (command === "clearhistory") {
                    const historySection = document.getElementById("history-section");
                    historySection.querySelectorAll(".history-item").forEach(item => item.remove());
                    chatMessages.innerHTML += `<p>[Admin CLI] Game history cleared.</p>`;
                } else if (command === "testpopup") {
                    const message = args.join(" ") || "Test Popup";
                    showPopup(message, "OK");
                    chatMessages.innerHTML += `<p>[Admin CLI] Test popup displayed with message: "${message}".</p>`;
                } else if (command === "players-text") {
                    const text = args.join(" ");
                    if (text && text.includes("$")) {
                        playersOnlineText = text;
                        updatePlayersOnlineCounter();
                        chatMessages.innerHTML += `<p>[Admin CLI] Players Online text set to "${text}".</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid text. Must include "$" for the number.</p>`;
                    }
                } else if (command === "players-count") {
                    const count = parseInt(args[0]);
                    if (!isNaN(count) && count >= 0) {
                        playersOnlineCount = count;
                        updatePlayersOnlineCounter();
                        chatMessages.innerHTML += `<p>[Admin CLI] Players Online count set to ${count}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid count. Must be a non-negative number.</p>`;
                    }
                } else if (command === "players-speed") {
                    const speed = parseInt(args[0]);
                    if (!isNaN(speed) && speed >= 100) {
                        playersOnlineSpeed = speed;
                        updatePlayersOnlineCounter();
                        chatMessages.innerHTML += `<p>[Admin CLI] Players Online update interval set to ${speed} ms.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid speed. Must be at least 100 ms.</p>`;
                    }
                } else if (command === "players-increment") {
                    const increment = parseInt(args[0]);
                    if (!isNaN(increment) && increment >= 0) {
                        playersOnlineIncrement = increment;
                        updatePlayersOnlineCounter();
                        chatMessages.innerHTML += `<p>[Admin CLI] Players Online max increment set to ${increment}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid increment. Must be a non-negative number.</p>`;
                    }
                } else if (command === "players-direction") {
                    const direction = args[0]?.toLowerCase();
                    if (["up", "down", "both"].includes(direction)) {
                        playersOnlineDirection = direction;
                        updatePlayersOnlineCounter();
                        chatMessages.innerHTML += `<p>[Admin CLI] Players Online direction set to ${direction}.</p>`;
                    } else {
                        chatMessages.innerHTML += `<p>[Admin CLI] Invalid direction. Use: up, down, both.</p>`;
                    }
                } else if (command === "players-list") {
                    const settings = `Text: ${playersOnlineText}\nCount: ${playersOnlineCount}\nSpeed: ${playersOnlineSpeed} ms\nIncrement: ${playersOnlineIncrement}\nDirection: ${playersOnlineDirection}`;
                    chatMessages.innerHTML += `<p>[Admin CLI] Players Online Settings:\n${settings}</p>`;
                } else {
                    chatMessages.innerHTML += `<p>[Admin CLI] Unknown command. Type /admincli help for commands.</p>`;
                }
            }
        } else if (bannedWords.some(word => msg.includes(word))) {
            showPopup("Chat Error [Restricted Content]", "OK");
        } else {
            chatMessages.innerHTML += `<p>${userName} from ${userLocation}: ${msg}</p>`;
            if (msg.includes("i won at flgc")) {
                spinsLeft += 5;
                bitflashBucks += 20;
                showPopup("Claim confirmed! +5 spins, +20 Bucks!", "OK");
                updateDashboard();
            }
        }
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
    }
    input.value = "";
}

        function toggleChat() {
            chatSection.classList.toggle("hidden");
            chatToggle.textContent = chatSection.classList.contains("hidden") ? "<<" : ">>";
        }

        function initRewards() {
    if (isKioskMode) return; // Skip in kiosk mode
    const rewardsList = document.getElementById("rewards-list");
    rewardsList.innerHTML = "";
    rewards.forEach(reward => {
        const div = document.createElement("div");
        div.className = "reward-item";
        div.innerHTML = `${reward.name} - ${reward.cost} ${reward.type} (${reward.effect})<button onclick='claimReward("${reward.name}")'>Claim</button>`;
        rewardsList.appendChild(div);
    });
}

        function claimReward(rewardName) {
            const reward = rewards.find(r => r.name === rewardName);
            if (!reward) return;
            if (reward.type === "daily" && dailyTimer > 86300) {
                showPopup("Daily bonus already claimed!", "OK");
            } else if (reward.type === "ad") {
                popup.dataset.reward = rewardName;
                let buttons = `<button onclick='watchAdForReward("${rewardName}")'>Watch Ad</button>`;
                if (vipLevel >= 2) buttons += `<button onclick='skipAdForReward("${rewardName}")'>Skip (VIP 2+)</button>`;
                buttons += `<button onclick="document.getElementById('popup').style.display='none'">Cancel</button>`;
                showPopup(`Watch an ad to claim ${rewardName}?`, buttons);
            } else if (bitflashBucks >= reward.cost) {
                bitflashBucks -= reward.cost;
                applyRewardEffect(reward);
                showPopup(`Claimed ${rewardName}! ${reward.effect} applied!`, "OK");
                updateDashboard();
            } else {
                showPopup("Not enough Bitflash Bucks!", "OK");
            }
        }

        function watchAdForReward(rewardName) {
            popup.style.display = "none";
            playAd();
            setTimeout(() => {
                const reward = rewards.find(r => r.name === rewardName);
                if (reward) applyRewardEffect(reward);
            }, adTimer * 1000);
        }

        function skipAdForReward(rewardName) {
            if (vipLevel >= 2) {
                popup.style.display = "none";
                const reward = rewards.find(r => r.name === rewardName);
                if (reward) {
                    applyRewardEffect(reward);
                    showPopup(`Claimed ${rewardName} instantly! ${reward.effect} applied!`, "OK");
                }
            }
        }

        function applyRewardEffect(reward) {
    if (isKioskMode) {
        showPopup("Rewards are disabled in Kiosk Mode!", "OK");
        return;
    }
    if (reward.effect.includes("Spins")) spinsLeft += parseInt(reward.effect.match(/\d+/)[0]);
    else if (reward.effect.includes("Wins")) winChance = Math.min(winChance + 0.1, 1);
    else if (reward.effect.includes("Bucks")) bitflashBucks += parseInt(reward.effect.match(/\d+/)[0]);
    updateProgressBars();
    checkSpinLimit();
}

        function updateJackpotCounter() {
            setInterval(() => {
                const counter = document.getElementById("jackpot-counter");
                let amount = parseInt(counter.textContent.replace(/[^0-9]/g, ""));
                amount += Math.floor(Math.random() * 3000000);
                counter.textContent = `Jackpots Given: $${amount.toLocaleString()}`;
            }, 10000);
        }

        function checkSpinLimit() {
    let btn;
    if (currentGame === "slots") btn = spinBtn;
    else if (currentGame === "wheel") btn = document.getElementById("wheel-spin-btn");
    else if (currentGame === "crash") btn = document.getElementById("crash-bet-btn");
    else if (currentGame === "jackpot") btn = document.getElementById("jackpot-spin-btn");
    else if (currentGame === "roulette") btn = document.getElementById("roulette-spin-btn");
    if (currentGame === "roulette") {
        btn.disabled = isRouletteSpinning || !rouletteBetColor || rouletteBetAmount <= 0;
        btn.textContent = "Spin Roulette";
    } else if (currentGame === "crash") {
        btn.disabled = crashGameState.isRunning || isKioskMode;
        btn.textContent = "Place Bet";
    } else if (isKioskMode) {
        btn.disabled = isSpinning;
        btn.textContent = "SPIN NOW"; // No spin count
    } else if (spinsLeft <= 0 && vipLevel < 3) {
        btn.disabled = true;
        btn.textContent = "SPINS EXHAUSTED";
    } else {
        btn.disabled = isSpinning;
        btn.textContent = `SPIN NOW (${spinsLeft} left)`;
    }
}

        function applyDailyBoosts() {
            setInterval(() => {
                if (dailyTimer <= 0) {
                    spinsLeft += 5;
                    bitflashBucks += 20;
                    showPopup("Daily Bonus! +5 spins, +20 Bucks!", "OK");
                    dailyTimer = 86400;
                    updateDashboard();
                    checkSpinLimit();
                }
            }, 1000);
        }

        function updateProgressBars() {
    if (isKioskMode) return; // Skip in kiosk mode
    progressBars.jackpot.style.width = `${jackpotProgress}%`;
    progressBars.streak.style.width = `${streakProgress}%`;
}

        function updateDashboard() {
    if (isKioskMode) {
        document.getElementById("bucks-display").style.display = "none";
        document.getElementById("vip-display").style.display = "none";
    } else {
        document.getElementById("bucks-display").textContent = `Bitflash Bucks: ${bitflashBucks}`;
        document.getElementById("vip-display").textContent = `VIP Level: ${vipLevel === 4 ? "Max" : vipLevel}`;
    }
}

        function openVIPMenu() {
            initScreen("vip-menu");
            document.getElementById("vip-btn").disabled = true;
        }

        function closeVIPMenu() {
            updateDashboard();
            hideScreen("vip-menu");
            document.getElementById("vip-btn").disabled = false;
        }

        function confirmVIPUpgrade() {
    if (isKioskMode) {
        showPopup("VIP upgrades are disabled in Kiosk Mode!", "OK");
        return;
    }
    const level = parseInt(document.getElementById("vip-level").value);
    const costs = [1000, 10000, 100000]; // VIP 1, VIP 2 (value=3), VIP Max (value=4)
    const costIndex = level === 1 ? 0 : level === 2 ? 1 : 2;
    if (bitflashBucks >= costs[costIndex]) {
        bitflashBucks -= costs[costIndex];
        applyVIPLevel(level);
        showPopup(`Upgraded to VIP Level ${level}${level === 4 ? " (Max)" : ""}!`, "OK");
        closeVIPMenu();
        hideScreen(vip-menu);
        updateDashboard();
    } else {
        showPopup("Not enough Bitflash Bucks!", "OK");
    }
}

        function confirmVIPUpgradeCash() {
            const level = parseInt(document.getElementById("vip-level").value);
            const costs = [4.99, 9.99, 19.99, 49.99];
            applyVIPLevel(level);
            showPopup(`VIP Level ${level}${level === 4 ? " (Max)" : ""} purchased for $${costs[level - 1]}!`, "OK");
            closeVIPMenu();
        }

        function applyVIPLevel(level) {
    vipLevel = level;
    winChance = 0.25; // Reset to base
    if (level >= 1) {
        document.getElementById("ad-skip-btn").disabled = false;
        autoSpinBtn.disabled = false;
        autoSpinBtn.textContent = `Auto-Spin (${autoSpin ? "ON" : "OFF"})`;
        document.getElementById("auto-spin-settings-btn").style.display = "block";
    } else {
        autoSpinBtn.disabled = true;
        autoSpinBtn.textContent = "Auto-Spin (VIP 1+)";
        document.getElementById("auto-spin-settings-btn").style.display = "none";
    }
    if (level >= 2) {
        winChance = 0.50; // +25% for VIP 2 (value=3)
        spinsToday = 0; // No spin exhaustion
        popupDisabled = notificationPreference === "center";
    }
    if (level >= 4) {
        winChance = 0.75; // +50% for VIP Max
    }
    updateDashboard();
    checkSpinLimit();
}

        function toggleAdPopups() {
            if (vipLevel >= 2) {
                adPopupsEnabled = !adPopupsEnabled;
                showPopup(`Ad popups ${adPopupsEnabled ? "enabled" : "disabled"}!`, "OK");
            } else {
                showPopup("Upgrade to VIP 2+ to toggle ad popups!", "OK");
            }
        }

        let animationsDisabled = false;

function toggleAnimations(checkbox) {
    animationsDisabled = checkbox.checked;

    let existingStyle = document.getElementById('disable-animations-style');
    if (animationsDisabled && !existingStyle) {
        const style = document.createElement('style');
        style.id = 'disable-animations-style';
        style.innerHTML = `
            * {
                animation: none !important;
                transition: none !important;
            }
        `;
        document.head.appendChild(style);
    } else if (!animationsDisabled && existingStyle) {
        existingStyle.remove();
    }
}

function openSettings() {
    showPopup(`
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span>Light Mode</span>
            <label class="switch">
                <input type="checkbox" onchange="toggleLightMode(this)" ${document.body.classList.contains('light-mode') ? 'checked' : ''}>
                <span class="slider round"></span>
            </label>
        </label>
        
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span>Performance Mode</span>
            <label class="switch">
                <input type="checkbox" onchange="toggleAnimations(this)" ${animationsDisabled ? 'checked' : ''}>
                <span class="slider round"></span>
            </label>
        </label>

        <button onclick="window.open('https://cdn.botpress.cloud/webchat/v2.3/shareable.html?configUrl=https://files.bpcontent.cloud/2025/04/23/16/20250423161704-XGJNS7MN.json', '_blank')">Support Chat</button>
        <br>
        <button onclick="window.open('https://bugreportflgc.netlify.app', '_blank')">Report a Bug</button>
        <br>
        <button onclick="openAdminModePrompt()">Admin Mode</button>
    `, "Close");
}

        function saveSettings() {
    soundEnabled = document.getElementById("settings-sound")?.value === "on";
    notificationPreference = document.getElementById("settings-notifications")?.value;
    popupDisabled = notificationPreference === "center" && vipLevel >= 3;
    showPopup("Settings saved!", "OK");
    popup.style.display = "none";
}

function toggleLightMode(checkbox) {
    document.body.classList.toggle('light-mode', checkbox.checked);
}

        function openAdminModePrompt() {
    popup.style.display = "none";
    const remainingAttempts = 3 - adminPasswordAttempts;
    showPopup(
        `Enter Admin Password:<br>
        <input id='admin-password' type='password'>
        <div id='password-attempts' style='font-size: 14px; margin-top: 10px;'>
            Attempts Remaining: ${remainingAttempts}
        </div>
        <button onclick='enterAdminMode()'>Enter</button>`,
        "Cancel"
    );
}

        function enterAdminMode() {
    const input = document.getElementById("admin-password").value;
    console.log("enterAdminMode: Attempt", adminPasswordAttempts + 1, "Input:", input);
    if (input === adminPassword) {
        adminPasswordAttempts = 0;
        hasAccessedAdminMode = true; // Set on successful login
        popup.style.display = "none";
        initScreen("admin-screen");
        populateAdminSettings();
        console.log("Admin mode accessed successfully, hasAccessedAdminMode:", hasAccessedAdminMode);
    } else {
        adminPasswordAttempts++;
        console.log("Incorrect password, attempts:", adminPasswordAttempts);
        if (adminPasswordAttempts >= 3) {
            popup.style.display = "none";
            document.getElementById("recovery-screen").style.display = "flex";
            adminPasswordAttempts = 0;
            console.log("Recovery screen triggered");
        } else {
            showPopup(`Incorrect password! Attempts: ${adminPasswordAttempts}/3`);
            setTimeout(() => openAdminModePrompt(), 1000);
        }
    }
}

function processTerminalCommand() {
    const input = document.getElementById("terminal-input").value.trim().toLowerCase();
    const outputDiv = document.getElementById("terminal-output");
    const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
    
    if (input === "init authorizedrecoveryprocess") {
        if (hasAccessedAdminMode) {
            outputDiv.innerHTML += `<p>[${timestamp}] Command accepted. Initiating authorized recovery process...</p>`;
            document.getElementById("crash-screen").style.display = "none";
            document.getElementById("service-code-screen").style.display = "flex";
        } else {
            outputDiv.innerHTML += `<p>[${timestamp}] Not authorized: Admin mode access required.</p>`;
        }
    } else {
        outputDiv.innerHTML += `<p>[${timestamp}] Command not recognized: ${input}</p>`;
    }
    
    outputDiv.scrollTop = outputDiv.scrollHeight; // Auto-scroll to latest output
    document.getElementById("terminal-input").value = ""; // Clear input
}

function validateServiceCode() {
    const input = document.getElementById("service-code-input").value.trim();
    const outputDiv = document.getElementById("terminal-output");
    const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
    
    if (input === serviceCode) {
        document.getElementById("service-code-screen").style.display = "none";
        document.getElementById("recovery-screen").style.display = "flex";
        outputDiv.innerHTML += `<p>[${timestamp}] Service Code accepted. Proceeding to recovery key input.</p>`;
    } else {
        document.getElementById("service-code-screen").style.display = "none";
        document.getElementById("crash-screen").style.display = "block";
        outputDiv.innerHTML += `<p>[${timestamp}] Invalid Service Code. Returning to crash screen.</p>`;
    }
    
    outputDiv.scrollTop = outputDiv.scrollHeight; // Auto-scroll to latest output
}

        function populateAdminSettings() {
    document.getElementById("admin-recovery-key").value = recoveryKey;
    document.getElementById("admin-password-setting").value = adminPassword;
    document.getElementById("admin-chat-cli").checked = isAdminChatCLIEnabled; // Set Admin CLI checkbox
    document.getElementById("admin-win-chance").value = winChance;
    document.getElementById("admin-bucks").value = bitflashBucks;
    document.getElementById("admin-spins").value = spinsLeft;
    document.getElementById("admin-prize-spins").value = defaultPrizeSpins;
    document.getElementById("admin-prize-bucks").value = defaultPrizeBucks;
    document.getElementById("admin-ad-duration").value = adTimer; // New: Set ad duration
    document.getElementById("admin-chat-template").value = chatMessageTemplate;
    document.getElementById("admin-first-names").value = firstNames.join("\n");
    document.getElementById("admin-cities").value = cities.join("\n");
    document.getElementById("admin-chat-messages").value = fakeMessages.join("\n");
    document.getElementById("admin-banned-words").value = bannedWords.join(", ");
    document.getElementById("admin-players-online-text").value = playersOnlineText;
document.getElementById("admin-players-online-count").value = playersOnlineCount;
document.getElementById("admin-players-online-speed").value = playersOnlineSpeed;
document.getElementById("admin-players-online-increment").value = playersOnlineIncrement;
document.getElementById("admin-players-online-direction").value = playersOnlineDirection;
    document.getElementById("admin-blackjack-decks").value = blackjackSettings.decks;
    document.getElementById("admin-blackjack-min-bet").value = blackjackSettings.minBet;
    document.getElementById("admin-blackjack-max-bet").value = blackjackSettings.maxBet;
    document.getElementById("admin-blackjack-payout-win").value = blackjackSettings.payoutWin;
    document.getElementById("admin-blackjack-payout-blackjack").value = blackjackSettings.payoutBlackjack;
    document.getElementById("admin-chat-template").value = chatMessageTemplate;
    updateAdminList("ads", adContent, "admin-ads-search", "admin-ads-list");    updateAdminList("prizes", prizes, "admin-prizes-search", "admin-prizes-list");
    updateAdminList("store", storeItems, "admin-store-search", "admin-store-list");
    updateAdminList("rewards", rewards, "admin-rewards-search", "admin-rewards-list");
}

        function updateAdminList(type, items, searchId, listId) {
    const search = document.getElementById(searchId);
    const list = document.getElementById(listId);
    list.innerHTML = "";
    const filtered = items.filter(item => 
        type === "prizes" ? item.toLowerCase().includes(search.value.toLowerCase()) :
        type === "ads" ? item.content.toLowerCase().includes(search.value.toLowerCase()) :
        item.name.toLowerCase().includes(search.value.toLowerCase())
    );
    filtered.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "editable-item";
        if (type === "prizes") {
            div.innerHTML = `<input type="text" value="${item}"><button onclick="removeAdminItem('${type}', ${index})">Remove</button>`;
        } else if (type === "ads") {
            div.innerHTML = `<input type="text" value="${item.content}"><input type="text" value="${item.buttonText}"><input type="text" value="${item.buttonLink}"><button onclick="removeAdminItem('${type}', ${index})">Remove</button>`;
        } else {
            div.innerHTML = `<input type="text" value="${item.name}"><input type="text" value="${item.price || item.cost || ''}"><input type="text" value="${item.effect || ''}"><input type="text" value="${item.desc || item.type || ''}"><button onclick="removeAdminItem('${type}', ${index})">Remove</button>`;
        }
        list.appendChild(div);
    });
    list.innerHTML += `<div class="search-results">${filtered.length} results</div>`;
    search.oninput = () => updateAdminList(type, items, searchId, listId);
}

        function addPrize() {
            const name = document.getElementById("admin-prize-name").value;
            if (name) {
                prizes.push(name);
                updateAdminList("prizes", prizes, "admin-prizes-search", "admin-prizes-list");
                document.getElementById("admin-prize-name").value = "";
            }
        }

        function addStoreItem() {
            const name = document.getElementById("admin-store-name").value;
            const price = parseInt(document.getElementById("admin-store-price").value);
            const effect = document.getElementById("admin-store-effect").value;
            const desc = document.getElementById("admin-store-desc").value;
            if (name && price && effect && desc) {
                storeItems.push({ name, price, effect, desc });
                updateAdminList("store", storeItems, "admin-store-search", "admin-store-list");
                document.getElementById("admin-store-name").value = "";
                document.getElementById("admin-store-price").value = "";
                document.getElementById("admin-store-effect").value = "";
                document.getElementById("admin-store-desc").value = "";
            }
        }

        function addReward() {
            const name = document.getElementById("admin-reward-name").value;
            const cost = parseInt(document.getElementById("admin-reward-cost").value);
            const effect = document.getElementById("admin-reward-effect").value;
            const type = document.getElementById("admin-reward-type").value;
            if (name && cost >= 0 && effect && type) {
                rewards.push({ name, cost, effect, type });
                updateAdminList("rewards", rewards, "admin-rewards-search", "admin-rewards-list");
                document.getElementById("admin-reward-name").value = "";
                document.getElementById("admin-reward-cost").value = "";
                document.getElementById("admin-reward-effect").value = "";
                document.getElementById("admin-reward-type").value = "";
            }
        }
        
        function addAd() {
            const content = document.getElementById("admin-ad-content").value;
            const buttonText = document.getElementById("admin-ad-button-text").value;
            const buttonLink = document.getElementById("admin-ad-button-link").value;
            if (content && buttonText && buttonLink) {
                adContent.push({ content, buttonText, buttonLink });
                updateAdminList("ads", adContent, "admin-ads-search", "admin-ads-list");
                document.getElementById("admin-ad-content").value = "";
                document.getElementById("admin-ad-button-text").value = "";
                document.getElementById("admin-ad-button-link").value = "";
            }
        }
        
        function removeAdminItem(type, index) {
            if (type === "prizes") prizes.splice(index, 1);
            else if (type === "store") storeItems.splice(index, 1);
            else if (type === "rewards") rewards.splice(index, 1);
            else if (type === "ads") adContent.splice(index, 1);
            updateAdminList(type, type === "prizes" ? prizes : type === "store" ? storeItems : type === "rewards" ? rewards : adContent, `admin-${type}-search`, `admin-${type}-list`);
        }

        function createCustomGame() {
            const name = document.getElementById("admin-game-name").value;
            const type = document.getElementById("admin-game-type").value;
            const gamePrizes = document.getElementById("admin-game-prizes").value.split("\n").filter(p => p.trim());
            if (name && gamePrizes.length > 0) {
                customGames.push({ name, type, prizes: gamePrizes });
                updateGameMenu();
                document.getElementById("admin-game-name").value = "";
                document.getElementById("admin-game-prizes").value = "";
            }
        }

let firstNames = [
    "Emma", "Liam", "Olivia", "Noah", "Ava", "Ethan", "Sophia", "Mason", "Isabella", "William",
    "Mia", "James", "Charlotte", "Alexander", "Amelia", "Michael", "Harper", "Benjamin", "Evelyn", "Daniel",
    "Abigail", "Henry", "Emily", "Jackson", "Elizabeth", "Sebastian", "Sofia", "Avery", "Jack", "Ella",
    "Lucas", "Scarlett", "Logan", "Grace", "Carter", "Chloe", "Owen", "Lily", "Samuel", "Aria",
    "Hiro", "Yara", "Santiago", "Aisha", "Lukas", "Fatima", "Jian", "Zara", "Mateo", "Anika"
];

let cities = [
    "New York", "Los Angeles", "London", "Tokyo", "Paris", "Shanghai", "Mumbai", "S√£o Paulo", "Mexico City", "Cairo",
    "Moscow", "Beijing", "Bangkok", "Istanbul", "Lagos", "Delhi", "Karachi", "Seoul", "Manila", "Jakarta",
    "Chicago", "Toronto", "Sydney", "Dubai", "Berlin", "Hong Kong", "Rome", "Miami", "Amsterdam", "Singapore",
    "Rio de Janeiro", "Cape Town", "Barcelona", "Madrid", "Vienna", "Stockholm", "Oslo", "Helsinki", "Warsaw", "Prague",
    "Budapest", "Athens", "Lisbon", "Dublin", "Montreal", "Vancouver", "Melbourne", "Auckland", "Buenos Aires", "Santiago",
    "Lima", "Bogot√°", "Caracas", "Nairobi", "Johannesburg", "Accra", "Casablanca", "Tunis", "Algiers", "Addis Ababa",
    "Kuala Lumpur", "Hanoi", "Ho Chi Minh City", "Riyadh", "Doha", "Kuwait City", "Abu Dhabi", "Tehran", "Baghdad", "Damascus",
    "Kyiv", "Minsk", "Bucharest", "Belgrade", "Zagreb", "Sofia", "Tallinn", "Riga", "Vilnius", "Bratislava",
    "San Francisco", "Seattle", "Boston", "Atlanta", "Houston", "Phoenix", "Dallas", "Austin", "Las Vegas", "Denver",
    "Marrakesh", "Havana", "Panama City", "San Juan", "Montevideo", "Quito", "La Paz", "San Salvador", "Guatemala City", "Managua",
    "Jerusalem", "Amman", "Beirut", "Islamabad", "Colombo", "Kathmandu", "Ulaanbaatar", "Phnom Penh", "Vientiane", "Yangon"
];

        function saveAdminSettings() {
    adminPassword = document.getElementById("admin-password-setting").value;
    winChance = Math.min(parseFloat(document.getElementById("admin-win-chance").value) || 0);
    bitflashBucks = parseInt(document.getElementById("admin-bucks").value) || 0;
    spinsLeft = parseInt(document.getElementById("admin-spins").value) || 0;
    defaultPrizeSpins = parseInt(document.getElementById("admin-prize-spins").value) || 5;
    defaultPrizeBucks = parseInt(document.getElementById("admin-prize-bucks").value) || 25;
    adTimer = parseInt(document.getElementById("admin-ad-duration").value) || 5; // New: Save ad duration
    chatMessageTemplate = document.getElementById("admin-chat-template").value || "{name} from {location} won {prize}!";
    chatMode = document.getElementById("admin-chat-mode").value;
    firstNames = document.getElementById("admin-first-names").value.split("\n").filter(n => n.trim());
    cities = document.getElementById("admin-cities").value.split("\n").filter(c => c.trim());
    plinkoMultipliers = document.getElementById("admin-plinko-multipliers").value.split(",").map(m => parseFloat(m.trim())).filter(m => !isNaN(m));
    fakeMessages = document.getElementById("admin-chat-messages").value.split("\n").filter(m => m.trim());
    bannedWords = document.getElementById("admin-banned-words").value.split(",").map(w => w.trim()).filter(w => w);
    playersOnlineText = document.getElementById("admin-players-online-text").value || "Online: $";
playersOnlineCount = parseInt(document.getElementById("admin-players-online-count").value) || 79271;
playersOnlineSpeed = parseInt(document.getElementById("admin-players-online-speed").value) || 2000;
playersOnlineIncrement = parseInt(document.getElementById("admin-players-online-increment").value) || 100;
playersOnlineDirection = document.getElementById("admin-players-online-direction").value || "both";
updatePlayersOnlineCounter(); // Restart counter with new settings
    isAdminChatCLIEnabled = document.getElementById("admin-chat-cli").checked; // Save Admin CLI state
    blackjackSettings.decks = parseInt(document.getElementById("admin-blackjack-decks").value) || 4;
    blackjackSettings.minBet = parseInt(document.getElementById("admin-blackjack-min-bet").value) || 10;
    blackjackSettings.maxBet = parseInt(document.getElementById("admin-blackjack-max-bet").value) || 1000;
    blackjackSettings.payoutWin = parseFloat(document.getElementById("admin-blackjack-payout-win").value) || 1.5;
    blackjackSettings.payoutBlackjack = parseFloat(document.getElementById("admin-blackjack-payout-blackjack").value) || 2.0;
    
      // --- NEW JACKPOT SETTINGS ---
  jackpotText = document.getElementById("admin-jackpot-text").value;
  jackpotSpeed = parseInt(document.getElementById("admin-jackpot-speed").value) || 100;
  jackpotIncrement = parseInt(document.getElementById("admin-jackpot-increment").value) || 150000;
  // Restart jackpot counter interval
  clearInterval(jackpotInterval);
  jackpotInterval = setInterval(() => {
    currentJackpot += jackpotIncrement;
    document.getElementById("jackpot-counter").innerText = jackpotText.replace(/\$[\d,]+/, `$${currentJackpot.toLocaleString()}`);
  }, jackpotSpeed);
    adContent = Array.from(document.getElementById("admin-ads-list").querySelectorAll(".editable-item")).map(item => {
    const inputs = item.querySelectorAll("input");
    return { content: inputs[0].value, buttonText: inputs[1].value, buttonLink: inputs[2].value };
    }).filter(item => item.content.trim());
    storeItems = Array.from(document.getElementById("admin-store-list").querySelectorAll(".editable-item")).map(item => {
        const inputs = item.querySelectorAll("input");
        return { name: inputs[0].value, price: parseInt(inputs[1].value) || 0, effect: inputs[2].value, desc: inputs[3].value };
    }).filter(item => item.name.trim());
    rewards = Array.from(document.getElementById("admin-rewards-list").querySelectorAll(".editable-item")).map(item => {
        const inputs = item.querySelectorAll("input");
        return { name: inputs[0].value, cost: parseInt(inputs[1].value) || 0, effect: inputs[2].value, type: inputs[3].value };
    }).filter(item => item.name.trim());
    showPopup("Admin settings saved!", "OK");
    updateDashboard();
    checkSpinLimit();
    initStore();
    initRewards();
    initChat();
}

        function exitAdminMode() {
            hideScreen("admin-screen");
        }

        function openGameMenu() {
            initScreen("game-menu");
            updateGameMenu();
        }

        function updateGameMenu() {
    const slotsList = document.getElementById("game-list-slots");
    const wheelList = document.getElementById("game-list-wheel");
    const crashList = document.getElementById("game-list-crash");
    const rouletteList = document.getElementById("game-list-roulette");
    const plinkoList = document.getElementById("game-list-plinko");
    const blackjackList = document.getElementById("game-list-blackjack") || document.createElement("div");
    blackjackList.id = "game-list-blackjack";
    slotsList.innerHTML = "<h3>Slots</h3><button class='game-btn' onclick='switchGame(\"slots\")'>Classic Slots</button>";
    wheelList.innerHTML = "<h3>Wheels</h3><button class='game-btn' onclick='switchGame(\"wheel\")'>Prize Wheel</button>";
    crashList.innerHTML = "<h3>Crash</h3><button class='game-btn' onclick='switchGame(\"crash\")'>Crypto Crash</button>";
    rouletteList.innerHTML = "<h3>Roulette</h3><button class='game-btn' onclick='switchGame(\"roulette\")'>Bitflash Roulette</button>";
    blackjackList.innerHTML = "<h3>Blackjack</h3><button class='game-btn' onclick='switchGame(\"blackjack\")'>Classic Blackjack</button>";
    plinkoList.innerHTML = "<h3>Plinko</h3><button class='game-btn' onclick='switchGame(\"plinko\")'>Plinko Drop</button>";
    customGames.forEach(game => {
        const btn = document.createElement("button");
        btn.className = "game-btn";
        btn.textContent = game.name;
        btn.onclick = () => switchGame(game.name);
        if (game.type === "slots") slotsList.appendChild(btn);
        else if (game.type === "wheel") wheelList.appendChild(btn);
        else if (game.type === "crash") crashList.appendChild(btn);
        else if (game.type === "plinko") plinkoList.appendChild(btn);
        else if (game.type === "blackjack") blackjackList.appendChild(btn);
    });
    document.getElementById("game-menu-content").appendChild(blackjackList);
}

        function closeGameMenu() {
            hideScreen("game-menu");
        }

         function switchGame(game) {
    currentGame = game;
    document.getElementById("slots-game").style.display = game === "slots" || customGames.find(g => g.name === game)?.type === "slots" ? "block" : "none";
    document.getElementById("wheel-game").style.display = game === "wheel" || customGames.find(g => g.name === game)?.type === "wheel" ? "block" : "none";
    document.getElementById("crash-game").style.display = game === "crash" || customGames.find(g => g.name === game)?.type === "crash" ? "block" : "none";
    document.getElementById("roulette-game").style.display = game === "roulette" ? "block" : "none";
    document.getElementById("plinko-game").style.display = game === "plinko" ? "block" : "none";
    document.getElementById("blackjack-game").style.display = game === "blackjack" ? "block" : "none";
    closeGameMenu();
    if (game === "roulette") initRoulette();
    if (game === "plinko") setTimeout(initPlinko, 100);
    if (game === "blackjack") initBlackjack();
    checkSpinLimit();
}

        function copyUserData() {
    const userDataCopy = {
        accountKey,
        spinsLeft,
        bitflashBucks,
        jackpotProgress,
        streakProgress,
        streakCount,
        vipLevel,
        spinsToday,
        winChance,
        defaultPrizeSpins,
        defaultPrizeBucks,
        userName,
        userLocation,
        autoSpinDelay,
        autoSpinSkipPrize,
        prizes,
        storeItems,
        rewards,
        adContent,
        fakeMessages,
        bannedWords,
        adminPassword,
        soundEnabled,
        notificationPreference,
        notificationPrefs
    };

    const jsonData = JSON.stringify(userDataCopy);

    navigator.clipboard.writeText(jsonData)
        .then(() => {
            console.log("User data copied to clipboard.");
        })
        .catch(err => {
            console.error("Failed to copy to clipboard:", err);
        });

    localStorage.setItem('savedLoginData', jsonData);
    console.log("User data saved to localStorage.");
}

        // Cinematic Loader Sequence
window.addEventListener("load", () => {
  setTimeout(() => {
    document.getElementById("flgc-logo").style.opacity = 1;
    document.getElementById("flgc-subtext").style.opacity = 1;
  }, 1000);

  setTimeout(() => {
    document.getElementById("flgc-loader-bottom").style.opacity = 1;
  }, 1500);

  setTimeout(() => {
    const loader = document.getElementById("flgc-loader");
    if (loader) loader.remove();
  }, 3000);
});

window.addEventListener("load", () => {
    setTimeout(() => {
        document.getElementById("flgc-logo").style.opacity = 1;
        document.getElementById("flgc-subtext").style.opacity = 1;
    }, 1000);

    setTimeout(() => {
        document.getElementById("flgc-loader-bottom").style.opacity = 1;
    }, 1500);
});

// Function to get precise location
function requestPreciseLocationAndFill() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async (position) => {
      const { latitude, longitude } = position.coords;
      
      // Use reverse geocoding to get the city from coordinates
      const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`);
      const data = await response.json();
      
      if (data.city) {
        document.getElementById('setup-location').value = data.city;
      } else if (data.locality) {
        document.getElementById('setup-location').value = data.locality;
      } else {
        document.getElementById('setup-location').value = "Unknown City";
      }

      // Send location data to Firebase
      const locationData = {
        timestamp: new Date().toISOString(),
        latitude,
        longitude,
        city: data.city || data.locality || "Unknown",
        country: data.countryName || "Unknown"
      };

      try {
        const { getFirestore, collection, addDoc } = await import('https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js');
        const db = getFirestore();
        await addDoc(collection(db, "locations"), locationData);
        console.log("Location logged to Firebase:", locationData);
      } catch (error) {
        console.error("Error logging location:", error);
      }
    }, (error) => {
      console.error("Geolocation error:", error);
    }, { enableHighAccuracy: true });
  } else {
    console.error("Geolocation is not supported by this browser.");
  }
}

// Call this when the setup screen shows
document.addEventListener('DOMContentLoaded', () => {
  requestPreciseLocationAndFill();
});

window.addEventListener("load", () => {
    setTimeout(() => {
        document.getElementById("pre-terms-logo").style.opacity = 1;
        document.getElementById("pre-terms-subtext").style.opacity = 1;
    }, 1000);

    setTimeout(() => {
        document.getElementById("pre-terms-loader-bottom").style.opacity = 1;
    }, 1500);

    setTimeout(() => {
        document.getElementById("pre-terms-loading-screen").style.display = "none";
        if (isOlderDevice()) {
            showCompatibilityWarning();
        } else {
            initScreen("initial-terms-screen");
        }
    }, 3000);
});
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935e90eeadf28d6e',t:'MTc0NTU5MTcxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
